\documentclass[12pt]{amsart}
\usepackage{fullpage,url,amssymb,enumerate,colonequals, numprint}

\usepackage{mathrsfs} % for \mathscr (script letters)
\usepackage{lscape}
\usepackage[all,cmtip]{xy}

\usepackage{color}

\usepackage[
%       draft,
        colorlinks, citecolor=darkgreen,
        backref,
        pdfauthor={Nuno Freitas}, % add other authors
]{hyperref}
\usepackage{comment}

% label and link to an elliptic curve /Q:
% version using Cremona labels:
\newcommand{\lmfdbec}[3]{\href{http://www.lmfdb.org/EllipticCurve/Q/#1#2#3}{{\text{\rm#1#2#3}}}}
% version using LMFDB labels:
%\newcommand{\lmfdbec}[3]{\href{http://www.lmfdb.org/EllipticCurve/Q/#1/#2/#3}{{\text{\rm#1.#2#3}}}}
% label and link to an elliptic curve isogeny class /Q:
\newcommand{\lmfdbeciso}[2]{\href{http://www.lmfdb.org/EllipticCurve/Q/#1/#2}{\text{\rm#1#2}}}


\newcommand{\dashedarrow}{\dashrightarrow}

% Characters
\newcommand{\Aff}{\mathbb{A}}
\newcommand{\C}{\mathbb{C}}
\newcommand{\F}{\mathbb{F}}
\newcommand{\Fbar}{{\overline{\F}}}
\newcommand{\G}{\mathbb{G}}
\newcommand{\Gm}{\mathbb{G}_{\mathrm{m}}}
\newcommand{\bbH}{\mathbb{H}}
\newcommand{\PP}{\mathbb{P}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\Qbar}{{\overline{\Q}}}
\newcommand{\Zhat}{{\hat{\Z}}}
\newcommand{\Ebar}{{\overline{E}}}
\newcommand{\Zbar}{{\overline{\Z}}}
\newcommand{\kbar}{{\overline{k}}}
\newcommand{\Kbar}{{\overline{K}}}
\newcommand{\rhobar}{{\overline{\rho}}}
\newcommand{\ksep}{{k^{\operatorname{sep}}}}

\newcommand{\frp}{{\mathfrak p}}
\newcommand{\frq}{{\mathfrak q}}

\newcommand{\Adeles}{\mathbf{A}}
\newcommand{\kk}{\mathbf{k}}

\newcommand{\mm}{\mathfrak{m}}

\newcommand{\eps}{\varepsilon}

\newcommand{\uom}{\underline{\omega}}

% bold characters
\newcommand{\boldf}{\mathbf{f}}
\newcommand{\boldl}{\ensuremath{\boldsymbol\ell}}
\newcommand{\boldL}{\mathbf{L}}
\newcommand{\boldr}{\mathbf{r}}
\newcommand{\boldw}{\mathbf{w}}
\newcommand{\boldzero}{\mathbf{0}}
\newcommand{\boldomega}{\ensuremath{\boldsymbol\omega}}


% mathcal characters
\newcommand{\calA}{\mathcal{A}}
\newcommand{\calB}{\mathcal{B}}
\newcommand{\calC}{\mathcal{C}}
\newcommand{\calD}{\mathcal{D}}
\newcommand{\calE}{\mathcal{E}}
\newcommand{\calF}{\mathcal{F}}
\newcommand{\calG}{\mathcal{G}}
\newcommand{\calH}{\mathcal{H}}
\newcommand{\calI}{\mathcal{I}}
\newcommand{\calJ}{\mathcal{J}}
\newcommand{\calK}{\mathcal{K}}
\newcommand{\calL}{\mathcal{L}}
\newcommand{\calM}{\mathcal{M}}
\newcommand{\calN}{\mathcal{N}}
\newcommand{\calO}{\mathcal{O}}
\newcommand{\calP}{\mathcal{P}}
\newcommand{\calQ}{\mathcal{Q}}
\newcommand{\calR}{\mathcal{R}}
\newcommand{\calS}{\mathcal{S}}
\newcommand{\calT}{\mathcal{T}}
\newcommand{\calU}{\mathcal{U}}
\newcommand{\calV}{\mathcal{V}}
\newcommand{\calW}{\mathcal{W}}
\newcommand{\calX}{\mathcal{X}}
\newcommand{\calY}{\mathcal{Y}}
\newcommand{\calZ}{\mathcal{Z}}

%mathfrak characters

\newcommand{\ff}{\mathfrak{f}}
\newcommand{\fm}{\mathfrak{m}}
\newcommand{\fM}{\mathfrak{M}}
\newcommand{\fp}{\mathfrak{p}}
\newcommand{\fP}{\mathfrak{P}}
\newcommand{\fq}{\mathfrak{q}}
\newcommand{\fN}{\mathfrak{N}}

\newcommand{\CC}{\mathscr{C}}
\newcommand{\FF}{\mathscr{F}}
\newcommand{\GG}{\mathscr{G}}
\newcommand{\II}{\mathscr{I}}
\newcommand{\JJ}{\mathscr{J}}
\newcommand{\LL}{\mathscr{L}}
\newcommand{\NN}{\mathscr{N}}
\newcommand{\OO}{\mathscr{O}}
\newcommand{\WW}{\mathscr{W}}
\newcommand{\XX}{\mathscr{X}}
\newcommand{\ZZ}{\mathscr{Z}}

% Math operators
\DeclareMathOperator{\Ann}{Ann}
\DeclareMathOperator{\Aut}{Aut}
\DeclareMathOperator{\Br}{Br}
\DeclareMathOperator{\cd}{cd}
\DeclareMathOperator{\Card}{Card}
\DeclareMathOperator{\Char}{char}
\DeclareMathOperator{\Cl}{Cl}
\DeclareMathOperator{\codim}{codim}
\DeclareMathOperator{\coker}{coker}
\DeclareMathOperator{\Cor}{Cor}
\DeclareMathOperator{\divv}{div}
\DeclareMathOperator{\Div}{Div}
\DeclareMathOperator{\Det}{Det}
\DeclareMathOperator{\Dic}{Dic}

\DeclareMathOperator{\End}{End}
\newcommand{\END}{{\EE}\!nd}
\DeclareMathOperator{\Eq}{Eq}
\DeclareMathOperator{\Ext}{Ext}
\newcommand{\EXT}{{\E}\!xt}
\DeclareMathOperator{\Fix}{\tt Fix}
\DeclareMathOperator{\Frac}{Frac}
\DeclareMathOperator{\Frob}{Frob}
\DeclareMathOperator{\Gal}{Gal}
\DeclareMathOperator{\Gr}{Gr}
\DeclareMathOperator{\Hom}{Hom}
\newcommand{\HOM}{{\HH}\!om}
\DeclareMathOperator{\im}{im}
\DeclareMathOperator{\Ind}{Ind}
\DeclareMathOperator{\inv}{inv}
\DeclareMathOperator{\Jac}{Jac}
\DeclareMathOperator{\JL}{JL}
\DeclareMathOperator{\lcm}{lcm}
\DeclareMathOperator{\Lie}{Lie}
\DeclareMathOperator{\Log}{Log}
\DeclareMathOperator{\MakeDecentModel}{\tt MakeDecentModel}
\DeclareMathOperator{\nil}{nil}
\DeclareMathOperator{\Norm}{Norm}
\DeclareMathOperator{\NP}{NP}
\DeclareMathOperator{\Num}{Num}
\DeclareMathOperator{\odd}{odd}
\DeclareMathOperator{\ord}{ord}
\DeclareMathOperator{\Pic}{Pic}
\DeclareMathOperator{\PIC}{\bf Pic}
\DeclareMathOperator{\Prob}{\bf P}
\DeclareMathOperator{\Proj}{Proj}
\DeclareMathOperator{\PROJ}{\bf Proj}
\DeclareMathOperator{\rank}{rank}
\DeclareMathOperator{\rec}{rec}
\DeclareMathOperator{\re}{Re}
\DeclareMathOperator{\reg}{reg}
\DeclareMathOperator{\res}{res}
\DeclareMathOperator{\Res}{Res}
\DeclareMathOperator{\rk}{rk}
\DeclareMathOperator{\scd}{scd}
\DeclareMathOperator{\Sel}{Sel}
\DeclareMathOperator{\Sp}{Sp}
\DeclareMathOperator{\Spec}{Spec}
\DeclareMathOperator{\SPEC}{\bf Spec}
\DeclareMathOperator{\Spf}{Spf}
\DeclareMathOperator{\sss}{ss}
\DeclareMathOperator{\supp}{supp}
\DeclareMathOperator{\Sym}{Sym}
\DeclareMathOperator{\tr}{tr}
\DeclareMathOperator{\T}{\mathbb{T}}
\DeclareMathOperator{\Tr}{Tr}
\DeclareMathOperator{\tw}{tw}
\DeclareMathOperator{\trdeg}{tr deg}
\DeclareMathOperator{\WD}{WD}

% Categories
\newcommand{\Ab}{\operatorname{\bf Ab}}
\newcommand{\Groups}{\operatorname{\bf Groups}}
\newcommand{\Schemes}{\operatorname{\bf Schemes}}
\newcommand{\Sets}{\operatorname{\bf Sets}}

% Text subscripts, superscripts
\newcommand{\ab}{{\operatorname{ab}}}
\newcommand{\an}{{\operatorname{an}}}
\newcommand{\Az}{{\operatorname{Az}}}
\newcommand{\CS}{\operatorname{\bf CS}}
\newcommand{\et}{{\operatorname{et}}}
\newcommand{\ET}{{\operatorname{\bf \acute{E}t}}}
\newcommand{\fl}{{\operatorname{f\textcompwordmark l}}}
\newcommand{\good}{{\operatorname{good}}}
\newcommand{\op}{{\operatorname{op}}}
\newcommand{\perf}{{\operatorname{perf}}}
\newcommand{\red}{{\operatorname{red}}}
\newcommand{\regular}{{\operatorname{regular}}}
\newcommand{\sing}{{\operatorname{sing}}}
\newcommand{\smooth}{{\operatorname{smooth}}}
\newcommand{\tH}{{\operatorname{th}}}
\newcommand{\tors}{{\operatorname{tors}}}
\newcommand{\nontors}{{\operatorname{non-tors}}}
\newcommand{\unr}{{\operatorname{unr}}}
\newcommand{\Zar}{{\operatorname{Zar}}}
\newcommand{\ns}{{\operatorname{ns}}}
\renewcommand{\sp}{{\operatorname{sp}}}
\newcommand{\vv}{\upsilon}
\newcommand{\Cech}{\v{C}ech}
\newcommand{\E}{{\operatorname{\bf E}}}
\newcommand{\GalQ}{{\Gal}(\Qbar/\Q)}
\newcommand{\GL}{\operatorname{GL}}
\newcommand{\HH}{{\operatorname{H}}}
\newcommand{\HHcech}{{\check{\HH}}}
\newcommand{\HHat}{{\hat{\HH}}}
\newcommand{\M}{\operatorname{M}}
\newcommand{\PGL}{\operatorname{PGL}}
\newcommand{\PSL}{\operatorname{PSL}}
\newcommand{\SL}{\operatorname{SL}}

\newcommand{\del}{\partial}
\newcommand{\directsum}{\oplus} % binary direct sum
\newcommand{\Directsum}{\bigoplus} % direct sum of a collection
\newcommand{\injects}{\hookrightarrow}
\newcommand{\intersect}{\cap} % binary intersection
\newcommand{\Intersection}{\bigcap} % intersection of a collection
\newcommand{\isom}{\simeq}
\newcommand{\notdiv}{\nmid}
\newcommand{\surjects}{\twoheadrightarrow}
\newcommand{\tensor}{\otimes} % binary tensor product
\newcommand{\Tensor}{\bigotimes} % tensor product of a collection
\newcommand{\union}{\cup} % binary union
\newcommand{\Union}{\bigcup} % union of a collection

\newcommand{\Algorithm}{\textbf{Algorithm}\ }
\newcommand{\Subroutine}{\textbf{Subroutine}\ }

\newcommand{\isomto}{\overset{\sim}{\rightarrow}}
\newcommand{\isomfrom}{\overset{\sim}{\leftarrow}}
\newcommand{\leftexp}[2]{{\vphantom{#2}}^{#1}{#2}}
\newcommand{\rholog}{\rho \log}
\newcommand{\sigmaiota}{{\leftexp{\sigma}{\iota}}}
\newcommand{\sigmaphi}{{\leftexp{\sigma}{\phi}}}
\newcommand{\sigmatauphi}{{\leftexp{\sigma\tau}{\phi}}}
\newcommand{\tauphi}{{\leftexp{\tau}{\phi}}}
\newcommand{\To}{\longrightarrow}
\newcommand{\floor}[1]{\left\lfloor #1 \right\rfloor}

% imported from JC's file
\DeclareMathOperator{\id}{id}
\def\w{\omega}
\def\r3{\sqrt{-3}}
\def\pibar{\overline{\pi}}
\def\legendre#1#2{\left(\displaystyle\frac{#1}{#2}\right)}


\numberwithin{equation}{section}

%\newtheorem{theorem}{Theorem}
%\newtheorem{lemma}{Lemma}
%\newtheorem{corollary}{Corollary}
%\newtheorem{proposition}{Proposition}

%\theoremstyle{definition}
%\newtheorem{definition}[equation]{Definition}
%\newtheorem{question}[equation]{Question}
%\newtheorem{conjecture}[equation]{Conjecture}
%\newtheorem{example}[equation]{Example}
%\newtheorem{examples}[equation]{Examples}

%\theoremstyle{remark}
%\newtheorem{remark}[equation]{Remark}
%\newtheorem{remarks}[equation]{Remarks}


\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{proposition}[theorem]{Proposition}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{question}[theorem]{Question}
\newtheorem{conjecture}[theorem]{Conjecture}
\newtheorem{example}[theorem]{Example}
\newtheorem{examples}[theorem]{Examples}

\theoremstyle{remark}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{remarks}[theorem]{Remarks}

\newcommand{\Sage}{{\sc SageMath}}
\newcommand{\Magma}{{\sc Magma}}

\setlength{\parindent}{0mm}
\setlength{\parskip}{1ex plus 0.5ex}
\definecolor{darkgreen}{rgb}{0,0.5,0}

\begin{document}

\title{On the symplectic type of congruences between elliptic curves} % modulo small primes}

\author{John Cremona}
\address{Mathematics Institute,
         University of Warwick,
         Coventry CV4 7AL,
         United Kingdom}
\email{j.e.cremona@warwick.ac.uk}

\author{Nuno Freitas}
\address{Mathematics Institute,
         University of Warwick,
         Coventry CV4 7AL,
         United Kingdom}
\email{nunobfreitas@gmail.com}


\date{\today}

\keywords{Elliptic curves, Weil pairing, Galois representations, symplectic isomorphisms}
%\subjclass[2010]{Primary 11D41; Secondary 11G10, 11F80.}

\thanks{JEC is supported by EPSRC Programme Grant EP/K034383/1
  \textit{LMF: L-Functions and Modular Forms}, and the Horizon 2020
  European Research Infrastructures project \textit{OpenDreamKit}
  (\#676541)}
\thanks{NF is supported by the European Union's
  Horizon 2020 research and innovation programme under the Marie
  Sk\l{l}odowska-Curie grant agreement No.\ 747808}


\begin{abstract}
%% We describe a procedure to determine the symplectic type of
%% isomorphisms between the $7$- or $11$-torsion modules of elliptic
%% curves over~$\Q$.  We apply it to classify all the congruences in
%% LMFDB.
We describe a systematic investigation into the existence of
congruences between the mod~$p$ torsion modules of elliptic curves
defined over $\Q$, including methods to determine the symplectic type
of such congruences.  We report on the results of applying our methods
to the elliptic curves in the LMFDB database, which currently includes
all elliptic curves of conductor less than~$\numprint{400000}$, for
all primes~$p\ge7$.  We also show that while such congruences exist
for each $p\le17$, there are none for larger values of~$p$, in line
with a strong form of the Frey-Mazur conjecture.
\end{abstract}

\maketitle


\section{Introduction}

Let $p \geq 3$ be a prime. Write $G_\Q = \Gal(\Qbar/\Q)$ for the
absolute Galois group of $\Q$.  Let $E$ and $E'$ be elliptic curves defined over $\Q$, and write $E[p]$ and $E'[p]$ for their $p$-torsion $G_\Q$-modules.

Let $\phi : E[p] \to E'[p]$ be an isomorphism of $G_\Q$-modules.
There is an element $d(\phi) \in \F_p^\times$ such that the Weil 
pairings~$e_{E,p}$ and~$e_{E',p}$ satisfy
\[
e_{E',p}(\phi(P), \phi(Q)) = e_{E,p}(P, Q)^{d(\phi)}
\]
for all $P, Q \in E[p]$.  We say that $\phi$ is a {\em symplectic
  isomorphism} or an {\em anti-symplectic isomorphism} if $d(\phi)$ is
a square or a non-square modulo~$p$, respectively.  When two elliptic
curves have isomorphic $p$-torsion modules we say that there is a
mod~$p$ {\em congruence} between them, or that they are {\em
  congruent} mod~$p$.

For example, suppose that~$\phi$ is induced by an isogeny (also
denoted~$\phi$) from $E$ to $E'$, of degree $\deg(\phi)$ coprime
to~$p$. Then, using Weil reciprocity, 
we have 
\[
  e_{E',p}(\phi(P), \phi(Q)) = e_{E,p}(P, \hat\phi\phi(Q)) =
  e_{E,p}(P, \deg(\phi)(Q)) = e_{E,p}(P, Q)^{\deg(\phi)},
  \]
  where $\hat{\phi}$ denotes the dual isogeny; 
  thus $d(\phi)=\deg\phi\pmod{p}$.
  Hence $\phi$ is symplectic or antisymplectic according as $\deg\phi$
is a quadratic residue or nonresidue mod~$p$, respectively.  We will refer to
this condition as the \emph{isogeny criterion}.

Given $G_\Q$-isomorphic modules $E[p]$ and~$E'[p]$, it is possible
they admit isomorphisms with both symplectic types; this occurs if and only if $E[p]$ admits an anti-symplectic automorphism. 
The following proposition shows this phenomenon can occur only 
for $p < 7$ hence, when a $G_\Q$-isomorphism $\phi : E[p] \simeq E'[p]$ exists, normally there is only one possible symplectic type for any such~$\phi$; in particular, this will be the case for all the isomorphisms we consider in this work. 
For an example where both types exist, take $p=5$ and
$E$, $E'$ to be the curves\footnote{Throughout the paper we use
Cremona labels for elliptic curves over~$\Q$; these curves may be
found in the LMFDB (see \cite{lmfdb}).} $\lmfdbec{11}{a}{1}$ and
$\lmfdbec{1342}{c}{2}$, respectively (see~\cite[Example~5.2]{FKSym}
for more details).

\begin{proposition}\label{P:auto}
  Let $E$ and~$E'$ be elliptic curves defined over~$\Q$ such that
  $E[p]\cong E'[p]$ as $G_\Q$-modules.
  \begin{enumerate}
    \item If $E[p]$ is irreducible, then the isomorphism $E[p]\cong
      E'[p]$ is unique up to scaling; hence its symplectic type is
      well-defined.
      \item If $p\ge7$ then the same conclusion also holds when
        $E[p]$ is reducible.
  \end{enumerate}
\end{proposition}
\begin{proof} See~\cite[Corollary~3 and Proposition~2]{FKSym}
\end{proof}

\begin{comment}
both have $5$-torsion Galois module isomorphic to $\mu_5
\times \Z/5\Z$.  Now let $P,Q \in E[5]$ and $P',Q' \in E'[5]$ be bases
such that $P$, $P'$ are defined over~$\Q$.  The map defined by $P
\mapsto P'$ and $Q \mapsto n\cdot Q'$ (with $5 \nmid n$) is a
$G_\Q$-isomorphism which is symplectic if and only if $n$ is a square
mod~$5$.  Moreover, the automorphism $\alpha$ of $E[5]$ given by
$\alpha(P) = P$ and $\alpha(Q) = 2Q$ is anti-symplectic because $2$ is
not a square modulo~$5$.
\end{comment}

It is then natural to consider triples $(E,E',p)$ where $E/\Q$ and $E'/\Q$ are elliptic
curves with isomorphic $p$-torsion such that the $G_\Q$-modules
isomorphisms $\phi : E[p] \rightarrow E'[p]$ are either all symplectic
or all anti-symplectic.  In this case, we will say that the {\em
  symplectic type} of $(E,E',p)$ is respectively symplectic or
anti-symplectic.  The problem of determining the symplectic of
$(E,E',p)$ was extensively studied by the second author and Alain
Kraus in~\cite{FKSym}.

The isogeny criterion gives an easy solution when $(E,E',p)$
arises from an isogeny $h \colon E \to E'$ of degree~$n$ coprime
to~$p$, since in such cases $d(h|_{E[p]}) = n$ and the symplectic type
of $(E,E',p)$ is symplectic if $n$ is a square mod~$p$ and
anti-symplectic otherwise.

Given a generic triple $(E, E', p)$, in principle, one
could compute the $p$-torsion fields of $E$ and $E'$,
write down the Galois action on $E[p]$ and $E'[p]$ and check if they
are symplectically or anti-symplectically isomorphic. However, the
degree of the $p$-torsion fields grows very fast with~$p$ making this
method not practical already for $p = 5$.

One way to circumvent this computational problem is to use the methods
presented in~\cite{FKSym}. Indeed, the main objective of {\it
  loc. cit.} was to establish several {\em local symplectic criteria},
allowing one to determine the symplectic type of $(E,E',p)$ using only
standard information about the local curves $E/\Q_\ell$ and
$E'/\Q_\ell$ at a single prime $\ell \neq p$ and congruence conditions
on~$p$. Furthermore, in~\cite{FKSym} it is also proved that if the
symplectic type of~$(E,E',p)$ is encoded in local information at a
single prime $\ell \neq p$, then one of the local criteria will
successfully determine it.  
There are cases where the local methods
are insufficient: however, this can occur only when the image
of the $p$-torsion representation~$\rhobar_{E,p} : G_\Q \to \GL_2(\F_p)$ attached to~$E$ contains no elements of order~$p$;
see \cite[Proposition~16]{FKSym} for such an example.

The main objective of this paper is to give a uniform procedure to
determine, for a few small~$p$, the symplectic type of
triples~$(E,E',p)$ independently of the image of~$\rhobar_{E,p}$.

We have implemented in {\Magma} \cite{magma} and {\Sage} \cite{sage}
the methods from this paper together with those from~\cite{FKSym}. We
have used our code to classify the symplectic types of congruences
between curves in the LMFDB (see \cite{lmfdb}), namely all elliptic
curves defined over~$\Q$ of conductor less
than~$\numprint{400000}$. More precisely, Theorem~\ref{T:cong19} shows
there are no mod~$p$ congruences in LMFDB for $p \geq 19$ and we
found, for $p$ in the range $7 \leq p \leq 17$, all the congruences in
the database up to twist; we report on the results obtained in
Section~\ref{S:statistics}~and~\ref{S:Frey-Mazur}.

The description of our method also includes a discussion on how to
determine whether $E[p]$ and~$E'[p]$ are isomorphic (ignoring the
symplectic structure) in both the irreducible and reducible
cases. Moreover, we give two global symplectic criteria for particular
types of congruences: Theorem~\ref{T:Cartan} covers congruences
between an elliptic curve~$E$ with mod~$p$ image in the normalizer of
a Cartan subgroup and a certain quadratic twist of~$E$ and
Theorem~\ref{T:j=0} covers a mod~$7$ congruence between elliptic
curves~$E$ with $j(E)=0$ and a sextic twist of~$E$.

\subsection{Modular parametrizations}
The modular curve $X(p)$ parametrizes elliptic curves with full
level~$p$ structure. It has genus~$0$ for $p=2,3,5$, genus~$3$ for
$p=7$ and genus~$\ge26$ for $p\ge11$.  Fixing an elliptic
curve~$E/\Q$, the curve $X_E(p)$, which is a twist of~$X(p)$ (and
hence has the same genus), parametrizes pairs $(E',\phi)$ such that
$\phi$ is a symplectic isomorphism~$E[p]\cong E'[p]$; similarly
$X_E^-(p)$ parametrizes antisymplectic isomorphisms. Note that the pair $(E,\id)$ constituted by $E$ itself and the identity map
gives a base point defined over~$\Q$ on~$X_E(p)$, while $X_E^-(p)$ may have no rational points.

It follows that congruences modulo~$p$ for $p\le 5$ are common.  There
are certainly many mod~$3$ and mod~$5$ congruences in the database,
but we have not searched for these systematically. Indeed, since
$X_E(3)$ and $X_E(5)$ have genus~0, for each fixed~$E$, there will
always be congruences that are not part of the database independently
of its range. In contrast, for primes~$p \geq 7$, the curve $X_E(p)$
has genus~$\geq 3$ and so for each~$E$ there are only finitely many
mod~$p$ congruences with~$E$, hence the database
might contain all such congruences; however proving this fact for a
fixed~$E$ is a hard problem.

For convenience 
we sometimes also write $X_E^+(p)$ to denote $X_E(p)$. 
By ``explicit equations'' for $X_E^{\pm}(p)$, we mean the
following.
\begin{itemize}
  \item An explicit model for a family of curves, with equations whose
    coefficients are polynomials in $\Q[a,b]$, such that specializing
    $a,b$ gives a model for $X_E^{\pm}(p)$ where $E$ is the elliptic
    curve with equation $Y^2=X^3=aX+b$; each rational point $P$ is
    either a cusp of the modular curve or encodes a pair $(E',\phi)$
    such that $(E,E', p)$ is a symplectic (respectively,
    antisymplectic) triple.
    \item A rational function with coefficients in $\Q(a,b)$ defining
      the map $j: X_E^{\pm}(p) \to \PP^1$, taking a point
      $P=(E',\phi)$ to $j(E')$.  The degree of this map is the
      index~$[\PSL_2(\Z):\Gamma(p)] = |\PSL_2(\F_p)|$: for example, when
        $p=7$ the degree is~$168$.
      \item Rational functions $c_4$ and $c_6$ such that for each
        non-cuspidal point~$P=(E',\phi)$, a model for $E'$ is
        $Y^2=X^3+a'X+b'$ where $(a',b')=(-27c_4(P),-54c_6(P))$.
\end{itemize}
For $p=3$ and~$p=5$, the curves themselves have genus~$0$ and hence we
do not need equations, but the formulas for $j$, $c_4$ and~$c_6$ are
still useful.  They may be found in \cite{Rubin-Silverberg}.

Equations for $X_E(7)$, in this sense, were obtained by Kraus and
Halberstadt in~\cite{Halberstadt-Kraus-XE7}, though the functions
$c_4$ and $c_6$ in \cite{Halberstadt-Kraus-XE7} are only defined away
from $5$ points (which may or may not be rational). Fisher gives more
complete equations for this, together with $X_E^-(7)$ and
$X_E^{\pm}(11)$, in~\cite{Fisher}.

%% Below we will study congruences modulo~$p$ systematically for~$p\ge7$,
%% giving more detail for $p=7$.  The number of congruences in the
%% database for $p=11$, $p=13$, and $p=17$ is small; in the latter case,
%% there is only one such congruence (up to twist), as noted in
%% \cite{Billerey17}.  An explicit form of the Frey-Mazur conjecture (see
%% below) asserts that there should exist no congruences modulo~$p>17$
%% apart from those induced by isogenies.


\subsection{Further motivation} \label{S:motivation}
We finish this introduction with a discussion on how the methods of
this paper complement the local methods in~\cite{FKSym}.

From the discussion so far we know that triples $(E,E',p)$ as above give rise to $\Q$-points on at least one of the modular curves~$X_E(p)$ or $X_E^-(p)$. 

The Frey-Mazur conjecture states there is a constant $C \geq 18$ such
that, if $E/\Q$ and $E'/\Q$ satisfy $E[p] \simeq E'[p]$ as
$G_\Q$-modules for some prime $p > C$, then $E$ and $E'$ are
$\Q$-isogenous. Theorem~\ref{T:cong19} shows that for curves of
conductor at most~$\numprint{400000}$, this holds with~$C=18$. In view
of this conjecture, any~$(E,E',p)$ with $p > C$ arises from an
isogeny, hence its symplectic type is easily determined by the isogeny
criterion. Thus we are interested in primes $p \leq C$.

%% For $p=3,5$ the modular curves $X(p)$  have genus~0, equations for $X_E(p)$ and $X_E^-(p)$ are well known and we can obtain infinitely many triples $(E,E',p)$ with each symplectic type. 

As mentioned above, it follows from~\cite{FKSym} 
that if no local symplectic criterion
applies to~$(E,E',p)$ then the image of $\rhobar_{E,p}$ is irreducible and contains no element of order~multiple of~$p$. Moreover, 
when $\rhobar_{E,p}$ is reducible only the criteria at primes of multiplicative or good reduction may succeed and often the bounds
on a prime~$\ell$ for which a local criterion at~$\ell$ 
applies may not be useful in practice.
From the strong form of Serre's uniformity conjecture, these `bad' cases for the local methods imply that either $E$ has CM 
or one of the following holds:
\begin{itemize}
 \item[(i)] $p=3,5,7$ and $\rhobar_{E,p}$ is reducible or has image the normalizer of a Cartan subgroup;
 \item[(ii)] $p=11$ and $\rhobar_{E,p}$ has image the normalizer of non-split Cartan subgroup;
 \item[(iii)] $p=13$ and $\rhobar_{E,p}$ is reducible; 
 \item[(iv)] $p=13$ and $\rhobar_{E,p}$ has exceptional image projectively isomorphic to $S_4$;
 \item[(v)] $p=11,17$ or $37$, and $j(E)$ is listed
 in \cite[Table~2.1]{DahmenPhD}; in particular, $\rhobar_{E,p}$ is reducible.
\end{itemize}
The method we describe in Section~\ref{S:statistics} for $p=7$ can be
adapted by replacing the modular curves~$X_E(7)$ by $X_E(p)$ when
explicit equations for the latter are known, which is the case for
$p=3,5$ and~$11$. This method works independently of the image
of~$\rhobar_{E,p}$, so covers cases (i) and (ii) above.

In \cite[Corollary~1.9]{BarinderCrem} there is a list of~$3$ rational
$j$-invariants of elliptic curves over~$\Q$ satisfying~(iv); it has
recently been shown (see~\cite{BDMTV-S4}) that the associated
genus~$3$ modular curve~$X_{S_4}(13)$ found explicitly
in~\cite{BarinderCrem} has no more rational points, and hence that
this list is complete. By Proposition~\ref{P:twist}, none of these
curves is mod~$13$ congruent to a quadratic twist of another of them
(including itself); the same is true for the curves and values of~$p$
in case~(v). Thus no examples arise in cases (iv) and (v).

The remaining case~(iii) includes the infinitely many curves with
$\rhobar_{E,13}$ reducible (recall that $X_0(13)$ has genus~0). In
spite of the lack of helpful bounds as mentioned above, a congruence
between such curves will often be addressed by local methods in
practice. Indeed, the bounds are very large as they depend on
Tchebotarev density theorem to predict a prime~$\ell$ of good
reduction for~$E$ where Frobenius has order multiple of~$p$; however,
in practice, it is usually easy to find such a prime~$\ell$ after
trying a few small primes.  There are no reducible mod~$13$ congruences in the LMFDB database, so instead we refer to \cite[Example~31.2]{FKSym} for
an example with $p=7$ analogous to the discussion in this paragraph.

\section{Congruences between Twists}

Congruences between elliptic curves which are twists of each other arise in a number of ways in our study; in this section we look into this situation in detail.

Let $p$ be an odd prime. Write $D_{n}$ to denote the dihedral group
with~$2n$ elements and $C_n \subset D_{n}$ for a normal cyclic
subgroup of order~$n$; note that $C_n$ is unique unless $n=2$, in
which case $D_{n} \simeq C_2 \times C_2$.  We will also denote by $C
\subset \GL_2(\F_p)$ a Cartan subgroup (either split or non-split) and
by $N$ its normalizer in $\GL_2(\F_p)$.  In what follows we will use
standard facts about subgroups of $\GL_2(\F_p)$ and $\PGL_2(\F_p)$:
see, for example, \cite[Theorem XI.2.3]{LangModForms}.

Let $K$ be a number field and $E/K$ an elliptic curve. The representation $\rhobar_{E,p}$ has image contained in $N \subset \GL_2(\F_p)$ but not in the Cartan subgroup~$C$ 
if and only if the projective image 
$\PP \rhobar_{E,p}(G_K)$ is~$D_{n}$ for some~$n$. In particular, there will be a quadratic extension~$M = K(\sqrt{d})$ corresponding to the subgroup~$C_n$ as above, i.e. $\PP \rhobar_{E,p}(G_M) \simeq C_n$. The character $\eps_d$ cutting out~$M/K$ is obtained also by the composition
\[
 \eps_d \; : G_K \to \rhobar_{E,p}(G_K) \twoheadrightarrow \rhobar_{E,p}(G_K)/C \simeq \{\pm 1 \}.
\]

\subsection{Quadratic Twists}

We say that two curves $E/K$ and $E'/K$ are {\em quadratic twists},
when they become isomorphic over a quadratic extension~$L/K$.  Writing
$L=K(\sqrt{d})$ with $d\in K$ non-square, we denote by~$E^d$ the unique $K$-isomorphism class of quadratic twists of~$E$.

The special case in the following lemma (which is valid over all
fields~$K$ of characteristic neither~$2$ nor~$3$) will be important
when we consider curves with $j$-invariant~$1728$ below.

\begin{lemma}\label{L:quadratic-twist} Let $a, b , d\in K$ with $d$ not a square. Denote by $E_{a,b}$ the elliptic curve defined by the short Weierstrass equation $Y^2=X^3+aX+b$ and 
let $L=K(\sqrt{d})$. Then the quadratic
twist~$E_{a,b}^d$ is $E_{ad^2,bd^3}$ unless $L=K(\sqrt{-1})$ and
$b=0$, when we have $E_{a,0}^{-1}=E_{-4a,0}$.
\end{lemma}
\begin{proof}
Recall that all isomorphisms between short Weierstrass equations are
of the form $E_{a,b}\cong E_{au^4,bu^6}$ with $u\not=0$.  Hence in all
cases it is true that $E_{a,b}\cong E_{ad^2,bd^3}$ over~$L$, taking
$u=\sqrt{d}$. We need to ensure that they are not isomorphic over~$K$.
If so, then there exists $u\in K^*$ such that $ad^2=au^4$ and
$bd^3=bu^6$.  If $b\not=0$ then $d^3=u^6$ so $d$ is a square in~$K$,
contradiction.  If $b=0$ then $a\not=0$ and $d^2=u^4$.  Since $d$ is
non-square this implies $d=-u^2$ and $-1$ non-square, so
$L=K(\sqrt{-1})$.  In this case the twist is $E_{-4a,0}$ since $-4$ is
not a $4$th power in~$K$ (not even a square) but $-4=(1+\sqrt{-1})^4$
in~$L$.
\end{proof}

\begin{remark}\label{R:2-isog}
In the special case, note that $E_{-4a,0}$ is also $2$-isogenous
to~$E_{a,0}$ (see \cite[p. 336]{SilvermanI}).  These curves have CM
by~$\Z[\sqrt{-1}]$, and after base-change to~$K(\sqrt{-1})$ the
$2$-isogeny becomes the endomorphism~$1+\sqrt{-1}$.
\end{remark}

\begin{remark}
In all cases, the Galois representations of $E$ and~$E^d$ are related
by
\begin{equation}
  \rhobar_{E^d,p} \cong \rhobar_{E,p}\otimes\eps_d, \label{E:rho-twist}
\end{equation}
where $\eps_d$ is the quadratic character of~$G_K$ associated to the
extension $K(\sqrt{d})/K$.  In the special case, and more generally
when $E$ has CM with the extra endomorphisms defined
over~$K(\sqrt{d})$, since $E$ and $E^{d}$ are isogenous, it is also
true that $\rhobar_{E^d,p} \cong \rhobar_{E,p}$ and $\rhobar_{E,p}
\cong \rhobar_{E,p}\otimes\eps_d$.
\textbf{I think we need to exclude $p$ which are ramified in
  $K(\sqrt{d})$ here?}
\end{remark}


\begin{proposition} \label{P:twistNumber}
Let $E/K$ be an elliptic curve satisfying that~$\rhobar_{E,p}$ has
projectively dihedral image, that is $\PP \rhobar_{E,p} (G_K) \simeq
D_{n}$, and $M=K(\sqrt{d})$ the quadratic field cut out by~$D_n/C_n$,
as above, where $C_n$ denotes a cyclic subgroup of~$D_n$ of order~$n$.

Then the quadratic twist~$E^d$ satisfies $E[p] \simeq E^d[p]$ as
$G_K$-modules.  Moreover, there are either 1 or 3 quadratic
fields~$M$ with this property, and the latter case occurs if and only
if $n=2$.
\end{proposition}
\begin{proof} 
Recall from the above discussion that 
$\rhobar_{E,p}$ has image contained in $N \subset \GL_2(\F_p)$ but not in the Cartan subgroup~$C$. Thus $\Tr \rhobar_{E,p}(\sigma) = 0$ for all $\sigma \in G_K$ such that $\rhobar_{E,p}(\sigma) \not\in C$. 

Let $\eps_d$ denote the character corresponding to~$M$ as above.
By~(\ref{E:rho-twist}), for all $\sigma \in G_K$ we have the following
equality of traces
\[\Tr \rhobar_{{E^d},p}(\sigma) = \eps_d(\sigma) \cdot \Tr \rhobar_{E,p}(\sigma).\]

Clearly, if $\eps_d(\sigma)=1$ then $\Tr \rhobar_{E,p}(\sigma) = \Tr \rhobar_{E^d,p}(\sigma)$. 
If $\eps(\sigma) = -1$ then $\rhobar_{E,p}(\sigma) \in \rhobar_{E,p} (G_K) \backslash C$ and $\Tr \rhobar_{E,p}(\sigma) = 0$, so also $\Tr \rhobar_{E^d,p}(\sigma) = 0$.
Then, $\Tr \rhobar_{E,p}(\sigma) = \Tr \rhobar_{E^d,p}(\sigma)$ 
for all $\sigma \in G_K$. 

Since $\rhobar_{E,p}$ and $\rhobar_{E^d,p}$ are irreducible and have
the same traces we have $\rhobar_{E,p} \simeq \rhobar_{E^d,p}$.

The last statement follows by the discussion at the start of this
section. Indeed, note that there will be one quadratic extension~$M/K$
corresponding to each cyclic subgroup $C_n \subset D_{n}$ of index~2.
\end{proof}

\begin{corollary}\label{C:CM-twist}
  Let $E/\Q$ be an elliptic curve with CM by the
  imaginary quadratic order of (negative) discriminant~$-D$.  Set
  $F=\Q(\sqrt{-D})$.

  Then $E[p] \simeq E^{-D}[p]$ for all primes $p \geq 5$ unramified
  in~$F$ and of good reduction for~$E$.

  For each such~$p$, $E^{-D}$ is the unique quadratic twist congruent
  to~$E$.

  The congruence is symplectic if and only if $\legendre{2}{p}=+1$
  when $D=4$, and if and only if $\legendre{D}{p}=+1$ otherwise.
\end{corollary}
\begin{proof}
Since $E$ has CM by~$F$ we know that the image of~$\rhobar_{E,p}$ is
the normalizer of a Cartan for all primes $p$ unramified in~$F$ and of
good reduction for~$E$.  Moreover, $\PP \rhobar_{E,p} \simeq D_n \neq
C_2 \times C_2$ (since $p \geq 5$) and $\PP \rhobar_{E,p}(G_F) \simeq
C_n$. Thus, for each such~$p$, in the notation of
Proposition~\ref{P:twistNumber}, we have $M=F$ and $M$ is unique,
hence~$D$ is unique modulo squares.

The last part follows from the fact that $E$ and~$E^{-D}$ are
isogenous via an isogeny whose degree is~$2$ for $D=4$, $D/4$ for
$D=8,12,16$, and~$28$ and $D$ otherwise.  This isogeny becomes an
endomorphism after base-change to~$F$.
\end{proof}

\begin{comment}
Explanation of the isogeny degree:  we look for an element of the
order which is primitive (not divisible within the order by any
integer >1) so that the kernel is cyclic, and on which Galois acts as
it does on the twist isomorphism.  Apart from D=4 the latter
con-diction means that the element must be pure imaginary, which
uniquely determines it up to sign.  For D=4 we need a primitive
element of Z[i] whose conjugate is misapplied by i or -i.

D = 4: 1+i, norm 2
D = 16: 2i, norm 4

D = 8: Surat{-2}, norm 2

D = 3 and 12: Surat{-3}, norm 3
D = 27: 3*sqrt{-3}, norm 27

D = 7 and 28: sqrt{-7], norm 7

D = p = 11, 19, 43, 67, 163: sqrt{-p}, norm p

The fact of 4 for D=16,8,12,28 does not affect the legendre symbol but
the factor of 2 for D=4 does!
\end{comment}

\begin{remark}\label{R:CM}
The last part of the Corollary is also a special case of
Theorem~\ref{T:Cartan} below.
\end{remark}


The above proposition shows that we can find congruent quadratic
twists when $\rhobar_{E,p}$ has image in the normalizer of a Cartan
but not in the Cartan itself. The following proposition gives a
converse statement to this.

\begin{proposition}\label{P:twist}
Let $E/K$ and $E^d/K$ be quadratic twists, where $d\in K^*$ is not a
square. Assume that, for some prime $p\ge3$, we have $E[p]\cong E^d[p]$
as $G_K$-modules, and that $E[p]$ is irreducible.

Then the image of~$\rhobar_{E,p}$
is contained in the normaliser of a Cartan subgroup of $\GL_2(\F_p)$
but not in the subgroup itself.
\end{proposition}

\begin{proof}
Let $\eps_d$ be the quadratic character of $G_K$ associated to the
extension $K(\sqrt{d})/K$. By (\ref{E:rho-twist}), for primes~$\frq$
of~$K$ where both curves have good reduction (so excluding only
finitely many primes), we have
\[
  a_\frq(E^d) = \eps_d(\frq) a_\frq(E),
\]
where $a_\frq(E)$ and $a_\frq(E^d)$ denotes the trace of Frobenius at
$\frq$ of~$E$ and~$E^d$, respectively, and we view $\eps_d$ is a
function on primes of~$K$ unramified in~$K(\sqrt{d})$ as usual via
class field theory.
  
Moreover, since $E^d[p]\cong
  E[p]$, we have
  \[
  a_\frq(E^d) \equiv a_\frq(E) \pmod{p}.
  \]
  Hence for almost all primes~$\frq$ satisfying $\eps_d(\frq) = -1$ (i.e. inert
  in~$K(\sqrt{d})/K$) we have
  \[
  a_\frq(E^d) \equiv a_\frq(E) \equiv0 \pmod{p}.
  \]
  So the image $H=\rhobar_{E,p}(G_K)$ has a
  subgroup~$H^+=\rhobar_{E,p}(G_{K(\sqrt{d})})$ of index~$2$ such that
  all elements of~$H\setminus H^+$ have trace~$0$.  Such elements have
  order~$2$ in $\PGL_2(\F_p)$.

  %% \textbf{The following sentnce was lazy, and in fact incorrect: we
  %%   could have image
  %%   $\left\{\begin{pmatrix}\pm1&*\\0&1\end{pmatrix}\right\}$, dihedral
  %%   of order $2p$, but not contained in any Cartan normalizer since
  %%   these have order prime to $p$.}

  From the classification of subgroups
  of $\PGL_2(\F_p)$ it follows that $H$ is contained in the normaliser
  of a Cartan subgroup~$C$ and $H^+=H\cap C$.
\end{proof}


We have seen that congruences between quadratic twists can occur when
the image of $\rhobar_{E,p}$ is the normaliser of a Cartan
subgroup. The next result, generalising the CM case of
Corollary~\ref{C:CM-twist}, determines the symplectic type of such
congruences. Recall from the introduction that this is one of the
cases where the local methods from~\cite{FKSym} may not apply, as
illustrated by Example~\ref{Ex:LocalFail7} below.

\begin{theorem} \label{T:Cartan}
Let $p \geq 3$ be a prime. Let $E/K$ be an elliptic curve such that
$\rhobar_{E,p}$ has image contained in the normalizer~$N$ of a Cartan
subgroup~$C$ (either split or non-split), but is not contained in~$C$
itself.  Let $K(\sqrt{d})$ be the quadratic extension of~$K$ cut out
by the subgroup~$\rhobar_{E,p}^{-1}(C)$ of~$G_K$, which has index~$2$
in~$G_K$.

1) If $K(\sqrt{d})=K(\sqrt{-1})$ and~$j(E)=1728$, then $E[p] \simeq
E^d[p]$, the isomorphism being symplectic or antisymplectic according
as the Legendre symbol $(2/p)=+1$ or~$-1$ respectively.

\textbf{In case $p=3$ the rest of the statement needs more work since
  the split C is contained in the nonsplit C.  When this is the image
  we need to make clear that Case (3) applies, not Case 2.}

2) Otherwise, assume $p > 3$ or $p=3$ and $C$ is non-split.
Then~$E^d$ is the unique quadratic twist of~$E$ such that $E[p] \simeq
E^d[p]$ as $G_K$-modules, and the isomorphism is symplectic if and
only if $C$ is split and $p \equiv 1 \pmod{4}$, or $C$ is non-split
and $p \equiv 3 \pmod{4}$.

3) Assume $p=3$ and $C$ is split. Then there are three quadratic twists~$E^{d_i}$ of~$E$ such 
that $E[3] \simeq E^{d_i}[3]$ as $G_K$-modules, for $i=1,2,3$  . Moreover, for two values of~$d_i$ these modules are anti-symplectically isomorphic and for the third value they are symplectically isomorphic.
\end{theorem}

\begin{proof} 
The hypothesis on the image implies $\PP \rhobar_{E,p} \simeq D_n$ for
some $n \geq 2$.  By Proposition~\ref{P:twistNumber}, we have $E[p]
\simeq E^d[p]$, and if $n>2$ there are no other quadratic twists
congruent to~$E$.

Note that $n=4$ when $p =3$ and $C$ is non-split, and $n \neq 2$ if $p
> 3$.  This implies the uniquness part of case~2).

1) When case $j(E)=1728$ and $d=-1$ (modulo squares), we know by
Remark~\ref{R:2-isog} that $E^{-1}$ is $2$-isogenous to~$E$, so the
result follows by the isogeny criterion.  Assume from now on that we
are not in this case.

2) We have already seen that there is a unique quadratic twist~$E^d$
such that $E[p] \simeq~E^d[p]$.  Furthermore, the field $K(\sqrt{d})$
is contained in the $p$-torsion fields of $E$ and $E^d$, and the
restriction to $G_{K(\sqrt{d})}$ has image contained in the Cartan~$C$.
As usual, write $\eps_d$ for the quadratic character of~$G_K$
fixing~$K(\sqrt{d})$.

\begin{comment}
 We first prove that $E[p] \simeq E^d[p]$ as $G_K$-modules. 
Note that $\rhobar_{{E^d}, p} = \rhobar_{E, p} \otimes \eps$, and
hence for all $\sigma \in G_K$ we have
\[\Tr \rhobar_{{E^d},p}(\sigma) = \eps(\sigma) \cdot \Tr \rhobar_{E,p}(\sigma).\]

Note that, if $\eps(\sigma) = -1$ then $\rhobar_{E,p}(\sigma) \in N\backslash C$ and $\Tr \rhobar_{E,p}(\sigma) = 0$, so also $\Tr \rhobar_{E^d,p}(\sigma) = 0$;
therefore, $\Tr \rhobar_{E,p}(\sigma) = \Tr \rhobar_{E^d,p}(\sigma)$ 
for all $\sigma \in G_K$. Since these representations are irreducible and have
the same traces it follows that they are isomorphic.
\end{comment}

From the hypothesis on the image of $\rhobar_{E,p}$, we can choose a
basis $P_1, P_2$ of $E[p]$ such that the image of~$\rhobar_{E,p}$ is
contained in the subgroup~$N$ of $\GL_2(\F_p)$ given by
\[
N = \left\{ 
\begin{pmatrix}
a & b\delta \\
b & a
\end{pmatrix}, 
\begin{pmatrix}
a & b\delta \\
-b & -a
\end{pmatrix}  \; : a, b \in \F_p, \; a^2 - \delta b^2 \neq 0 \right\},
\]
which is the normaliser of the Cartan subgroup
\[
C = \left\{ 
\begin{pmatrix}
a & b\delta \\
b & a
\end{pmatrix}  \; : a, b \in \F_p, \; a^2 - \delta b^2 \neq 0 \right\};
\]
here, $\delta \in \F_p^*$ is a (fixed) square if $C$ is split and a
non-square if $C$ is non-split.  Furthermore, for $\sigma \in
G_K$, we have
\[
 \rhobar_{E,p}(\sigma) = \begin{pmatrix}1&0\\0&\eps_d(\sigma)\end{pmatrix} 
                            \begin{pmatrix}
                            a & b\delta \\
                            b & a
                            \end{pmatrix}.
                            \]
%% \[
%%  \rhobar_{E,p}(\sigma) = \begin{cases} 
%%                             \begin{pmatrix}
%%                             a & b\delta \\
%%                             b & a
%%                             \end{pmatrix} \quad \text{ if } \eps_d(\sigma) = 1,  \\
%% \begin{pmatrix}
%% a & b\delta \\
%% -b & -a
%% \end{pmatrix} \quad \text{ if } \eps_d(\sigma) = -1.  \\
%% \end{cases}\]
Fix $\tau \in G_K$ such that $\rhobar_{E,p}\in N\setminus C$, say
\[
 \rhobar_{E,p}(\tau) =  \begin{pmatrix}
                            a & b\delta \\
                            -b & -a
                            \end{pmatrix},
\]
so that $\rhobar_{E,p}(G_K) = N = \langle C,\rhobar_{E,p}(\tau) \rangle$.

Since we are not in case~1), an isomorphism from $E$ to $E^d$ defined
over $K(\sqrt{d})$ is given by $(x,y) \mapsto (dx,d\sqrt{d}y)$.  Let
$\tw : E[p](\Qbar) \to E^d[p](\Qbar)$ be the map on $p$-torsion points
induced by it.  With a direct calculation we see that
\begin{equation} \label{E:eps}
 \tw(\sigma(P)) = \eps_d(\sigma)\cdot\sigma(\tw(P)) \quad \text{ for all } \sigma \in G_K 
 \text{ and all } P \in E[P]. 
 \end{equation}
We now consider the linear
map $\phi : E[p] \to E^d[p]$ defined on the basis by
\[
 \phi(P_1) = \tw (P_2) \quad \text{ and } \quad   \phi(P_2) = \delta \tw (P_1),
\]
and will show it is $G_K$-equivariant, i.e. $\sigma(\phi(P)) =
\phi(\sigma(P))$ for all $\sigma \in G_K$ and $P \in E[P]$.

We first consider the acton of~$\tau$.  Since $\eps_d(\tau) = -1$, we
have

[Not yet typed properly but the point is that rho(tau) anticommutes
  with [0,delta;1,0] but rho(sigma) in C commoutes with it.]

\[
 \tau(\phi(P_1)) = \tau(\tw(P_2)) = -\tw(\tau(P_2)) = -\tw (-P_2) = \phi(P_1) = \phi(\tau(P_1)),
\]
where in the second inequality we used~\eqref{E:eps}; also,
\[
 \tau(\phi(P_2)) = \tau(\delta \tw(P_1)) = -\delta \tw(\tau(P_1)) = 
  -\delta \tw(P_1) = -\phi (P_2) = \phi(\tau(P_2)).
\]
Next, for $\sigma \in G_K$ such that $\rhobar_{E,p}(\sigma) \in C$, we
have $\eps_d(\sigma) = 1$ and
\[
 \rhobar_{E,p}(\sigma) =  \begin{pmatrix}
                            a & b\delta \\
                            b & a
                            \end{pmatrix}.
\]
Therefore, equation~\eqref{E:eps} 
gives $\tw(\sigma(P_i)) = \sigma(\tw(P_i))$ and we have
\[
 \sigma(\phi(P_1)) = \sigma(\tw(P_2)) = \tw (\sigma (P_2)) 
 = \tw (\delta b P_1 + a P_2) = \delta b \tw (P_1) + a\tw(P_2) = b \phi(P_2) + a \phi(P_1)
\]
and
\[
 \sigma(\phi(P_2)) = \delta \sigma(\tw(P_1)) = \delta \tw (\sigma (P_1)) 
 = \delta \tw (a P_1 + b P_2) = a \phi(P_2) + b \delta \phi(P_1) = \phi(\sigma(P_2)),
\]
as desired. Finally, we note that 
\[
 e_{E^d,p}(\phi(P_1),\phi(P_2)) = e_{E^d,p}(\tw (P_2),\delta \tw(P_1)) 
 =  e_{E^d,p}(\tw (P_1), \tw (P_2))^{-\delta} =  e_{E,p}(P_1,P_2)^{-\delta}, 
 \]
where the last equality holds since $\tw$ preserves the Weil pairing.
Thus $\phi$ is symplectic if and only if $(-\delta/p) = 1$.

2) In this case we have $\PP \rhobar_{E,3} \simeq C_2 \times C_2$
therefore there are three twists $E^{d_i}$ of~$E$ such that $E[3]
\simeq E^{d_i}[3]$ by Proposition~\ref{P:twistNumber}. We have
$K(\sqrt{d_i}) \subset K(E[3]) = K(E^{d_i}[3])$.  Moreover, we are not
in the special case of $j=1728$ here since $3$ is inert in the CM
field $\Q(\sqrt{-1})$ of such curves, so the mod~$3$ image is
contained in the normaliser of a non-split Cartan.

The normalizer~$N$ of a split Cartan $C \subset \GL_2(\F_3)$ has three index 2 subgroups: the split Cartan~$C$, another split Cartan~$C'$ and third subgroup~$H$ whose normalizer is the normalizer of non-split Cartan.
Restriction to the $G_{K(\sqrt{d_i})}$ corresponds to~$\rhobar_{E,3}$ having image in each of these subgroups. 
Therefore, for each of the two pairs $(N,C)$ and $(N,C')$ corresponding to (say) $d_1$ and~$d_2$, we can apply the same proof as in part 1). This yields that 
$E[3] \simeq E^{d_i}[3]$ are
anti-symplectically isomorphic for $i=1,2$.

We are left to show that $E[3] \simeq E^{d_3}[3]$ are symplectically isomorphic.
Indeed, we know that $E[3] \simeq E^{d_1}[3] \simeq E^{d_2}[3]$ where both the first isomorphism and the composition are anti-symplectic. Thus $E^{d_1}[3] \simeq E^{d_2}[3]$ are symplectically isomorphic $G_K$-modules. Because each of the twists satisfies the same hypothesis as~$E$ we can apply the first part of our argument to~$E^{d_1}$ to conclude the statement of the theorem holds for~$E^{d_1}$, hence also for~$E$.
\end{proof}

\begin{remark}
In our computed data, we do not see usually isomorphisms
arising from CM curves as in the previous remark. This is because
(apart from the CM cases where quartic or sextic twists occur) all
such mod~$p$ isomorphisms occur within an isogeny class, and we have
omitted these from consideration.
\end{remark}

Quadratic twists act on congruent pairs of curves:
\begin{proposition}\label{P:twist-cong}
Let $E_1$ and~$E_2$ be elliptic curves defined over a number field~$K$
and $p$ a prime such that $E_1[p]\cong E_2[p]$.  Then, for all
non-square $d\in K^*$ we also have $E_1^d[p]\cong E_2^d[p]$.
Moreover, the symplectic type of the isomorphism is preserved, unless
$d=-1$ and exactly one of $E_1$, $E_2$ has $j$-invariant~$1728$, in
which case the symplectic type is preserved if and only if
$\legendre{2}{p}=+1$.
\end{proposition}
\begin{proof}
This is essentially \cite[Lemma~11]{FKSym}, but there the special case
of the $-1$-twist of curves with $j=1728$ was not included, so we give
a complete proof here.

First suppose that either $d\not=-1$, or that $b_1$ and~$b_2$ are both
non-zero, so that neither twist is the special case.

Let $Y^2=X^3+a_kX+b_k$ for $k=1,2$ be short Weierstrass equations for
$E_1$ and $E_2$ respectively.  Let $\sigma$ be the nontrivial
automorphism of $K(\sqrt{d})/K$ and denote by $[-1]$ the negation
automorphism $(x,y)\mapsto(x,-y)$ on each elliptic curve.

Since we are not in the special case, for $k=1,2$ the quadratic twists
have equations $E_k^d:Y^2=X^3+a_kd^2X+b_kd^3$ and an isomorphism
$E_k\to E_k^d$, defined over~$K(\sqrt{d})$, is given by
$\alpha_k:(x,y)\mapsto (dx,d\sqrt{d}y)$.  Then we have
\[
\alpha_k^{\sigma} = [-1]\circ\alpha_k = \alpha_k\circ[-1]
\]
for $k=1,2$.  Let $\phi:E_1[p]\to E_2[p]$ be a $G_K$-equivariant
isomorphism.  Define $\psi:E_1^d[p]\to E_2^d[p]$ by
$\psi=\alpha_2\circ\phi\circ\alpha_1^{-1}$, which is a
$G_{K(\sqrt{d})}$-equivariant linear isomorphism, satisfying
\[
\psi^{\sigma} =
\alpha_2^{\sigma}\circ\phi^{\sigma}\circ(\alpha_1^{-1})^{\sigma} =
\alpha_2\circ[-1]\circ\phi\circ[-1]\circ\alpha_1^{-1} = \psi,
\]
since $[-1]\circ\phi=\phi\circ[-1]$, as $\phi$ is linear.  Hence in
fact $\psi$ is $G_K$-equivariant.  Finally, since the isomorphisms
$\alpha_k$ preserve the Weil pairing, the symplectic types of $\phi$
and~$\psi=\alpha_2\circ\phi\circ\alpha_1^{-1}$ are equal.

Now suppose that $d=-1\notin(K^*)^2$, and that one of the curves,
say~$E_1$, has $j$-invariant~$1728$.  Now $\rhobar_{E_1,p}$ has image
contained in the normaliser of a Cartan subgroup but not in the Cartan
itself; by Proposition~\ref{P:twistNumber} we have $E_1[p]\cong
E_1^{-1}[p]$.  Since $E_1[p]\cong E_2[p]$ we also have $E_2[p]\cong
E_2^{-1}[p]$ for the same reason, and hence $E_1^{-1}[p]\cong
E_2^{-1}[p]$.

As for the symplectic type, if also $j(E_2)=1728$ then both
isomorphisms $E_k[p]\cong E_k^{-1}[p]$ have the same type for $k=1,2$
since these twists are both also $2$-isogenies, so each is symplectic
if and only if $2$ is a quadratic residue modulo~$p$.  Hence the
composite $E_1^{-1}[p]\cong E_1[p]\cong E_2[p]\cong E_2^{-1}[p]$ has
the same type as $E_1[p]\cong E_2[p]$.  If $j(E_2)\not=1728$ then
Theorem~\ref{T:Cartan} implies that $E_2[p]\cong E_2^{-1}[p]$ is
always symplectic, for the image is split if and only
if~$p\equiv1\pmod4$.
\end{proof}

\begin{example}
Let $E_1=\lmfdbec{288}{a}{1}$ and $E_2=\lmfdbec{32544}{b}{1}$, of
which only the first has $j=1728$.  We have $E_1[7]\cong E_2[7]$, with
a symplectic isomorphism.  Twisting both curves by~$-1$ gives the pair
$E_1^{-1}=\lmfdbec{288}{a}{2}$ and $E_2^{-1}=\lmfdbec{32544}{c}{1}$,
which again have symplectically isomorphic mod~$7$ representations.
\end{example}

\begin{example}
  $E_1=\lmfdbec{32}{a}{1}$ has $j$-invariant $1728$, its $2$-isogenous
  twist is $E_1^{-1}=\lmfdbec{32}{a}{2}$, and these are
  antismplectically congruent mod~$5$ since $\legendre{2}{5}=-1$.
  They are also congruent mod~$5$ to $E_2=\lmfdbec{608}{b}{1}$ and its
  $-1$-twist $E_2^{-1}=\lmfdbec{608}{e}{1}$, which are symplectically
  $5$-congruent to each other in accordance with
  Theorem~\ref{T:Cartan}.  The mod~$5$ congruence between
  $\lmfdbec{32}{a}{1}$ and $\lmfdbec{608}{b}{1}$ is symplectic while
  that between $\lmfdbec{32}{a}{2}$ and $\lmfdbec{608}{e}{1}$ is
  antisymplectic, so in this case applying the $-1$-twist reverses the
  symplectic type.
\end{example}

\begin{example} \label{Ex:3twists}
  Let $E$ be the elliptic curve with LMFDB label~\lmfdbec{6534}{a}{1},
  of conductor $6534=2\cdot3^3\cdot11^2$.  The image of the mod~$3$
  Galois representation is isomorphic to $D_4$; it may be viewed as
  either the normalizer of a split Cartan, or a subgroup of index~$2$
  in the normalizer of a non-split Cartan, the latter being isomorphic
  to~$D_8$.  The three quadratic subfields of the $3$-division fields
  are $\Q(\sqrt{-3})$, $\Q(\sqrt{-11})$, and~$\Q(\sqrt{33})$; the
  corresponding quadratic twist of~$E$ are
  $E^{-3}=\lmfdbec{6534}{v}{1}$, $E^{-11}=\lmfdbec{6534}{p}{1}$, and
  $E^{33}=\lmfdbec{6534}{h}{1}$ respectively.  All four curves have
  isomorphic mod~$3$ representations, the isomorphism being
  antisymplectic for~$E^{-11}$ and~$E^{33}$ and symplectic for~$E^{-3}$. The conclusion on the symplectic types follows from part 2) of Theorem~\ref{T:Cartan} once we show
  that $E[3]$ and $E^{-3}[3]$ are symplectically isomorphic. We will show this by applying \cite[Theorem~5]{FKSym} with $\ell = 11$. We use the notation of {\it loc. cit.}. Write $E' = E^{-3}$. The curves $E/\Q_{11}$ and $E'/\Q_{11}$ have minimal models satisfying
  \[
  \vv_{11}(\Delta_m) = \vv_{11}(\Delta_m') = 3 \quad \text{ and } \quad \tilde{\Delta} = -1259712, \quad \tilde{\Delta}' = -1728.
  \]
 Thus $e = e' = 4$ by \cite[Proposition~1]{Kraus1990}. 
Moreover, we have $\vv_{11}(\Delta_m) \equiv \vv_{11}(\Delta_m') \pmod{4}$ and none of $\tilde{\Delta}$, $\tilde{\Delta}'$ is a square mod~$11$. Thus, $r=t=0$ and $E[3]$ and $E'[3]$ are symplectically isomorphic $G_{\Q_{11}}$-modules, hence $E[3]$ and $E'[3]$ are also symplectically isomorphic $G_\Q$-modules.

  
  
\end{example}
\begin{example} \label{Ex:LocalFail7}
Consider the elliptic curve
\[ E : y^2 + y = x^3 - x^2 - 74988699621831x +  238006866237979285299, \]
which has conductor $ N_E = 7^2 \cdot 2381 \cdot
134177^2>2\cdot10^{15}$, so is not in the LMFDB database.  This
example was found using the explicit parametrization of curves for
which the image of the mod~$7$ Galois representation is contained in
the normalizer of a non-split Cartan subgroup; we verified by explicit
computation that the image is equal to the full normalizer.

Let $d = -7 \cdot 134177$ and consider~$E^d$ the quadratic twist
of~$E$ by~$d$. Applying Theorem~\ref{T:j=1728} (or the general method
from Section~\ref{S:statistics}) yields that $E[7] \simeq E^d[7]$ are
symplectically isomorphic~$G_\Q$-modules and not anti-symplectically
isomorphic. Moreover, one can verify that none of the local criteria
in~\cite{FKSym} applies for this case.
\end{example}


\subsection{Mod $p$ isomorphisms between elliptic curves with
  $j$-invariant~$1728$}

Over any number field~$K$, elliptic curves with $j$-invariant~$1728$
have a model of the form
\[
E_a:\quad Y^2 = X^3+aX,
\]
and the isomorphism class of~$E_a$ depends only on
$a$ modulo $4$th powers. 
Any two such curves are quartic
twists of each other: the quartic twist of~$E_a$ by $t$ 
is~$E_{ta}$, which is isomorphic to~$E_a$ if and only if $t$ is a $4$th power. 
From our discussion of quadratic twists (see
Lemma~\ref{L:quadratic-twist}) we know that all quadratic twists of
$E_a$ have the form $E_a^d\cong E_{ad^2}$, except that when $-1$ is
not a square in~$K$ we have $E_a^{-1}\cong E_{-4a}$.  Note that the
natural map $K^*/(K^*)^4 \to L^*/(L^*)^4$ for $L=K(\sqrt{d})$ always
has kernel of order~$2$; it is generated by $d^2$, unless
$L=K(\sqrt{-1})$ in which case it is generated by~$-4$.

The curves $E_a$ and $E_{-4a}$ are $2$-isogenous (see
\cite[p. 336]{SilvermanI}), and hence $E_a[p]\cong E_{-4a}[p]$ for
all~$p>2$.  Our result for these curves is that there are no further
congruences between them for any~$p>2$, provided that the image of
$\rhobar_{E,p}$ is not too small.

\begin{theorem}\label{T:j=1728}
Let $K$ be a number field.  For all $a \in K^*$ and all primes~$p>2$,
the elliptic curves $E_a$ and $E_{-4a}$ have isomorphic mod-$p$ Galois
representations, the isomorphism being symplectic if and only if $2$
is a quadratic residue modulo~$p$.

Conversely, if $E_{a_1}[p]\cong E_{a_2}[p]$ and the projective image
of $\rhobar_{E_{a_1},p}$ has order greater than~$8$, then $a_1/a_2
\in\{1,-4\}$ modulo~$(K^*)^4$.  That is, either $E_{a_1}$
and~$E_{a_2}$ are isomorphic over~$K$, or $-1\notin(K^*)^2$ and
$E_{a_2}$ is the quadratic twist~$E_{a_1}^{-1}$.
\end{theorem}

\begin{proof}
The first part follows from the fact that $E_a$ and~$E_{-4a}$ are
$2$-isogenous, together with the isogeny criterion.

Suppose that $E_{a_1}[p]\cong E_{a_2}[p]$ and the image condition
holds.  Since $\PP \rhobar_{E_{a_1},p}(G_K)$ has order greater than~$8$,
we have that $\PP \rhobar_{E_{a_1},p}(G_L)\not\cong C_2\times C_2$, for any extension $L/K$ at most quadratic.

We first claim that if $E_{a_1}$ and~$E_{a_2}$ are not isomorphic
over~$K$ but are quadratic twists by an extension $L=K(\sqrt{d})$
of~$K$, then $L=K(\sqrt{-1})$ (and $\sqrt{-1} \notin K$).  For suppose
that $E_{a_1}$ and~$E_{a_2}$ become isomorphic over~$L=K(\sqrt{d})$.
Applying Proposition~\ref{P:twist}, the image of $\rhobar_{E,p}$ is
contained in the normaliser~$N$ of a Cartan subgroup~$C$, but not
contained in the Cartan itself, where $N/C$ cuts out the quadratic
extension $K(\sqrt{d})/K$.  By hypothesis the projective image is
not~$C_2\times C_2$, so this is true for a unique pair $(N,C)$.  Hence
the non-trivial quadratic extension cut out by $N/C$ must also be the
CM extension $K(\sqrt{-1})$; in particular, $\sqrt{-1} \not\in K$.
Hence $L = K(\sqrt{d})=K(\sqrt{-1})$,
proving the claim.

%Thus the only way in which the two curves could be quadratic twists is
%when $-1\notin(K^*)^2$ and they are $-1$-twists of each other.  This
%is always possible when $-1\notin(K^*)^2$, since $E_{-4a}$ and $E_a$
%are quadratic twists, and also $2$-isogenous and hence have ismorphic
%mod~$p$ representations for all odd~$p$.

We now consider two cases:

(i) Assume $a_1/a_2 = d^2$ with $d\in K^*$. If $d$ is a square in~$K$
then the curves are isomorphic.  Otherwise, by the claim, they are
quadratic twists by~$L=K(\sqrt{d})=K(\sqrt{-1})$.  But then
$-d\in(K^*)^2$, so $a_1/a_2=(-d)^2\in(K^*)^4$, and again the curves
are isomorphic over~$K$.  So if $a_1/a_2$ is a square in~$K$, then it must in
fact be a $4$th power.

(ii) Assume $a_1/a_2$ is not a square in~$K$.  Let $m=\sqrt{a_1/a_2}$
and set $L=K(m)$. Thus $a_1/a_2 = m^2$ with $m \in L$ and $E_{a_1}$ is
isomorphic to~$E_{a_2}$ over~$L(\sqrt{m})$.  Since $E_{a_1}[p]\cong
E_{a_2}[p]$ as $G_L$-modules, and the projective image $\rhobar_{E_{a_1},p}(G_L)$
has order greater than~$4$, by part (i) over~$L$ we conclude that the
curves are in fact isomorphic over~$L$.  Since $L$ is a quadratic
extension of~$K$, the claim gives $L=K(\sqrt{-1})$.  From the discussion preceding the theorem, we have
$E_{a_2}\cong E_{a_1}^{-1} \cong E_{-4a_1}$, so $a_1/a_2 = -4$ (modulo
4th powers).
%%
%% Clearly, in case (i) we have $a_1/a_2 = 1$ modulo 4th powers, as the curves are isomorphic over~$K$.
%% Suppose we are in case (ii).
%% Since
%% $L=K(\sqrt{a_1/a_2})=K(\sqrt{-1})$ we have that $a_1/a_2$ is minus a square, say
%% $a_1/a_2=-4s^2$ with $s\in K$.  Also $a_1/a_2\in(L^*)^4$, so
%% $s^2=t^4$ with $t\in L$; here we use the fact noted above that $-4$ is
%% a $4$th power in $K(\sqrt{-1})$.  Hence $\pm s=t^2$ is a square in~$L$
%% but not in~$K$. But~$L=K(\sqrt{-1})$, {\bf so $\pm s$ is a square in~$K$
%% also}, so $a_1/a_2$ is indeed $-4$ times a $4$th power in~$K$.
\end{proof}

\subsection{Mod $7$ isomorphisms between elliptic curves with
$j$-invariant~$0$} We will show that for every elliptic curve~$E$ with
$j(E)=0$, there are three non-trivial sextic twists of~$E$ with
isomorphic mod-$7$ Galois representations, one symplectic and two
anti-symplectic.

Every elliptic curve with $j=0$ has a model of the form
$E_b:\ Y^2=X^3+b$ with $b$ nonzero, and the isomorphism class of $E_b$
depends only on $b$ modulo $6$th powers.  Any two such curves are
sextic twists of each other: the sextic twist of $E_b$ by $u$ is
$E_{bu}$, which is isomorphic to $E_b$ if and only if $u$ is a $6$th
power.  We will prove the following:

\begin{theorem}\label{T:j=0}
For all $b \in \Q^*$, the elliptic curves $E_b$ and $E_{-28/b}$ have
symplectically isomorphic mod-$7$ Galois representations.
\end{theorem}

\begin{remark}Although we will take the base field to be $\Q$ here,  Little 
change would be required in what follows if $\Q$ were to be replaced
by any field of characteristic different from~$2$, $3$ or $7$ in which
$-3$ is not a square.  In case $-3$ is a square there is some
simplification, and a similar result holds.
\end{remark}

We fix some notation. Let $K=\Q(\r3)=\Q(\w)$ where $\w$ satisfies
$\w^2+\w+1=0$, so that $\w$ is a primitive $3$rd root of
unity and $-\w$ a primitive $6$th root of unity.  The
curves $E_b$ have CM by the maximal order~$\OO_K=\Z[\w]$ in which
$7$ splits as $7=\pi\pibar$ where $\pi=3\w+2$.  Set
$\r3=2w+1$ (to fix the sign).  We denote the nontrivial
automorphism of $K/\Q$ by $x\mapsto x'$.

Fix $b\in\Q^*$ defining the elliptic curve $E_b: Y^2=X^3+b$.  The
$2$-dimensional $\F_7$-vector space~$E_b[7]$ has two $K$-rational
one-dimensional subspaces, namely the kernels of the endomorphisms
$[\pi]$ and $[\pibar]$, which we make explicit.

Define
\begin{align}
\alpha&=4b/\pibar,\\
\beta=\alpha+b&=-\w^2\r3^3b/\pibar,\quad\text{and}\\
\gamma&=-4\r3^3b/\pibar = -\r3^3\alpha = 4\w\beta.
\end{align}
Note that, for any choice of roots~$\alpha^{1/3}$ and~$\beta^{1/2}$, the point $(\alpha^{1/3},\beta^{1/2})$ is 
in~$E_b(\Qbar)$.  We fix one $6$th 
root~$\gamma^{1/6}$ once and for all
and set
\begin{align}
\alpha^{1/3} &= \gamma^{1/3}/\r3,\\
\beta^{1/2} &= \gamma^{1/2}\w/2
\end{align}
(with $\gamma^{1/3}=(\gamma^{1/6})^2$ and $\gamma^{1/2}=(\gamma^{1/6})^3$).  Let
$P=(\alpha^{1/3},\beta^{1/2})\in E_b(\Qbar)$.

Computing the $7$-division polynomial of~$E_b$, we find that over
$\Q(b)$ (treating $b$ as an indeterminate) it has factors $X^3-\alpha$
and $X^3-\alpha'$, the remaining factor of degree~$18$ being
irreducible.  It follows that $P$ and the conjugate point
$P'=(\alpha'^{1/3},\beta'^{1/2})$ have order~$7$.  Also, the multiples
$kP$ for $1\le k\le6$ all have $x(kP)^3=\alpha$ (this can be checked
by direct calculation, or by observing that $x(2P)^3=\alpha'$ yields a
contradiction after repeating three times since $8P=P$).

Thus the $7$-division field of~$E_b$ is
$L=K(E_b[7])=K(P,P')=K(\gamma^{1/6},\gamma'^{1/6})$.

\begin{lemma}In all cases, $\gamma$ and~$\gamma'$ are independent in
  $K^*/K^*{}^2$.  They are independent in $K^*/K^*{}^3$ unless
  $b=2\cdot7^2\cdot c^3$ with~$c\in\Q^*{}^3$, in which case
  $\gamma\gamma'=(-42c)^3$ and they generate a subgroup of $K^*/K^*{}^3$
  of order~$3$.

In the first case we have $\Gal(L/K)\cong(\Z/6\Z)^2$.  In the second
case, $\Gal(L/K)\cong(\Z/6\Z)\times(\Z/2\Z)$.
\end{lemma}
\begin{proof}
Elementary.
\end{proof}
Note that $b=2\cdot7^2\cdot c^3 = 98c^3\implies -28/b=98(-7c)^3$, so the situation is
symmetric between $E_b$ and $E_{-28/b}$.  In this case, the curves
$E_b$ and $E_{-28/b}$ are not just sextic twists but quadratic twists
by $-7$, since $-28/b^2=(-7)^3/c^6$.

We now assume that we are not in the special case (where $b/98$ is a
cube), so that $\Gal(L/K)\cong(\Z/6\Z)^2$.  We will define generating
automorphisms~$\sigma_1$, $\sigma_2\in\Gal(L/K)$, each of order~$6$,
together with an automorphism~$\tau$ of order~$2$ in $\Gal(L/\Q)$ such
that $\Gal(L/\Q)=\left<\sigma_1,\sigma_2,\tau\right>$.

Fix one value of $\gamma^{1/6}$ arbitrarily.  Let $\tau\in\Gal(L/\Q)$
be an element of order~$2$ restricting to the non-trivial element of
$\Gal(K/\Q)$.  Then $(\tau(\gamma^{1/6}))^6=\tau(\gamma)=\gamma'$, so
we may fix the value of $\gamma'^{1/6}$ by setting
$\gamma'^{1/6}=\tau(\gamma)$.  Now by independence of $\gamma^{1/6}$
and $\gamma'^{1/6}$ there exists $\sigma_1\in\Gal(L/K)$ fixing
$\gamma'^{1/6}$ and mapping $\gamma^{1/6}\mapsto-w\gamma^{1/6}$ (recall
that $-w$ is a primitive $6$th root of unity) and also
$\sigma_2\in\Gal(L/K)$ fixing $\gamma^{1/6}$ and mapping
$\gamma'^{1/6}\mapsto-w^2\gamma'^{1/6}$.

Both $\sigma_1$ and~$\sigma_2$ multiply $(\gamma/\gamma')^{1/6}$ by
the same $6$th root of unity, $-w$.  Note that
$\gamma/\gamma'=-\pi/\pibar$; one may check that
$K((\gamma/\gamma')^{1/6})=K(\zeta_7)$, and that both $\sigma_1$ and
$\sigma_2$ map $\zeta_7$ to $\zeta_7^3$.  (The image must be either
$\zeta_7^3$ or $\zeta_7^5$ since $3$ and $5$ are the primitive roots
modulo~$7$.)

Recall that $P=(\alpha^{1/3},\beta^{1/2})\in E_b(K(\gamma^{1/6}))$ is
fixed by our choice of $\gamma^{1/6}$.  We similarly have
$P'=(\alpha'^{1/3},\beta'^{1/2})\in E_b(K(\gamma'^{1/6}))$, and~$\tau$
interchanges these.  Hence we have
\[
   \rho_{E_b,7}(\tau) = \begin{pmatrix}0&1\\1&0   \end{pmatrix}.
\]


Now $\sigma_1$ fixes~$P'$, while one may see that $\sigma_1(P)=3P$
(for example the standard formulas for adding points show that
$-2P=(w^{-5}\alpha^{1/3},\beta^{1/2})=\sigma_1^5(P)$); this also
follows from the action on the $7$th roots of unity noted above, which
implies that the determinant of the matrix giving the action of
$\sigma_1$ on $\left<P,P'\right>$ is $3\pmod7$.  This matrix is
therefore
\[
   \rho_{E_b,7}(\sigma_1) = \begin{pmatrix}3&0\\0&1   \end{pmatrix},
\]
and similarly
\[
   \rho_{E_b,7}(\sigma_2) = \begin{pmatrix}1&0\\0&3   \end{pmatrix}.
\]

Now we consider the effect of twisting~$E_b$ by $u=-28/b^2$.
Replacing $b$ by $ub=-28/b$ changes $\gamma$ into $(2\r3)^6/\gamma'$.
In fact if the sextic twist by~$u$ induces an isomorphism on the
$7$-torsion modules, this must have the effect of replacing $\gamma$
by $\gamma^{\pm1}$ or~$\gamma'^{\pm1}$, modulo $(K^*)^6$.  The only
solutions with $u\in\Q^*$ are $u=1$ and $u=-28/b^2$; taking into
account the fact that $\ker(\Q^*/(\Q^*)^6\to K^*/(K^*)^6) =
\{1,-27\}$, the solutions modulo~$(\Q^*)^6$ are~$\{1,-27,-28/b^2,
27\cdot28/b^2\}$.

Hence the twist by~$u=-27/b^2$ leaves the $7$-division field
$K(\gamma^{1/6},\gamma'^{1/6})$ unchanged.

The twisting map~$\tw$ takes $(x,y)\in E_b$ to $(u^{1/3}x,u^{1/2}y)\in
E_{bu}$.  Again we need to fix the roots.  We set
$u^{1/6}=2\r3/(\gamma^{1/6}\gamma'^{1/6})$, then
$u^{1/3}=-12/(\gamma^{1/3}\gamma'^{1/3})$ and
$u^{1/2}=8\r3^3/(\gamma^{1/2}\gamma'^{1/2})$.  Hence
\[
 \tw(P) = (u^{1/3}\alpha^{1/3},u^{1/2}\alpha^{1/2}) =
(4\r3/\gamma'^{1/3},-4w\r3^3/\gamma'^{1/2}),
\]
which is fixed by~$\sigma_1$ and taken to $3$ times itself
by~$\sigma_2$.  Similarly, $\sigma_2$ fixes $\tw(P')$ and
multiples~$\tw(P)$ by~$3$.

Now $\tau$ fixes $u^{1/3}$ and negates $u^{1/2}$. A simple calculation
then gives $\tau(\tw(P)) = -\tw(P')$.

Now define $\phi: E_b[7] \to E_{bu}[7]$ by $P\mapsto\tw(P')$,
$P'\mapsto-\tw(P)$.  Then $\phi$ commutes with the action of
$\sigma_1$, $\sigma_2$ and~$\tau$, so is an isomorphism of
$G_\Q$-modules.  It is also symplectic:  denoting the Weil pairing by
$e_7$ we have
\[
e_7(\phi(P),\phi(P')) = e_7(\tw(P'),-\tw(P)) = e_7(P',-P) =
e_7(P',P)^{-1} = e_7(P,P'),
\]
where we have used the fact that $\tw$, being an isomorphism defined
over $\overline{\Q}$ preserves the Weil pairing.

This completes the proof that $E_b[7]$ and $E_{-28/b}[7]$ are
isomorphic as symplectic $G_{\Q}$-modules in the case where $b\notin
2\cdot7^2\cdot \Q^*{}^3$.


\begin{remark}
The fixed field of $\sigma_1\sigma_2$ is $K(\zeta_7)=\Q(\zeta_{21})$.
One may check that this is the field of definition of the full set of
$7$-isogenies of $E_b$: this is consistent with $\sigma_1\sigma_2$
having trivial image in $\PGL(2,\F_7)$.
\end{remark}

To complete the proof of Theorem~\ref{T:j=0}, assume that $b/98$ is a
cube.  Now we take $u=-7^3$, so the sextic twist by~$u$ is just the
quadratic twist by $-7$.  We fix $\gamma^{1/6}$ and $\gamma'^{1/6}$
with $\tau(\gamma^{1/6})=\gamma'^{1/6}$ as before.

Since $\gamma\gamma'\in\Q^*{}^3$, any $\sigma\in\Gal(L/K)$
maps~$\gamma^{1/6}$ to $\zeta_6^r\gamma^{1/6}$ and~$\gamma'^{1/6}$ to
$\zeta_6^s\gamma^{1/6}$ where $(r,s)\in(\Z/6\Z)^2$ satisfy
$r+s\equiv0\pmod3$.  (Here $\zeta_6=-w$.) So $\Gal(L/K)$ is isomorphic
to a subgroup of index~$3$ in~$(\Z/6\Z)^2$.  As generators we may take
$\sigma_1$ of order~$6$ mapping to $(1,-1)$, and $\sigma_2$ of
order~$2$ mapping to $(0,3)$.  Then the computations carried out for
the generic case give
\[
   \rho_{E_b,7}(\sigma_1) = \begin{pmatrix}3&0\\0&3   \end{pmatrix},
\]
and
\[
   \rho_{E_b,7}(\sigma_2) = \begin{pmatrix}1&0\\0&-1   \end{pmatrix}.
\]

The twist map takes $(x,y)\mapsto(-7x,\sqrt{-7}^3y)$ and we find that
all three of $\sigma_1$, $\sigma_2$ and~$\tau$ map $\sqrt{-7}$ to
$-\sqrt{-7}$.  For this one may use the classical formula
\[
   \sqrt{-7} = \sum_{k\pmod7}\legendre{k}{7}\zeta_7^k.
\]
The same definition of~$\phi$ as in the generic case gives a
symplectic Galois isomorphism here, completing the proof.

\begin{corollary}
For every $b\in\Q^*$ the curves $E_{-27b}$ and $E_{27\cdot28/b}$ have
mod~$7$ Galois representations which are antisymplectically isomorphic
to that of~$E_b$.

If $E_b[7]$ and $E_{b'}[7]$ are isomorphic then $b'\in\{b,-28/b, -27b,
27\cdot28/b\}$ (modulo sixth powers) and these values are distinct.
Hence for each elliptic curve $E/\Q$ with $j(E)=0$, there are
precisely three curves $E'/\Q$ with $j(E')=0$, excluding $E$ itself,
with isomorphic $7$-torsion.
\end{corollary}
\begin{proof}
Although one can show that $E_b$ and $E_{-27b}$ are antisymplectically
isomorphic using the same methods as used for Theorem~\ref{T:j=0}, it
is easier to note that the curves $E_b$ and~$E_{-27b}$ are
$3$-isogenous; since $3$ is a non-quadratic residue of~$7$, a
$3$-isogeny between them induces an anti-symplectic isomorphism
between their $7$-torsion modules. Alternatively, these curves are
quadratic twists by~$-3$, and the conclusion also follows from
Theorem~\ref{T:Cartan} and Remark~\ref{R:CM}.

The last part follows from the proof of Theorem~\ref{T:j=0}.
\end{proof}

%\begin{remark} Over a field where $-3$ is a square, the curves $E_b$
%and $E_{-27b}$ in the previous remark are even isomorphic, and the
%$3$-isogeny is the endomorphism $\pm\r3$.  \end{remark}

\section{Auxiliary results for the reducible case}

Some of the mod~$7$ congruences 
$E[7] \simeq E'[7]$ in the LMFDB database occur 
when these Galois modules are reducible. Compared to the irreducible case, establishing reducible congruences requires extra work because when working with the semisimplifications $E[7]^{ss}$ and $E'[7]^{ss}$ important information is lost.
The objective of this section is to establish Theorem~\ref{T:reducible} which will allow us to rigorously prove congruences in the reducible case.


Let $B \subset \GL_2(\F_p)$ be the Borel subgroup, i.e. the upper triangular matrices. Let $H \subset B$ be a subgroup of order divisible by~$p$. 
We can write~$H = D\cdot U$ where $D \subset B$ is a subgroup of diagonal matrices and 
$U$ is cyclic generated by $\left(\begin{smallmatrix}
                            1 & 1 \\
                            0 & 1
                            \end{smallmatrix} \right)$.   
Moreover, $U$ a normal subgroup of~$H$ 
and we write $\pi : H \to H/U \simeq D$ for the quotient map.

\begin{proposition} \label{P:inner}
Let $H = D \cdot U \subset B$ and $\pi$ be as above. 
Let $\phi$ be an automorphism of~$H$. Assume that  
$\pi(x) = \pi(\phi(x))$ for all $x \in H$. 

Then $\phi$ is given by conjugation in $B$, i.e. there is $A \in B$ such that $\phi(x) = AxA^{-1}$. 
\end{proposition}
\begin{proof}
Let $x \in H$ and write it as $x = du$ with $d \in D, u \in U$.
Note that $U$ is the unique normal subgroup with order~$p$, so 
$\phi(U) = U$ and $\phi(D)=D$ for all $\phi \in \Aut H$.
By hypothesis, we have 
\[
 \pi(x) = \pi(\phi(x)) = \pi(\phi(d))\pi(\phi(u)) \iff dU = \phi(d)U
 \iff d\phi(d)^{-1} \in U.
\]
Since $d, \phi(d) \in D$ we have $d\phi(d)^{-1} \in D \cap U = \{ I_2\}$ therefore $d\phi(d)^{-1} = I_2$, where $I_2$ is the identity in $\GL_2(\F_p)$.
Thus $d = \phi(d)$ and we conclude that any $\phi$ 
as in the statement is the same as an automorphism of~$U$ (extended to~$H$ by $\phi(d)=d$ for all $d\in D$). 

Write $N_B(U)$  for the normaliser of $U$ in $B$ and $C_B(U)$ for its centralizer. 
We have $N_B(U) = B$ 
and $C_B(U)$ are the matrices of the form $\left(\begin{smallmatrix}
                            \lambda & b \\
                            0 & \lambda
                            \end{smallmatrix} \right)$
with $\lambda \neq 0$. Thus $\# N_B(U)/C_B(U) = p-1$. 
Since  we also have 
\[
 N_B(U)/C_B(U) \hookrightarrow \Aut U \simeq \F_p^*
\]
it follows that $\Aut U \simeq N_B(U)/C_B(U)$, as desired.
\end{proof}

\begin{proposition} \label{P:fieldF}
Let $p > 2$ be a prime. Let $E/K$ be an elliptic curve such that 
$\rhobar_{E,p}$ is reducible. Assume there is an element of order~$p$ 
in the image of~$\rhobar_{E,p}$. 

Then, there is a field $F \supset K$ such that $[F : K] = p$ and $E$ acquires a 
second isogeny over~$F$.
\end{proposition}
\begin{proof} We can choose a basis of $E[p]$ where
\[
\rhobar_{E,p} =  \begin{pmatrix}
                            \chi& h \\
                            0 & \chi'
                            \end{pmatrix}.
\]

Let $H$ be the set of elements $\sigma \in  G_K$ such 
that $h(\sigma) = 0$. Since $\rhobar_{E,p}$ is a homomorphism it follows 
that $H$ is a subgroup of $G_K$. 
We let $F \subset K(E[p])$ to be the field fixed by $H$.
Since there is an element of order~$p$ in the image of~$\rhobar_{E,p}$ and 
$\left(\begin{smallmatrix}
                            \chi & 0 \\
                            0 & \chi'
                            \end{smallmatrix} \right)$
as order coprime to~$p$, 
it follows that $[F : K] =p$.
\end{proof}


\begin{theorem} \label{T:reducible}
Let $p > 2$ be a prime. Let $E_1, E_2$ be elliptic curves 
over~$K$ such that 
\begin{itemize}
 \item[(i)] $\rhobar_{E_1,p}^{ss} \simeq \rhobar_{E_2,p}^{ss} \simeq \chi \oplus \chi'$,  where $\chi, \chi' : G_K \to \F_p^*$ are characters;
 \item[(ii)] both $\rhobar_{E_1,p}$ and $\rhobar_{E_2,p}$ have an element of
 order~$p$ in the image.
\end{itemize}
After replacing $E_2$ by a $p$-isogenous curve if necessary, we have 
$\rhobar_{E_1,p} \simeq \rhobar_{E_2,p}$ 
if and only if $F_1 \simeq F_2$
where $F_i/K$ is a degree~$p$ extension where $E_i$ acquires a second isogeny
as given by Proposition~\ref{P:fieldF}.
\end{theorem}
\begin{proof} Clearly, 
if $\rhobar_{E_1,p} \simeq \rhobar_{E_2,p}$ 
then $F_1 \simeq F_2$. We now prove the opposite direction.

From (i) it follows that $\rhobar_{E_i,p}$ is reducible and that, after replacing $E_2$ by a $p$-isogenous curve if necessary (to swap 
$\chi$ with $\chi'$), 
we have 
\[
\rhobar_{E_i,p} =  \begin{pmatrix}
                            \chi & h_i \\
                            0 & \chi'
                            \end{pmatrix} \quad \text{ with } \quad  h_i : G_K \to \F_p.  
\]
Let $L$ be the field cut out 
by $\chi \oplus \chi'$. 
It follows from (ii) that $h_i|_{G_L} \neq 0$ 
hence the matrix $\left(\begin{smallmatrix}
                            1 & 1 \\
                            0 & 1
                            \end{smallmatrix} \right)$  
is in the image of $\rhobar_{E_i,p}$ for $i=1,2$.
                            
Write $K_i = K(E_i[p])$. 
We have $[K_i : K] = [K_i : L][L : K] = p [L : K]$. 
Since the degree $[L : K]$ divides $(p-1)^2$ it is coprime 
to $p = [F_i : K]$ therefore we have $K_i = L F_i$.

Suppose $F_1 \simeq F_2$. Since $K_1$ is Galois, we have $F_2 \subset K_1$ and therefore $K_p := K_1 = K_2$ is the field cut out by both
$\rhobar_{E_1,p}$ and $\rhobar_{E_2,p}$, i.e. these representations have the same kernel.

Write $G = \Gal(K_p / K)$. From now on we think of $\rhobar_{E_i,p}$ as an injective representation of~$G$. Note that the images of $\rhobar_{E_1,p}$ and $\rhobar_{E_2,p}$
is the same subgroup~$H$ of the Borel.

All the elements in $H$ are of the form $\rhobar_{E_2,p}(\sigma)$ for $\sigma \in G$, so we can consider the map $\phi = \rhobar_{E_1,p} \circ \rhobar_{E_2,p}^{-1} : H \to H$. It is an automorphism of~$H = D\cdot U$ satisfying the hypothesis of Proposition~\ref{P:inner}, where $D$ are 
the matrices $\left(\begin{smallmatrix}
                            \chi & 0 \\
                            0 & \chi'
                            \end{smallmatrix} \right)$.  
Then, $\phi$ is given by conjugation, that is
\[
 \phi(\rhobar_{E_2,p}(\sigma)) = A \rhobar_{E_2,p}(\sigma) A^{-1}.
\]
Since we also have
\[ 
\phi(\rhobar_{E_2,p}(\sigma)) 
=  \rhobar_{E_1,p} \circ \rhobar_{E_2,p}^{-1}(\rhobar_{E_2,p}(\sigma)) = \rhobar_{E_1,p}(\sigma)
\]
we conclude that $\rhobar_{E_1,p}(\sigma) = A \rhobar_{E_2,p}(\sigma) A^{-1}$, as desired.
\end{proof}

\section{Finding congruences and determining their symplectic type}\label{S:statistics}

In this section we discuss our systematic study of mod~$p$ congruences
between elliptic curves in the LMFDB database.  As of April 2019, this
database contains all elliptic curves defined over~$\Q$ of
conductor~$N\le\numprint{400000}$, as computed by the first author
using the methods of~\cite{AMEC}; there are $\numprint{2483649}$
curves, in $\numprint{1741002}$ isogeny classes.

\textbf{We should perhaps insert a reference to \cite{FisherList}
  which lists 11-congruences for conductors up to 130,000, up to twist
  and isogeny.}

Recall first that isogenous curves have mod~$p$ representations which
are isomorphic up to semisimplification, and actually isomorphic if
the degree of the isogeny is not divisible by~$p$.  Secondly, two
representations have isomorphic semisimplification if and only if they
have the same traces, so that we can test this condition by testing
whether
\[ a_{\ell}(E)\equiv a_{\ell}(E')\pmod{p}
\quad \text{for all primes } \ell \nmid pNN',
\] 
where $N$ and $N'$ are the conductors of $E$
and~$E'$ respectively.  This test can very quickly establish rigorously
that two curves do \emph{not} have isomorphic $p$-torsion up to
semisimplification, by finding  a single
prime~$\ell$ such that $a_{\ell}(E)\not\equiv a_{\ell}(E')\pmod{p}$.
Moreover, it is possible to prove that two curves have isomorphic $p$-torsion up to
semisimplification using this test for a finite number of
primes~$\ell$, as we explain in Step 2 below.

We divide our procedure to determine all mod~$p$ congruences between
non-isogenous curves, and their symplectic type, for a fixed
prime~$p$, into five steps.  We first outline the steps, and then
consider each in detail in the following subsections.
\begin{enumerate}[1.]
\item Partition the set of isogeny classes of elliptic curves in LMFDB
  into subsets~$S$, such that whenever two curves have mod~$p$
  representations with isomorphic semisimplifications, their isogeny
  classes belong to the same subset~$S$, but not necessarily
  conversely.
\item For each subset~$S$ prove that the curves in each isogeny class in~$S$ really
  do have isomorphic mod~$p$ representations up to
  semisimplification, if necessary further partitioning the subsets.
  Discard all ``trivial'' subsets of size~$1$.
\item Separate the remaining subsets resulting from the previous
  step into those which have irreducible mod~$p$ representations and
  the reducible ones.
\item For each irreducible subset~$S$, and each pair of isogeny
  classes in~$S$, pick curves $E$ and~$E'$, one from each class in the
  pair; determine the symplectic type of the triple~$(E,E',p)$; then
  use the isogeny criterion to partition the set of all the curves in
  all the isogeny classes in~$S$ into one or two parts such that curves
  in the same part are symplectically isomorphic while those in
  different parts are antisymplectically isomorphic.
\item For each reducible subset~$S$, determine whether, for each pair
  $E$, $E'$ chosen as in Step 4, there is an isomorphism between
  $E[p]$ and $E'[p]$ and not just between their semisimplifications,
  if necessary replacing $E'$ with the curve $p$-isogenous to it.  If
  not, this means that $E[p]$ and $E'[p]$ are not in fact isomorphic.
  Thus we further partition each reducible set $S$ into subsets of
  isogeny classes of curves whose mod~$p$ representations are actually
  isomorphic, not just up to semisimplification.  For each of these
  new subsets, if nontrivial, proceed as in Step~4.

\end{enumerate}
Next we will explain each step in further detail.  For the first three
steps, $p$ is arbitrary, and we have carried these steps out for $7\le
p\le97$.  According to Theorem~\ref{T:cong19} below, no congruences
(other than those induced by isogenies) exist for larger~$p$.  For the
last two steps, we restrict to $p=7$ which is the most interesting
case, as remarked in the Introduction.


\subsection{Sieving}
In order that $E[p]\cong E'[p]$ up to semisimplification, it is
necessary and sufficient that for all primes~$\ell$ not dividing
$pNN'$ we have $a_{\ell}(E)\equiv a_{\ell}(E')\pmod{p}$.  In this step
we may take one curve from each isogeny class, since isogenous curves
have the same traces~$a_\ell$, and have mod~$p$ representations with
isomorphic semisimplifications.

Fix an integer~$B\ge1$.  Let $\calL_B$ be the set of the $B$ smallest
primes greater than $\numprint{400000}$. All curves in the database
have good reduction at each prime in~$\calL_B$.  Assume also $B$ is
large enough that $p\notin\calL_B$.  Hence a necessary condition for
two curves $E$ and $E'$ in the database to be congruent mod~$p$ is
that $a_{\ell}(E)\equiv a_{\ell}(E')\pmod{p}$ for all~$\ell\in\calL_B$.

To each curve $E$ in the database we assign a ``hash value'' which is
a simple function of the set $\{a_{\ell}(E)\pmod{p}\mid
\ell\in\calL_B\}$.  For example we may enumerate
$\calL_B=\{\ell_0,\ell_1,\dots,\ell_{B-1}\}$ and use the integer value
$\sum_{i=0}^{B-1}\overline{a}_{\ell_i}(E)p^i$, where for $a\in\Z$,
$\overline{a}$ denotes the reduction of $a$ mod~$p$ which lies in
$\{0,1,\dots,p-1\}$.  Curves whose mod~$p$ representations are
isomorphic up to semisimplification will have the same hash, and we
may hope that clashes will be rare if $B$ is not too small.

We proceed to compute this hash value for one curve in each isogeny
class in the database, recording the curve's label in a list indexed
by the different hash values encountered.  At the end of this step we
can easily form a partition of the set of isogeny classes by taking
these lists for each hash value.  We then discard any such lists which
are singletons.  Using $B=40$, this process takes approximately 40
minutes for a single prime~$p$.  Note, however, that as most of the
computation time taken is in computing $a_{\ell}(E)$ for all
curves~$E$ (up to isogeny), it is more efficient to compute the hash
values for several primes in parallel.

{\bf Example.} After carrying out this step for $7\le p\le17$, using
$B=40$, we find: $\numprint{20138}$ nontrivial subsets for $p=7$;
$635$ for $p=11$; $150$ for $p=13$; and~$8$ for $p=17$.  There are no
nontrivial subsets for any primes~$p$ with $19\le p\le97$, so we can
immediately conclude that there are no congruences in the database
between non-isogenous curves modulo any prime in this range.  See also
Theorem~\ref{T:cong19} below.

\subsection{Proving isomorphism up to semisimplification}

For each pair of isogeny classes within one subset obtained in the
previous step, we use a criterion of Kraus--Oesterl\'e (see
\cite[Proposition~4]{KO}), based on the Sturm bound and hence on the
modularity of elliptic curves over~$\Q$, to either prove isomorphism
up to semisimplification, or reveal a ``false positive''.  The latter
would happen if two curves which are not congruent mod~$p$ have traces
of Frobenius~$a_{\ell}$ which are congruent modulo~$p$ for
all~$\ell\in\calL_B$.

{\bf Example (continued).}  For $7\le p\le17$ we find no such false
positives, so the curves within each subset do have mod~$p$
representations which are genuinely isomorphic up to
semisimplification.

\begin{remark}
  To avoid false positives, it is necessary to use a value of $B$
  which is at least~$36$, for the following reason.  The curves with
  labels \lmfdbec{25921}{a}{1} and \lmfdbec{78400}{gw}{1} have traces
  $a_{\ell}$ which are \emph{equal for all~$\ell\in\calL_{35}$}, that
  is, for all~$\ell$ with $400000\le \ell<400457$ (though not for
  $\ell=400457$).  These curves have CM by the order of
  discriminant~$-7$, and are quadratic twists by~$230$; both have
  $a_\ell=0$ for all $\ell\equiv3,5,6\pmod{7}$, and $230$ is a
  quadratic residue modulo all other primes in~$\calL_{35}$. In our
  first computational runs, we used $B=30$ and discovered this pair of
  curves giving rise to a false positive for every~$p$.
\end{remark}

The sizes of the subsets of isogeny classes we find after the first
two steps are as follows: for $p=7$ the~$\numprint{20138}$ subsets
have sizes between~$2$ and~$76$; for $p=11$, $p=13$ and $p=17$ they
all have size~$2$.


\subsection{Testing reducibility}
For each set of isogeny classes of curves obtained in the previous
step, we next determine whether the curves in the set have irreducible
or reducible mod~$p$ representations.  To do this we apply a standard
test of whether an elliptic curve admits a rational $p$-isogeny.  For
the curves in the database this information is already known.

{\bf Example (continued).} For $p=7$, of the $\numprint{20138}$
nontrivial sets from Step~2, we find that $\numprint{19883}$ are
irreducible, {\it i.e.}\@ consist of curves whose mod~$7$
representations are irreducible, while $255$ are reducible.

The irreducible sets have size at most~$5$.  In detail, there are
$\numprint{18334}$ sets of size~2; $\numprint{1297}$ sets of size~3;
246 sets of size~4; and 6 sets of size~5.

The reducible sets have size up to~$76$.  In Step~5 below we will
further partition these sets after testing whether the curves are
actually congruent mod~7 (not just up to semisimplification), after
which the largest subset has only~$4$ isogeny classes.

%% Reducible {2: 86, 3: 67, 4: 31, 5: 26, 7: 7, 10: 6, 6: 5, 8: 5, 9: 4, 19: 4, 11:
%%   3, 16: 2, 18: 2, 32: 1, 35: 1, 76: 1, 13: 1, 14: 1, 45: 1, 36: 1}

For $p=11, 13$, and~$17$, all the nontrivial subsets are of size~$2$,
and all are irreducible.

\subsection{Distinguishing symplectic from antisymplectic: irreducible case}
After the previous step we have a collection of sets of isogeny
classes, such that for each pair of curves $E$, $E'$ taken from
isogeny classes in each set, the $G_{\Q}$-modules $E[p]$ and $E'[p]$
are isomorphic and irreducible. Moreover, from
Proposition~\ref{P:auto} we know that all isomorphisms $\phi : E[p]
\simeq E'[p]$ have the same symplectic type. We wish to determine
whether this type is symplectic or anti-symplectic.  We may assume
that $E$ and~$E'$ are not isogenous, as otherwise we may simply apply
the isogeny criterion.

The local criteria of \cite{FKSym} suffice to determine the symplectic
type for all the mod~$p$ congruences found in the database for $p=7$
and $p=11$ (and also for $p=13, 17$), but this does not have to be
the case as discussed in Section~\ref{S:motivation} (see
\cite[Proposition~16]{FKSym} for an example with $p=3$ where the local
methods fail).  Therefore, we will now describe a procedure, using the
modular curves~$X_E(7)$, to obtain a method that works in all cases.
We will use the modular parametrizations and explicit formulae of
Kraus--Halberstadt~\cite{Halberstadt-Kraus-XE7},
Poonen--Schaefer--Stoll~\cite{PSS}, and as extended and completed by
Fisher~\cite{Fisher}.

In~\cite{Halberstadt-Kraus-XE7}, Halberstadt and Kraus give an
explicit model for the modular curve $X_E(7)$, for any elliptic curve
$E$ defined over a field~$K$ of characteristic not equal to $2$, $3$
or~$7$. Recall that the $K$-rational points on $X_E(7)$ parametrize
pairs $(E',\phi)$ where $E'$ is an elliptic curve defined over~$K$ and
$\phi:E[7]\to E'[7]$ is a symplectic isomorphism of $G_K$-modules; we
identify two such isomorphisms~$\phi$ when one is a scalar multiple of
the other.

The model for $X_E(7)$ given in \cite{Halberstadt-Kraus-XE7} is a
plane quartic curve, a twist of the classical Klein quartic~$X(7)$,
given by an explicit ternary quartic form~$F_{a,b}(X,Y,Z)$ in
$\Z[a,b][X,Y,Z]$ where $E$ has equation $Y^2=X^3+aX+b$.  The $24$
flexes on $X_E(7)$ are the cusps, that is, they are the poles of the
rational function of degree~$168$ giving the map $j:X_E(7)\to
X(1)$.
%% The $28$ bitangents intersect $X_E(7)$ at the 56
%% points above $j=0$: these are the intersection points of $X_E(7)$ and
%% the curve of degree~$14$ defined by a covariant of~$F_{a,b}$.

The base point $P_E=[0:1:0]\in X_E(7)(K)$ corresponds to the pair
$(E,\id)$.  In \cite{Halberstadt-Kraus-XE7} one can also find explicit formulas
for the rational function $j:X_E(7)\to X(1)$ and for the elliptic curve~$E'$
associated with all 
but finitely many points $P=(x:y:z)\in
X_E(7)$. More precisely, 
explicit polynomials $c_4, c_6 \in \Z[a,b][X,Y,Z]$
of degree~$20$ and~$30$, respectively, are given and the curve $E'$ associated with (all but finitely many)~$P$ has model
\[Y^2=X^3-27c_4(P)X-54c_6(P).\]

The finitely many common zeros of $c_4$
and $c_6$ are the exceptions, which Kraus and Halberstadt treat only
incompletely.  However, in \cite{Fisher} one may find formulas for
four such pairs of polynomials~$(c_4,c_6)$, of which the first is the pair in
\cite{Halberstadt-Kraus-XE7}, and such that at each point $P\in
X_E(7)$ at least one pair $(c_4(P),c_6(P))\not=(0,0)$, thus supplying
us with a model for the associated elliptic 
curve~$E'$ at each point~$P$.

We make use of this model and formulas as follows, given curves $E$,
$E'$ with $E[7]\cong E'[7]$.  Using one curve~$E$ we write down the
model for $X_E(7)$.  Then we find all preimages (if any) of $j'=j(E')$
under the map $X_E(7)\to X(1)$.  While over an algebraically closed
field there are $168$ distinct preimages of each $j'$, except that the
ramification points $j=0$ and $j=1728$ have $56$ and $84$ preimages,
over $\Q$, by Theorem~\ref{T:Cartan} there are at most two, except
for $j'=0$ when there may be four.

If there are no preimages of~$j'$, we conclude that the isomorphism
$E[7]\cong E'[7]$ is not symplectic.  Otherwise, for each preimage
$P\in X_E(7)(\Q)$ we compute the curve associated to~$P$, which may be
a twist of~$E'$, and test whether it is actually isomorphic to $E'$.
If this holds for one such point~$P$ in the preimage of $j(E')$, then
the isomorphism between $E[7]$ and $E'[7]$ is symplectic.

A similar method may be applied to test for antisymplectic
isomorphisms, using another twist of $X(7)$ denoted $X_E^-(7)$, first
written down explicitly in \cite{PSS}, for which Fisher provides
explicit formulae for the $j$-map and $c_4,c_6$ as above
in~\cite{Fisher}.

We note that it is not necessary to apply both the symplectic and
antisymplectic tests to a triple $(E,E',7)$ if we know already that
$E[7]\cong E'[7]$ as $G_\Q$-modules, since one will succeed if and only if the other
fails (by Proposition~\ref{P:auto}).  However we did apply both
tests in our computations with the curves in the database as a test of
our implementation, verifying that precisely one test passes for each
pair.  We also checked that the results obtained for each pair using
the local criteria are the same, so that we can be confident in the
correctness of the results.

These tests have only been carried out using a single curve in each
isogeny class, since we know how to distinguish symplectic from
antisymplectic isogenies.  As a last step, we consider the full isogeny classes
to obtain, for each elliptic curve~$E$ in the database, the complete sets of all curves~$E'$ (non-isogenous to~$E$) which have
symplectically and anti-symplectically isomorphic $7$-torsion modules to~$E$.

The output of this step consists of, for each of the subsets resulting
from Steps~1--3, one or two sets of curves whose union is the set of
all curves in the isogeny classes in the subset.  All curves in the
same set have symplectically isomorphic 7-torsion modules; when there
are two sets, curves in different sets have antisymplectically
isomorphic 7-torsion.

{\bf Example (continued).}
Of the $\numprint{19883}$ non-trivial sets of isogeny classes with mutually
isomorphic irreducible mod~$7$ representations, we find that in
$\numprint{12394}$ cases all the isomorphisms are symplectic, while in the
remaining $\numprint{7489}$ cases antisymplectic isomorphisms occur.

Using the local criteria of \cite{FKSym} for $p=11, 13, 17$ we find:
for $p=11$, of the $635$ congruent pairs of isogeny classes, $446$ are
symplectic and $189$ are antisymplectic; for $p=13$, of the $150$
congruent pairs of isogeny classes, $88$ are symplectic and $62$ are
antisymplectic; for $p=17$, all of the $8$ congruent pairs of isogeny
classes are antisymplectic.

\begin{example}
Let $p=7$.  One of the subsets resulting from Steps 1--3 consists of
the pair of isogeny classes $\{\lmfdbec{344025}{bc}{1},
\lmfdbec{344025}{bd}{1}\}$.  Our test shows that
$\lmfdbec{344025}{bc}{1}$ and $\lmfdbec{344025}{bd}{1}$ are
symplectically isomorphic.  The isogeny class
$\lmfdbeciso{344025}{bc}$ contains two $2$-isogenous curves, while
class $\lmfdbeciso{344025}{bd}$ contains only one curve.  Since $2$ is
a quadratic residue mod~7, all three curves have symplectically
isomorphic 7-torsion, and hence Step~4 returns a single set
\[\{\lmfdbec{344025}{bc}{1}, \lmfdbec{344025}{bc}{2}, \lmfdbec{344025}{bd}{1}\}.\]
Another subset resulting from Steps 1--3 is
$\{\lmfdbec{100800}{gw}{1}, \lmfdbec{100800}{hc}{1}\}$.  The same
procedure results in the output of two sets of curves
\[
\{\lmfdbec{100800}{gw}{1}\}, \qquad \{\lmfdbec{100800}{hc}{1},
\lmfdbec{100800}{hc}{2}\},
\]
since our tests show that $\lmfdbec{100800}{gw}{1}$ and
$\lmfdbec{100800}{hc}{1}$ are antisymplectically isomorphic, and the
last two curves are $2$-isogenous.
\end{example}

\begin{example}
Consider the set of six elliptic curves
\[\{\lmfdbec{9225}{a}{1}, \lmfdbec{9225}{e}{1}, \lmfdbec{225}{a}{1},
\lmfdbec{225}{a}{2}, \lmfdbec{11025}{c}{1}, \lmfdbec{11025}{c}{2}\}\]
which form four
complete isogeny classes.  All have isomorphic mod~7 representations
with image the normaliser of a split Cartan subgroup.  The last four
curves all have $j$-invariant~$0$ and CM by $-3$.  The first two are
$-3$-twists of each other.

The general methods of Step~4 of this section split this set into two
subsets:
\[
  \{\lmfdbec{9225}{a}{1}, \lmfdbec{225}{a}{1},
  \lmfdbec{11025}{c}{1}\},\qquad \{\lmfdbec{9225}{e}{1},
  \lmfdbec{225}{a}{2}, \lmfdbec{11025}{c}{2}\}
\]
Curves $\lmfdbec{9225}{a}{1}$ and $\lmfdbec{9225}{e}{1}$ give a non-CM
example of  Theorem~\ref{T:Cartan}.  Curves  $\lmfdbec{225}{a}{1}$ and
$\lmfdbec{11025}{c}{1}$ are sextic (but  not quadratic or cubic) twists
and illustrate Theorem~\ref{T:j=0}.
\end{example}

\subsection{Distinguishing symplectic from antisymplectic: reducible
  case}

One additional complication arises in this case.  Indeed, from Steps
1--3 we have $E[7]^{\sss} \simeq E'[7]^{\sss}$ but this is
insufficient to conclude $E[7] \simeq E'[7]$ when these are reducible
$G_\Q$-modules.  To achieve this we will apply
Theorem~\ref{T:reducible} and its proof.

Recall that $E[7]$ is reducible if and only if $E$ admits a rational
$7$-isogeny.  Over $\Q$ there is only ever at most one $7$-isogeny,
since otherwise the image of the mod~$7$
representation~$\rhobar_{E,7}$ attached to~$E$ is contained in a split
Cartan subgroup of $\GL(2,\F_7)$, and this cannot occur over~$\Q$
(see~\cite[Theorem~1.1]{GL}).  Furthermore, it is well known that the
size of the $\Q$-isogeny class of~$E$ is either $2$, consisting of two
$7$-isogenous curves, or $4$, consisting of two pairs of $7$-isogenous
curves linked by $2$-{} or $3$-isogenies (but not both). Examples of
these are furnished by the isogeny classes \lmfdbeciso{26}{b},
\lmfdbeciso{49}{a}, and \lmfdbeciso{162}{b} respectively.

Fix an elliptic curve $E$ with $E[7]$ reducible. 
The image
of~$\rhobar_{E,7}$ has the form
\[
  \begin{pmatrix}\chi_1&*\\0&\chi_2  \end{pmatrix},
\]
where~$\chi_1, \; \chi_2 : G_{\Q}\to\F_7^*$ are characters and $*$
(the upper right entry) is non-zero by the previous
discussion. Moreover, the product $\chi_1\chi_2$ is the cyclotomic
character, so in particular $\chi_1\not=\chi_2$. This last observation
is valid over any field not containing $\sqrt{-7}$, so that the
determinant is not always a square.

Now let $E'$ be a second curve such that $E[7]^{\sss}\cong
E'[7]^{\sss}$. 
The image of $\rhobar_{E',7}$ has the form
\[
  \begin{pmatrix}\chi_1'&*'\\0&\chi_2'  \end{pmatrix},
  \]
where $\{\chi_1,\chi_2\}=\{\chi_1',\chi_2'\}$ and $*' \neq 0$ for the
same reason as before.  In particular, there is an element of
order~$7$ in the images of both $\rhobar_{E,7}$ and $\rhobar_{E',7}$.
The next step in applying Theorem~\ref{T:reducible} is to decide if we
need to replace $E'$ with its $7$-isogenous curve to obtain
$\chi_1=\chi_1'$ and $\chi_2=\chi_2'$. For this we determine the
``isogeny characters'' characters $\chi_1$ and $\chi_1'$: the kernel
of $\chi_1$ (respectively $\chi_1'$) cuts out the cyclic extension
of~$\Q$ of degree dividing~$6$ generated by the coordinates of a point
in the kernel of the unique $7$-isogeny from~$E$ (respectively~$E'$).
In this way we can determine whether $\chi_1=\chi_1'$ and
$\chi_2=\chi_2'$ or $\chi_1=\chi_2'$ and $\chi_2=\chi_1'$.  In the
second case, we replace $E'$ with its $7$-isogenous curve, which has
the effect of interchanging $\chi_1'$ and~$\chi_2'$ (as well as
changing $*'$).  Now the image of $\rhobar_{E',7}$ has the form
\[
\begin{pmatrix}\chi_1&*'\\0&\chi_2  \end{pmatrix},
\]
with the same characters, in the same order, as for
$\rhobar_{E,7}$. From Theorem~\ref{T:reducible} we have that
$E[7]\cong E'[7]$ if and only if $F_1 \simeq F_2$, where $F_i$ are the
fields in the statement of Theorem~\ref{T:reducible}.

%{\bf Although the maps $*,*':G_{\Q}\to\F_7$ are not homomorphisms, it is
%easy to check that they are both surjective and that the subsets of
%$G_{\Q}$ which map to~$0$ under each (which by abuse of language we
%will call the \emph{kernels} of~$*$ and~$*'$) are subgroups, of
%index~$7$ and cutting out cyclic extensions} of~$\Q$ of degree~$7$.

The field $F_1$ is the common field of definition of all of the other
seven $7$-isogenies from~$E$ (see also Proposition~\ref{P:fieldF}).
The map from $X_0(7)$ to the $j$-line is given by the classical
rational function (see Fricke)
\[
   j = \frac{(t^{2} + 13t + 49) \cdot (t^{2} + 5t + 1)^{3}}{t},
\]
where $t$ is a choice of Hauptmodul for the genus~$0$ curve
$X_0(7)$. Hence the roots of the degree~$8$ polynomial~$(t^{2} + 13t +
49) \cdot (t^{2} + 5t + 1)^{3} -t\cdot j(E)$ determine the fields of
definition of the eight $7$-isogenies from~$E$. In our setting, it has
a single root (giving the unique $7$-isogeny from~$E$) and an
irreducible factor of degree~$7$, which defines~$F_1$ as an extension
of~$\Q$. Similarly, starting from $E'$ we determine $F_2$; finally, we
check whether $F_1$ and $F_2$ are isomorphic.

%the desired extension of the base
%field~$\Q$, which in turn  uniquely identifies the $*$ component of the
%representation, by Theorem~\ref{T:reducible}.

In this way, for each pair $(E,E')$ whose 
mod~$7$ representations
are reducible with isomorphic semisimplifications, we may determine
whether or not we do in fact have an isomorphism $E[7]\cong E'[7]$,
possibly after replacing $E'$ by its unique $7$-isogenous curve.

In most of the reducible cases encountered in the database, we found
that there was no isomorphism between the $7$-torsion modules
themselves.  In those cases where there is such an isomorphism, we can
determine whether or not it is symplectic using the same methods as in
the previous step, noting that the test using the parametrizing curves
$X_E(7)$ and $X_E^-(7)$ do not at any point rely on the irreducibility
or otherwise of the representations.  Finally, if there are also
$2$-{} or $3$-isogenies present we can include these appropriately,
since the former are symplectic and the latter antisymplectic.

{\bf Example (continued).} For $p=7$, after Steps 1--3, there
are~$255$ reducible sets of isogeny classes with isomorphic
semisimplification, of size up to~$76$.  Step~5 refines these into
smaller subsets which have actually isomorphic $7$-torsion modules, of
which $337$ are nontrivial: $276$ sets of size~$2$, $52$ of size~$3$
and~$9$ of size~$4$.  Finally, after considering all the isogenous
curves (as in Step~4) there are 421 congruent pairs: 262 symplectic
and 159 antisymplectic.

For $p\ge11$ there are no reducible cases to consider.

\subsection{Twists}
If there is a mod~$p$ congruence between two elliptic curves~$E_1$
and~$E_2$, then for any $d\in\Q^*$ there will also be a congruence (of
the same symplectic type) between their quadratic twists $E_1^d$
and~$E_2^d$: see Proposition~\ref{P:twist-cong}.
Nevertheless, it is hard to say precisely how many congruences
there in the database ``up to twist'', since twisting changes
conductor (in general), so we may have a set of mutually $7$-congruent
elliptic curves in the database, but with one or more of their twists
not in the database, so the twisted set in our data will be smaller.

Instead, to have a measure of how many congruences we have found up
to twist, we simply report on how many distinct $j$-invariants we
found, excluding as before curves which are only congruent to
isogenous curves.  For $p=7$ there are $\numprint{10348}$ distinct
$j$-invariants of curves with irreducible mod~$7$ representations
which are congruent to at least one non-isogenous curve, and $358$
distinct $j$-invariants in the reducible case.

For $p=11$ there are $191$ distinct $j$-invariants and for $p=13$
there are $39$.  For $p=17$, all $17$-congruent isogeny classes
consist of single curves, the eight pairs are quadratic twists, and
the $j$-invariants of the curves in each pair are
$48412981936758748562855/77853743274432041397$ and $-46585/243$.





\section{Evidence for the Frey-Mazur conjecture in the database}
\label{S:Frey-Mazur}

\begin{theorem}
 \label{T:cong19}
 Let $p \geq 19$ be a prime. Let $E/\Q$ and~$E'/\Q$ be elliptic curves
 with conductors at most~$\numprint{400000}$.  Suppose that $E[p]
 \simeq E'[p]$ as $G_\Q$-modules. Then $E$ and $E'$ are
 $\Q$-isogenous.
 \end{theorem}
\begin{proof} Let~$p \geq 5$ be a prime. Let $N_E$ and $\Delta_E$ 
denote the conductor and the minimal discriminant of $E$, respectively. Write also $\tilde{N}_E$ to denote~$N_E$ away from~$p$ and let $N_p$ be the Serre level (i.e. the Artin conductor away from~$p$) of~$\rhobar_{E,p}$. 
We have $N_p \mid \tilde{N}_E$.

Recall that the conductor of an elliptic curve at primes~$p \geq 5$ divides~$p^2$. Moreover, from Kraus~\cite[p. 30]{KrausThesis}
it follows that, for each $\ell \neq p$, if 
$\vv_{\ell}(N_p) \neq \vv_{\ell}(N_E) = \vv_{\ell}(\tilde{N}_E)$ then
$\vv_{\ell}(N_E) = 1$ and $p \mid \vv_{\ell}(\Delta_E)$.
Therefore, we can find primes $q_i \nmid pN_p$ such that 
\begin{equation}\label{E:condE}
  N_E = p^s \cdot N_p \cdot q_0 \cdot \ldots \cdot q_n, 
 \qquad p \mid \vv_{q_i}(\Delta_E), \qquad 0 \leq s \leq 2
\end{equation}
where the number of~$q_i$ occurring is $\geq 1$ if and only if 
$\tilde{N}_E \neq N_p$. 

Now let $E'/\Q$ be another elliptic curve satisfying $E[p] \simeq E'[p]$ as $G_\Q$-modules. Write $N_{E'}$, $\tilde{N}_{E'}$, $\Delta_{E'}$, $N'_p$ and $\rhobar_{E',p}$ to denote analogous quantities attached to~$E'$. We have $N'_p \mid \tilde{N}_{E'}$.

By assumption, we have $\rhobar_{E',p} \simeq \rhobar_{E,p}$ so these representations have the same Serre level, i.e. $N_p = N_p'$ and (similarly as for~$E$) we can find primes~$q_i' \nmid pN'_p$ such that~$N_{E'}$ factors as
\begin{equation}\label{E:condE'}
 N_{E'} = p^{s'} \cdot N_p \cdot q'_0 \cdot \ldots \cdot q'_m, 
 \qquad p \mid \vv_{q'_i}(\Delta_E'),
 \qquad 0 \leq s' \leq 2.
\end{equation}
The representations $\rhobar_{E,p}$ and $\rhobar_{E',p}$ also have the same Serre weights $k$ and $k'$, respectively. Note that for $s=0$ ($E$ has good reduction at~$p$) we have $k=2$ and for $s=1$ ($E$ has multiplicative reduction at~$p$) we have $k=2$ if $p \mid \vv_p(\Delta_E)$ or $k=p+1$ otherwise (see for example \cite[p. 3]{KrausThesis}); moreover, for $s=2$ it follows from \cite[Th\'eor\`eme 1]{KrausThesis} that $k \not\in \{2, p+1\}$ 
for $p \geq 19$. Similar conclusions apply to $E'$, $s'$ and $k'$. 
Therefore, we have 2 cases: (i) if $s = 2$ or $s=1$ and $p \nmid \vv_{p}(\Delta_E)$ then $s'=s$; (ii) if $s=0$ or $s=1$ and $p \mid \vv_{p}(\Delta_E)$ then $s' \in \{0,1 \}$.

Suppose $E'$ is a non-isogenous curve with the same conductor. Taking differences of traces of Frobenius at different primes shows that 
there are no congruence between any two of them for $p \geq 19$, otherwise $p$ needs to divide the differences (see (1) below). 
Thus $N_E \neq N_{E'}$.

Suppose $\tilde{N}_E = \tilde{N}_{E'}$, so that the only difference in the conductors is at~$p$. From the possibilities above for the Serre weights, after interchanging $E$ and $E'$ if needed, 
we can assume $s=1$ and $s'=0$ and we also know that $p \mid \vv_p(\Delta_E)$. On the other hand, if $\tilde{N}_E \neq \tilde{N}_{E'}$ then, after interchanging $E$ and $E'$ if needed, we have $N_p \neq \tilde{N}_E$ and so there is at least one prime~$q_i \neq p$ appearing in the factorization~\eqref{E:condE}, which in particular satisfies $p \mid \vv_{q_i}(\Delta_E)$.

Let $\calM_E$ be the set of pairs $(q,p)$ where $q$ is a multiplicative prime of~$E$ and
$p \geq 19$ is a prime satisfying $p \mid \vv_{q}(\Delta_E)$.
Note that we can have $q=p$. Let $\calM_{E'}$ be the analogous set for~$E'$. From the previous paragraph we conclude that 
$p$ has to occurs in the second entry of one of the pairs~$(q,p)$ in~$\calM_E$ or $\calM_{E'}$.

To complete the proof, we carried out the following computations on
the LMFDB database of all elliptic curves defined over~$\Q$ and
conductor at most~$\numprint{400000}$:
\begin{enumerate}
\item For each $N\le \numprint{400000}$ and each pair of non-isogenous
  curves~$E_1,E_2$ of conductor~$N$ (if there are at least two such
  isogeny classes), we computed $\gcd_{\ell\le B,
    \ell\nmid N}(a_{\ell}(E_1)-a_{\ell}(E_2))$ for increasing~$B$
  until the value of the $\gcd$ was~${}\le17$.  The success of this
  computation shows that there are no congruences mod~$p$ between
  non-isogenous curves of the same conductor for $p\ge19$.
\item For one curve~$E$ in each isogeny class we computed the set
  $\calM_E$ from the conductor and minimal discriminant.  We found that
  the largest prime~$p$ occurring in any~$\calM_E$ was~$97$: in fact,
  all~$p$ with $19\le p\le97$ occur except for~$p=89$.  Hence any
  mod~$p$ congruence between non-isogenous curves in the database must
  have~$p\le97$.  In view of the computations of
  Section~\ref{S:statistics}, there are no such congruences for $19\le
  p\le97$.

  Note that the set~$\calM_E$ is unchanged if we replace $E$ by a curve
  isogenous to it, provided that the isogeny has degree divisible only
  by primes less than~$19$.  But the only curves defined over~$\Q$ with
  isogenies of prime degree~$p\ge19$ are the CM curves for
  $p=19,43,67,163$, which have no multiplicative primes, and the pairs
  of $37$-isogenous curves, which have the same property (the smallest
  conductor being $1225=5^2\cdot7^2$).  Hence in this step it suffices
  to consider just one curve in each isogeny class.
\end{enumerate}
\end{proof}

%% Finally, given~$E$ in the database, we compute $\calM_E$ (which is
%% a finite set) and for each~$p$ occuring in a pair of $\calM_E$ we
%% compute the set of conductors~$\calL_{E,p}$ satisfying the
%% factorisation~\eqref{E:condE'} and still in the database (i.e. up
%% to 400000). For each conductor $N_{E'} \in \calL_{E,p}$ we verify
%% there is no elliptic curve~$E'$ of conductor $N_{E'}$ congruent
%% to~$E$ mod~$p$.

%% We end by remarking that a congruence between $E$ and $E'$ can
%% exist modulo a prime~$p$ not occuring in $\calM_E$, but the
%% arguments above show that in such case $p$ occurs in $\calM_{E'}$,
%% therefore we will detect this congruence at a laters stage as we
%% run over all the curves in the database.


 
\begin{thebibliography}{999}

%% \bibitem{BDMTV}
%% Jennifer~S. Balakrishnan, Netan Dogra, J.~Steffen M\"uller, Jan Tuitman, and
%%   Jan Vonk.
%% \newblock Explicit {C}habauty-{K}im for the split Cartan modular curve of level 13, Annals of Math. (to appear).

\bibitem{BDMTV-S4}
Jennifer~S. Balakrishnan, Netan Dogra, J.~Steffen M\"uller, Jan Tuitman, and
  Jan Vonk.
\newblock Personal communication.

\bibitem{BarinderCrem} B.\ Banwait and J.\ Cremona, 
{\em Tetrahedral Elliptic Curves and the local-to-global principle for Isogenies}
Algebra \& Number Theory {\bf 8} (2014), no. 5, 1201--1229.

%% \bibitem{Billerey17} N.~Billerey,
%%   {\em On some remarkable congruences between two elliptic curves},
%%   \url{https://arxiv.org/abs/1605.09205}.
  
%% \bibitem{BPR2013}
%% Yuri Bilu, Pierre Parent, and Marusia Rebolledo.
%% \newblock Rational points on {$X^+_0(p^r)$}.
%% \newblock {\em Ann. Inst. Fourier (Grenoble)}, 63(3):957--984, 2013.

\bibitem{AMEC}
J.~E.~Cremona.
\newblock {\em Algorithms for modular elliptic curves}.
\newblock Cambridge University Press, Cambridge, second edition, 1997.

\bibitem{DahmenPhD} S.\ Dahmen,
 {\em Classical and modular methods applied to Diophantine equations}, 
 PhD thesis, Utrecht University, 2008. Available at \\
 \url{https://dspace.library.uu.nl/handle/1874/29640}

\bibitem{Fisher} T.\ Fisher,
{\em On families of $7$ and $11$-congruent elliptic curves}, 
LMS J.\ Comput.\ Math.\ {\bf 17} (2014), no. 1, 536--564.

\bibitem{FisherList} T.\ Fisher,
{\em A table of $11$-congruent elliptic curves over the rationals}, \\
\url{https://www.dpmms.cam.ac.uk/~taf1000/papers/congr-11}

\bibitem{FKSym} N.\ Freitas and A.\ Kraus,
{\em On the symplectic type of isomorphisms of the $p$-torsion of elliptic curves}, Preprint

\bibitem{GL}
Enrique Gonz\'{a}lez-Jim\'{e}nez and \'{A}lvaro Lozano-Robledo,
\newblock Elliptic curves with abelian division fields.
\newblock {\em Math. Z.}, 283(3-4):835--859, 2016.

\bibitem{Halberstadt-Kraus-YE7}
Emmanuel Halberstadt and Alain Kraus, \emph{On the modular curves {$Y_E(7)$}},
  Math. Comp. \textbf{69} (2000), no.~231, 1193--1206. \MR{1651758}

\bibitem{Halberstadt-Kraus-XE7}
\bysame, \emph{Sur la courbe modulaire {$X_E(7)$}}, Experiment. Math.
  {\bf 12} (2003), no.~1, 27--40. \MR{2002672}
  
\bibitem{Kraus1990} A.\ Kraus,
{\em Sur le d\'efaut de semi-stabilit\'e des courbes elliptiques \`a r\'eduction additive},
Manuscripta Math.\ {\bf 69} (1990), no. 4, 353--385.
  
\bibitem{KrausThesis}
Alain Kraus,
\newblock D{\'e}termination du poids et du conducteur associ{\'e}s aux repr{\'e}sentations des points de p-torsion d'une courbe elliptique,
\newblock Dissertationes Math. (Rozprawy Mat.) {\bf 364}, 1997.

\bibitem{KO}
A.~Kraus and J.~Oesterl\'{e}.
\newblock Sur une question de {B}. {M}azur.
\newblock {\em Math. Ann.}, 293(2):259--275, 1992.

\bibitem[Lan76]{LangModForms}
Serge Lang.
\newblock {\em Introduction to Modular Forms}.
\newblock Springer-Verlag, 1976.

\bibitem{lmfdb} The {LMFDB Collaboration},
{\em The L-functions and Modular Forms Database}, \\
\url{http://www.lmfdb.org}, 2013.

\bibitem{magma}
Wieb Bosma, John Cannon, and Catherine Playoust.
\newblock The {M}agma algebra system. {I}. {T}he user language.
\newblock {\em J. Symbolic Comput.}, 24(3-4):235--265, 1997.
\newblock Computational algebra and number theory (London, 1993).

\bibitem{PSS}
Bjorn Poonen, Edward~F. Schaefer, and Michael Stoll.
\newblock Twists of {$X(7)$} and primitive solutions to {$x^2+y^3=z^7$}.
\newblock {\em Duke Math. J.}, 137(1):103--158, 2007.


\bibitem{Rubin-Silverberg}
K.~Rubin and A.~Silverberg.
\newblock Families of elliptic curves with constant mod {$p$} representations.
\newblock In {\em Elliptic curves, modular forms, \& {F}ermat's last theorem
  ({H}ong {K}ong, 1993)}, Ser. Number Theory, I, pages 148--161. Int. Press,
  Cambridge, MA, 1995.

\bibitem{sage}
W.\thinspace{}A. Stein et~al.
\newblock {\em {S}age {M}athematics {S}oftware ({V}ersion 8.7)}.
\newblock The Sage Development Team, 2019.
\newblock {\tt http://www.sagemath.org}.

\bibitem{SilvermanI} J.\ H. Silverman,
{\em The arithmetic of elliptic curves},
Second Edition, Graduate Texts in Mathematics {\bf 106}, Springer, Dordrecht, 2009.

%% \bibitem{Sutherland}
%% Andrew V. Sutherland.
%% \newblock Computing images of Galois representations attached to elliptic curves.
%% \newblock {\em Forum of Mathematics}, Sigma {\bf 4} (2016), e4, 79 pp.


\end{thebibliography}



\end{document}
