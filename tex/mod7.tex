\documentclass[12pt, reqno]{amsart}
\usepackage{fullpage,url,amssymb,enumerate,colonequals, numprint}

\usepackage{mathrsfs} % for \mathscr (script letters)
\usepackage{lscape}
\usepackage[all,cmtip]{xy}

\usepackage{color}

\usepackage[
%       draft,
        colorlinks, citecolor=darkgreen,
        backref,
        pdfauthor={Nuno Freitas}, % add other authors
]{hyperref}
\usepackage{comment}

% label and link to an elliptic curve /Q:
% version using Cremona labels:
\newcommand{\lmfdbec}[3]{\href{http://www.lmfdb.org/EllipticCurve/Q/#1#2#3}{{\text{\rm#1#2#3}}}}
% version using LMFDB labels:
%\newcommand{\lmfdbec}[3]{\href{http://www.lmfdb.org/EllipticCurve/Q/#1/#2/#3}{{\text{\rm#1.#2#3}}}}
% label and link to an elliptic curve isogeny class /Q:
\newcommand{\lmfdbeciso}[2]{\href{http://www.lmfdb.org/EllipticCurve/Q/#1/#2}{\text{\rm#1#2}}}


\newcommand{\dashedarrow}{\dashrightarrow}

% Characters
\newcommand{\Aff}{\mathbb{A}}
\newcommand{\C}{\mathbb{C}}
\newcommand{\F}{\mathbb{F}}
\newcommand{\Fbar}{{\overline{\F}}}
\newcommand{\G}{\mathbb{G}}
\newcommand{\Gm}{\mathbb{G}_{\mathrm{m}}}
\newcommand{\bbH}{\mathbb{H}}
\newcommand{\PP}{\mathbb{P}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\Qbar}{{\overline{\Q}}}
\newcommand{\Zhat}{{\hat{\Z}}}
\newcommand{\Ebar}{{\overline{E}}}
\newcommand{\Zbar}{{\overline{\Z}}}
\newcommand{\kbar}{{\overline{k}}}
\newcommand{\Kbar}{{\overline{K}}}
\newcommand{\rhobar}{{\overline{\rho}}}
\newcommand{\ksep}{{k^{\operatorname{sep}}}}

\newcommand{\frp}{{\mathfrak p}}
\newcommand{\frq}{{\mathfrak q}}

\newcommand{\Adeles}{\mathbf{A}}
\newcommand{\kk}{\mathbf{k}}

\newcommand{\mm}{\mathfrak{m}}

\newcommand{\eps}{\varepsilon}

\newcommand{\uom}{\underline{\omega}}

% bold characters
\newcommand{\boldf}{\mathbf{f}}
\newcommand{\boldl}{\ensuremath{\boldsymbol\ell}}
\newcommand{\boldL}{\mathbf{L}}
\newcommand{\boldr}{\mathbf{r}}
\newcommand{\boldw}{\mathbf{w}}
\newcommand{\boldzero}{\mathbf{0}}
\newcommand{\boldomega}{\ensuremath{\boldsymbol\omega}}


% mathcal characters
\newcommand{\calA}{\mathcal{A}}
\newcommand{\calB}{\mathcal{B}}
\newcommand{\calC}{\mathcal{C}}
\newcommand{\calD}{\mathcal{D}}
\newcommand{\calE}{\mathcal{E}}
\newcommand{\calF}{\mathcal{F}}
\newcommand{\calG}{\mathcal{G}}
\newcommand{\calH}{\mathcal{H}}
\newcommand{\calI}{\mathcal{I}}
\newcommand{\calJ}{\mathcal{J}}
\newcommand{\calK}{\mathcal{K}}
\newcommand{\calL}{\mathcal{L}}
\newcommand{\calM}{\mathcal{M}}
\newcommand{\calN}{\mathcal{N}}
\newcommand{\calO}{\mathcal{O}}
\newcommand{\calP}{\mathcal{P}}
\newcommand{\calQ}{\mathcal{Q}}
\newcommand{\calR}{\mathcal{R}}
\newcommand{\calS}{\mathcal{S}}
\newcommand{\calT}{\mathcal{T}}
\newcommand{\calU}{\mathcal{U}}
\newcommand{\calV}{\mathcal{V}}
\newcommand{\calW}{\mathcal{W}}
\newcommand{\calX}{\mathcal{X}}
\newcommand{\calY}{\mathcal{Y}}
\newcommand{\calZ}{\mathcal{Z}}

%mathfrak characters

\newcommand{\ff}{\mathfrak{f}}
\newcommand{\fm}{\mathfrak{m}}
\newcommand{\fM}{\mathfrak{M}}
\newcommand{\fp}{\mathfrak{p}}
\newcommand{\fP}{\mathfrak{P}}
\newcommand{\fq}{\mathfrak{q}}
\newcommand{\fN}{\mathfrak{N}}

\newcommand{\CC}{\mathscr{C}}
\newcommand{\FF}{\mathscr{F}}
\newcommand{\GG}{\mathscr{G}}
\newcommand{\II}{\mathscr{I}}
\newcommand{\JJ}{\mathscr{J}}
\newcommand{\LL}{\mathscr{L}}
\newcommand{\NN}{\mathscr{N}}
\newcommand{\OO}{\mathscr{O}}
\newcommand{\WW}{\mathscr{W}}
\newcommand{\XX}{\mathscr{X}}
\newcommand{\ZZ}{\mathscr{Z}}

% Math operators
\DeclareMathOperator{\Ann}{Ann}
\DeclareMathOperator{\Aut}{Aut}
\DeclareMathOperator{\Br}{Br}
\DeclareMathOperator{\cd}{cd}
\DeclareMathOperator{\Card}{Card}
\DeclareMathOperator{\Char}{char}
\DeclareMathOperator{\Cl}{Cl}
\DeclareMathOperator{\codim}{codim}
\DeclareMathOperator{\coker}{coker}
\DeclareMathOperator{\Cor}{Cor}
\DeclareMathOperator{\divv}{div}
\DeclareMathOperator{\Div}{Div}
\DeclareMathOperator{\Det}{Det}
\DeclareMathOperator{\Dic}{Dic}

\DeclareMathOperator{\End}{End}
\newcommand{\END}{{\EE}\!nd}
\DeclareMathOperator{\Eq}{Eq}
\DeclareMathOperator{\Ext}{Ext}
\newcommand{\EXT}{{\E}\!xt}
\DeclareMathOperator{\Fix}{\tt Fix}
\DeclareMathOperator{\Frac}{Frac}
\DeclareMathOperator{\Frob}{Frob}
\DeclareMathOperator{\Gal}{Gal}
\DeclareMathOperator{\Gr}{Gr}
\DeclareMathOperator{\Hom}{Hom}
\newcommand{\HOM}{{\HH}\!om}
\DeclareMathOperator{\im}{im}
\DeclareMathOperator{\Ind}{Ind}
\DeclareMathOperator{\inv}{inv}
\DeclareMathOperator{\Jac}{Jac}
\DeclareMathOperator{\JL}{JL}
\DeclareMathOperator{\lcm}{lcm}
\DeclareMathOperator{\Lie}{Lie}
\DeclareMathOperator{\Log}{Log}
\DeclareMathOperator{\MakeDecentModel}{\tt MakeDecentModel}
\DeclareMathOperator{\nil}{nil}
\DeclareMathOperator{\Norm}{Norm}
\DeclareMathOperator{\NP}{NP}
\DeclareMathOperator{\Num}{Num}
\DeclareMathOperator{\odd}{odd}
\DeclareMathOperator{\ord}{ord}
\DeclareMathOperator{\Pic}{Pic}
\DeclareMathOperator{\PIC}{\bf Pic}
\DeclareMathOperator{\Prob}{\bf P}
\DeclareMathOperator{\Proj}{Proj}
\DeclareMathOperator{\PROJ}{\bf Proj}
\DeclareMathOperator{\rank}{rank}
\DeclareMathOperator{\rec}{rec}
\DeclareMathOperator{\re}{Re}
\DeclareMathOperator{\reg}{reg}
\DeclareMathOperator{\res}{res}
\DeclareMathOperator{\Res}{Res}
\DeclareMathOperator{\rk}{rk}
\DeclareMathOperator{\scd}{scd}
\DeclareMathOperator{\Sel}{Sel}
\DeclareMathOperator{\Sp}{Sp}
\DeclareMathOperator{\Spec}{Spec}
\DeclareMathOperator{\SPEC}{\bf Spec}
\DeclareMathOperator{\Spf}{Spf}
\DeclareMathOperator{\sss}{ss}
\DeclareMathOperator{\supp}{supp}
\DeclareMathOperator{\Sym}{Sym}
\DeclareMathOperator{\tr}{tr}
\DeclareMathOperator{\T}{\mathbb{T}}
\DeclareMathOperator{\Tr}{Tr}
\DeclareMathOperator{\tw}{tw}
\DeclareMathOperator{\trdeg}{tr deg}
\DeclareMathOperator{\WD}{WD}

% Categories
\newcommand{\Ab}{\operatorname{\bf Ab}}
\newcommand{\Groups}{\operatorname{\bf Groups}}
\newcommand{\Schemes}{\operatorname{\bf Schemes}}
\newcommand{\Sets}{\operatorname{\bf Sets}}

% Text subscripts, superscripts
\newcommand{\ab}{{\operatorname{ab}}}
\newcommand{\an}{{\operatorname{an}}}
\newcommand{\Az}{{\operatorname{Az}}}
\newcommand{\CS}{\operatorname{\bf CS}}
\newcommand{\et}{{\operatorname{et}}}
\newcommand{\ET}{{\operatorname{\bf \acute{E}t}}}
\newcommand{\fl}{{\operatorname{f\textcompwordmark l}}}
\newcommand{\good}{{\operatorname{good}}}
\newcommand{\op}{{\operatorname{op}}}
\newcommand{\perf}{{\operatorname{perf}}}
\newcommand{\red}{{\operatorname{red}}}
\newcommand{\regular}{{\operatorname{regular}}}
\newcommand{\sing}{{\operatorname{sing}}}
\newcommand{\smooth}{{\operatorname{smooth}}}
\newcommand{\tH}{{\operatorname{th}}}
\newcommand{\tors}{{\operatorname{tors}}}
\newcommand{\nontors}{{\operatorname{non-tors}}}
\newcommand{\unr}{{\operatorname{unr}}}
\newcommand{\Zar}{{\operatorname{Zar}}}
\newcommand{\ns}{{\operatorname{ns}}}
\renewcommand{\sp}{{\operatorname{sp}}}
\newcommand{\vv}{\upsilon}
\newcommand{\Cech}{\v{C}ech}
\newcommand{\E}{{\operatorname{\bf E}}}
\newcommand{\GalQ}{{\Gal}(\Qbar/\Q)}
\newcommand{\GL}{\operatorname{GL}}
\newcommand{\HH}{{\operatorname{H}}}
\newcommand{\HHcech}{{\check{\HH}}}
\newcommand{\HHat}{{\hat{\HH}}}
\newcommand{\M}{\operatorname{M}}
\newcommand{\PGL}{\operatorname{PGL}}
\newcommand{\PSL}{\operatorname{PSL}}
\newcommand{\SL}{\operatorname{SL}}

\newcommand{\del}{\partial}
\newcommand{\directsum}{\oplus} % binary direct sum
\newcommand{\Directsum}{\bigoplus} % direct sum of a collection
\newcommand{\injects}{\hookrightarrow}
\newcommand{\intersect}{\cap} % binary intersection
\newcommand{\Intersection}{\bigcap} % intersection of a collection
\newcommand{\isom}{\simeq}
\newcommand{\notdiv}{\nmid}
\newcommand{\surjects}{\twoheadrightarrow}
\newcommand{\tensor}{\otimes} % binary tensor product
\newcommand{\Tensor}{\bigotimes} % tensor product of a collection
\newcommand{\union}{\cup} % binary union
\newcommand{\Union}{\bigcup} % union of a collection

\newcommand{\Algorithm}{\textbf{Algorithm}\ }
\newcommand{\Subroutine}{\textbf{Subroutine}\ }

\newcommand{\isomto}{\overset{\sim}{\rightarrow}}
\newcommand{\isomfrom}{\overset{\sim}{\leftarrow}}
\newcommand{\leftexp}[2]{{\vphantom{#2}}^{#1}{#2}}
\newcommand{\rholog}{\rho \log}
\newcommand{\sigmaiota}{{\leftexp{\sigma}{\iota}}}
\newcommand{\sigmaphi}{{\leftexp{\sigma}{\phi}}}
\newcommand{\sigmatauphi}{{\leftexp{\sigma\tau}{\phi}}}
\newcommand{\tauphi}{{\leftexp{\tau}{\phi}}}
\newcommand{\To}{\longrightarrow}
\newcommand{\floor}[1]{\left\lfloor #1 \right\rfloor}

% imported from JC's file
\DeclareMathOperator{\id}{id}
\DeclareMathOperator{\Id}{Id}
\def\w{\omega}
\def\r3{\sqrt{-3}}
\def\pibar{\overline{\pi}}
\def\legendre#1#2{\left(\displaystyle\frac{#1}{#2}\right)}
\newcommand{\diag}{{\operatorname{diag}}}


\numberwithin{equation}{section}

%\newtheorem{theorem}{Theorem}
%\newtheorem{lemma}{Lemma}
%\newtheorem{corollary}{Corollary}
%\newtheorem{proposition}{Proposition}

%\theoremstyle{definition}
%\newtheorem{definition}[equation]{Definition}
%\newtheorem{question}[equation]{Question}
%\newtheorem{conjecture}[equation]{Conjecture}
%\newtheorem{example}[equation]{Example}
%\newtheorem{examples}[equation]{Examples}

%\theoremstyle{remark}
%\newtheorem{remark}[equation]{Remark}
%\newtheorem{remarks}[equation]{Remarks}


\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{proposition}[theorem]{Proposition}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{question}[theorem]{Question}
\newtheorem{conjecture}[theorem]{Conjecture}
\newtheorem{example}[theorem]{Example}
\newtheorem{examples}[theorem]{Examples}

\theoremstyle{remark}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{remarks}[theorem]{Remarks}

\newcommand{\Sage}{{\sc SageMath}}
\newcommand{\Magma}{{\sc Magma}}

\setlength{\parindent}{0mm}
\setlength{\parskip}{1ex plus 0.5ex}
\definecolor{darkgreen}{rgb}{0,0.5,0}

\newcommand{\nf}[1]{{\color{blue} \textsf{[NF: #1]}}}
\newcommand{\jc}[1]{{\color{darkgreen} \textsf{[JC: #1]}}}

\newcommand{\condS}{condition~{\bf (S)}}
\begin{document}

\title{Global methods for the symplectic type of congruences between elliptic curves} % modulo small primes}

\author{John Cremona}
\address{Mathematics Institute,
         University of Warwick,
         Coventry CV4 7AL,
         United Kingdom}
\email{j.e.cremona@warwick.ac.uk}

\author{Nuno Freitas}
\address{Departament de Matem\`atiques i Inform\`atica,
Universitat de Barcelona (UB),
Gran Via de les Corts Catalanes 585,
08007 Barcelona, Spain}
\email{nunobfreitas@gmail.com}


\date{\today}

\keywords{Elliptic curves, Weil pairing, Galois representations, symplectic isomorphisms}
%\subjclass[2010]{Primary 11D41; Secondary 11G10, 11F80.}

\thanks{JEC was supported by EPSRC Programme Grant EP/K034383/1
  \textit{LMF: L-Functions and Modular Forms}, and the Horizon 2020
  European Research Infrastructures project \textit{OpenDreamKit}
  (\#676541)}
\thanks{NF was supported by the European Union's
  Horizon 2020 research and innovation programme under the Marie
  Sk\l{l}odowska-Curie grant agreement No.\ 747808}


\begin{abstract}
We describe a systematic investigation into the existence of
congruences between the mod~$p$ torsion modules of elliptic curves
defined over $\Q$, including methods to determine the symplectic type
of such congruences. We classify the existence and symplectic type of mod~$p$ congruences between twisted elliptic curves over number fields, giving global symplectic criteria that apply in situations where the available local methods may fail.

We report on the results of applying our methods for
all primes~$p\ge7$
to the elliptic curves in the LMFDB database, which currently includes
all elliptic curves of conductor less than~$\numprint{500000}$.  We also show that while such congruences exist
for each $p\le17$, there are none for~$p \geq 19$ in the database, in line
with a strong form of the Frey-Mazur conjecture.
\end{abstract}

\maketitle


\section{Introduction}

Let $p$ be a prime, $K$ be a number field and $G_K = \Gal(\Kbar/K)$
the absolute Galois group of $K$.  Let $E$ and $E'$ be elliptic curves
defined over $K$, and write $E[p]$ and $E'[p]$ for their $p$-torsion
$G_K$-modules.

Let $\phi : E[p] \to E'[p]$ be an isomorphism of $G_K$-modules.  There
is an element $d(\phi) \in \F_p^\times$ such that the Weil
pairings~$e_{E,p}$ and~$e_{E',p}$ satisfy
\[
e_{E',p}(\phi(P), \phi(Q)) = e_{E,p}(P, Q)^{d(\phi)}
\]
for all $P, Q \in E[p]$.  We say that $\phi$ is a {\em symplectic
  isomorphism} or an {\em anti-symplectic isomorphism} if $d(\phi)$ is
a square or a non-square modulo~$p$, respectively.  When two elliptic
curves have isomorphic $p$-torsion modules we say that there is a
mod~$p$ {\em congruence} between them, or that they are {\em
  congruent} mod~$p$ or $p$-{\em congruent}.

For example, suppose that~$\phi$ is induced by an isogeny (also
denoted~$\phi$) from $E$ to $E'$, of degree $\deg(\phi)$ coprime
to~$p$. Then, using Weil reciprocity,
we have
\[
  e_{E',p}(\phi(P), \phi(Q)) = e_{E,p}(P, \hat\phi\phi(Q)) =
  e_{E,p}(P, \deg(\phi)(Q)) = e_{E,p}(P, Q)^{\deg(\phi)},
  \]
  where $\hat{\phi}$ denotes the dual isogeny; 
  thus $d(\phi)=\deg\phi\pmod{p}$.
  Hence $\phi$ is symplectic or antisymplectic according as $\deg\phi$
is a quadratic residue or nonresidue mod~$p$, respectively.  We will refer to
this condition as the \emph{isogeny criterion}.

Given $G_K$-isomorphic modules $E[p]$ and~$E'[p]$ as above, it is possible they
admit isomorphisms with both symplectic types; this occurs if and only
if $E[p]$ admits an anti-symplectic automorphism.  We say that
\emph{~$E[p]$ satisfies \condS} if $E[p]$ does not admit
anti-symplectic automorphisms. The following proposition follows
from~\cite{FKSym} and gives two equivalent description of~\condS.

\begin{proposition} \label{P:conditionS}
Let $E$ be an elliptic curve over a number field~$K$. Let~$p > 2$ be a prime and $\rhobar_{E,p} : G_K \to \GL_2(\F_p)$ the representation arising from the action of~$G_K$ on $E[p]$. 

Then $E[p]$ satisfies \condS\ if and only if the centralizer of~$\rhobar_{E,p}(G_K)$ in~$\GL_2(\F_p)$ contains 
only matrices with square determinant
or if and only if one of the following is satisfied:
 \begin{itemize}
 \item[(A)] The image of $\rhobar_{E,p}$ is a non-abelian subgroup of~$\GL_2(\F_p)$ or,
 \item[(B)] we have $\rhobar_{E,p} \cong \left( \begin{smallmatrix} \chi & * \\ 0 & \chi \end{smallmatrix} \right)$ where $\chi : G_K \to \F_p^*$ is a character
 and $* \neq 0$.
 \end{itemize}
If $\rhobar_{E,p}$ is absolutely irreducible then $E[p]$ satisfies
condition~(A) and hence \condS.  \end{proposition}
\begin{proof} The first claim is the second part of~\cite[Lemma~6]{FKSym} and the second follows 
from~\cite[Lemmas~7~and~8]{FKSym}. The last statement follows from the proof of 
Corollary~3 in {\it loc. cit.} 
 \end{proof}


In the case $K=\Q$, \condS\ is satisfied by $E[p]$ for
all~$p\ge7$, by~\cite[Corollary~3 and Proposition~2]{FKSym}.  Hence,
when a $G_\Q$-isomorphism $\phi : E[p] \simeq E'[p]$ exists, normally
there is only one possible symplectic type for any such~$\phi$.  For
an example where both types exist, take $p=5$ and $E$, $E'$ to be the
curves\footnote{Throughout the paper we use Cremona labels for
  elliptic curves over~$\Q$; these curves may be found in the LMFDB
  (see \cite{lmfdb}).} $\lmfdbec{11}{a}{1}$ and
$\lmfdbec{1342}{c}{2}$, respectively (see~\cite[Example~5.2]{FKSym}
for more details).

\begin{comment}
\begin{proposition}\label{P:auto}
  Let $E$ and~$E'$ be elliptic curves defined over~$\Q$ such that
  $E[p]\cong E'[p]$ as $G_\Q$-modules.
  \begin{enumerate}
    \item If $E[p]$ is irreducible, then the isomorphism $E[p]\cong
      E'[p]$ is unique up to scaling; hence its symplectic type is
      well-defined.
      \item If $p\ge7$ then the same conclusion also holds when
        $E[p]$ is reducible.
  \end{enumerate}
\end{proposition}
\begin{proof} See~\cite[Corollary~3 and Proposition~2]{FKSym}
\end{proof}
\end{comment}

\begin{comment}
both have $5$-torsion Galois module isomorphic to $\mu_5
\times \Z/5\Z$.  Now let $P,Q \in E[5]$ and $P',Q' \in E'[5]$ be bases
such that $P$, $P'$ are defined over~$\Q$.  The map defined by $P
\mapsto P'$ and $Q \mapsto n\cdot Q'$ (with $5 \nmid n$) is a
$G_\Q$-isomorphism which is symplectic if and only if $n$ is a square
mod~$5$.  Moreover, the automorphism $\alpha$ of $E[5]$ given by
$\alpha(P) = P$ and $\alpha(Q) = 2Q$ is anti-symplectic because $2$ is
not a square modulo~$5$.
\end{comment}

It is then natural to consider triples $(E,E',p)$ where $E/K$ and
$E'/K$ are elliptic curves with isomorphic $p$-torsion such that the
$G_K$-modules isomorphisms $\phi : E[p] \rightarrow E'[p]$ are either
all symplectic or all anti-symplectic.  In this case, we will say that
the {\em symplectic type} of $(E,E',p)$ is respectively symplectic or
anti-symplectic.  The problem of determining the symplectic of
$(E,E',p)$ over~$K=\Q$ was extensively studied by the second author
and Alain Kraus in~\cite{FKSym}.

The isogeny criterion gives an easy solution when $(E,E',p)$
arises from an isogeny $h \colon E \to E'$ of degree~$n$ coprime
to~$p$, since in such cases $d(h|_{E[p]}) = n$ and the symplectic type
of $(E,E',p)$ is symplectic if $n$ is a square mod~$p$ and
anti-symplectic otherwise.

Given a generic triple $(E, E', p)$, in principle, one
could compute the $p$-torsion fields of $E$ and $E'$,
write down the Galois action on $E[p]$ and $E'[p]$ and check if they
are symplectically or anti-symplectically isomorphic. However, the
degree of the $p$-torsion fields grows very fast with~$p$ making this
method not practical already over~$\Q$ for $p = 5$.

One way to circumvent this computational problem, at least over~$\Q$, is to use the methods
presented in~\cite{FKSym}. Indeed, the main objective of {\it loc. cit.} was to establish a complete list of {\em local symplectic criteria},
allowing one to determine the symplectic type of $(E,E',p)$ using only
standard information about the local curves $E/\Q_\ell$ and
$E'/\Q_\ell$ at a single prime $\ell \neq p$ and congruence conditions
on~$p$. Further, it is also proved in~\cite{FKSym}  that if the
symplectic type of~$(E,E',p)$ is encoded in local information at a
single prime $\ell \neq p$, then one of the local criteria will
successfully determine it.  
There are cases where the local methods
are insufficient: however, this can occur only when 
the representation~$\rhobar_{E,p} : G_\Q \to \GL_2(\F_p)$ attached to~$E$ 
has image without elements of order~$p$;
see \cite[Proposition~16]{FKSym} for an example.

This paper has the following main objectives: 
\begin{itemize}
 \item[(i)] Give global methods to determine the symplectic type of~$(E,E',p)$ when the local methods of \cite{FKSym} may not apply, specifically when the projective images are dihedral. 
\item[(ii)] To systematically identify and
determine the symplectic type of all congruences between curves in the
LMFDB (see \cite{lmfdb})
%%of conductors up to~$\numprint{500000}$
for all~$p\ge7$.
\end{itemize}
%% to give a uniform procedure to
%% determine, for a few small~$p$, the symplectic type of
%% triples~$(E,E',p)$ independently of the image of~$\rhobar_{E,p}$.

More specifically, towards (i), we give a complete resolution for~$p=7$ using modular curves and, for general~$p$, 
we give global criteria for
when $E$ and~$E'$ are twists of each other: Proposition~\ref{P:twist} and Theorem~\ref{T:quadratic} cover congruences
between quadratic twists and
Proposition~\ref{P:higherTwists} and Theorem~\ref{T:typeHigher}
study the existence and the symplectic type of congruences between higher order twists.


For objective~(ii), we have implemented in {\Magma} \cite{magma}
and {\Sage} \cite{sage} the methods from objective~(i) together with
those from~\cite{FKSym}. We have used our code to classify the
symplectic types of congruences between curves in the LMFDB, namely
all elliptic curves defined over~$\Q$ of conductor less
than~$\numprint{500000}$. More precisely, Theorem~\ref{T:cong19} shows
there are no mod~$p$ congruences in LMFDB for $p \geq 19$ and we
found, for $p$ in the range $7 \leq p \leq 17$, all the congruences in
the database; we report on the results obtained in
Section~\ref{S:statistics}~and~\ref{S:Frey-Mazur}.
We note that the description of our method also includes a discussion on how to
determine whether $E[p]$ and~$E'[p]$ are isomorphic (ignoring the
symplectic structure) in both the irreducible and reducible
cases. 

\begin{comment}
\nf{I don't see the point of this previous work section. We already mention Fisher later.}
\jc{agreed -- all that is here is mentioned also later except for my
  comment (with the wrong date) that I discovered the mod-17
  congruence in 2017 -- it was 2007!}
\subsection{Previous work}
Our study of congruences between curves in the database follows on
from previous work by a number of authors.  The current first author
himself found many such congruences as his database expanded,
including the congruences mod~$17$ which were found in around~2017,
but these results were only circulated informally and not published.
The mod~$17$ congruence was rediscovered by Billerey
\cite{Billerey17}, who also determined its symplectic type, as had the
second author.  Fisher lists $11$-congruences for conductors up to
130,000, up to twist and isogeny, in \cite{FisherList}; that list also
includes congruences between curves in this range and curves outside
the current LMFDB range, found by finding rational points on the associated modular
curves.
\end{comment}

\subsection{Modular parametrizations}
The modular curve $X(p)$ parametrizes elliptic curves with full
level~$p$ structure. It has genus~$0$ for $p=2,3,5$, genus~$3$ for
$p=7$ and genus~$\ge26$ for $p\ge11$.  Fixing an elliptic
curve~$E/K$, the curve $X_E(p)$, which is a twist of~$X(p)$ (and
hence has the same genus), parametrizes pairs $(E',\phi)$ such that
$\phi$ is a symplectic isomorphism~$E[p]\cong E'[p]$; similarly
$X_E^-(p)$ parametrizes antisymplectic isomorphisms. Note that the pair $(E,\id)$ constituted by $E$ itself and the identity map
gives a base point defined over~$K$ on~$X_E(p)$, while $X_E^-(p)$ may have no $K$-rational points.

It follows that congruences modulo~$p$ for $p\le 5$ are common.  There
are certainly many mod~$3$ and mod~$5$ congruences in the database,
but we have not searched for these systematically. Indeed, since
$X_E(3)$ and $X_E(5)$ have genus~0, for each fixed~$E$, there will
always be congruences that are not part of the database independently
of its range. In contrast, for primes~$p \geq 7$, the curve $X_E(p)$
has genus~$\geq 3$ and so for each~$E$ there are only finitely many
mod~$p$ congruences with~$E$, hence the database
might contain all such congruences; however proving this fact for a
fixed~$E$ is a hard problem.

For convenience 
we sometimes also write $X_E^+(p)$ to denote $X_E(p)$. 
By ``explicit equations'' for $X_E^{\pm}(p)$, we mean the
following.
\begin{itemize}
  \item An explicit model for a family of curves, with equations whose
    coefficients are polynomials in $\Q[a,b]$, such that specializing
    $a,b$ gives a model for $X_E^{\pm}(p)$ where $E$ is the elliptic
    curve with equation $Y^2=X^3=aX+b$; each rational point $P$ is
    either a cusp of the modular curve or encodes a pair $(E',\phi)$
    such that $(E,E', p)$ is a symplectic (respectively,
    antisymplectic) triple.
    \item A rational function with coefficients in $\Q(a,b)$ defining
      the map $j: X_E^{\pm}(p) \to \PP^1$, taking a point
      $P=(E',\phi)$ to $j(E')$.  The degree of this map is the
      index~$[\PSL_2(\Z):\Gamma(p)] = |\PSL_2(\F_p)|$: for example, when
        $p=7$ the degree is~$168$.
      \item Rational functions $c_4$ and $c_6$ such that for each
        non-cuspidal point~$P=(E',\phi)$, a model for $E'$ is
        $Y^2=X^3+a'X+b'$ where $(a',b')=(-27c_4(P),-54c_6(P))$.
\end{itemize}
For $p=3$ and~$p=5$, the curves themselves have genus~$0$ and hence we
do not need equations, but the formulas for $j$, $c_4$ and~$c_6$ are
still useful.  They may be found in \cite{Rubin-Silverberg}.

Equations for $X_E(7)$, in this sense, were obtained by Kraus and
Halberstadt in~\cite{Halberstadt-Kraus-XE7}, though the functions
$c_4$ and $c_6$ in \cite{Halberstadt-Kraus-XE7} are only defined away
from $5$ points (which may or may not be rational). Fisher gives more
complete equations for this, together with $X_E^-(7)$ and
$X_E^{\pm}(11)$, in~\cite{Fisher}.

%% Below we will study congruences modulo~$p$ systematically for~$p\ge7$,
%% giving more detail for $p=7$.  The number of congruences in the
%% database for $p=11$, $p=13$, and $p=17$ is small; in the latter case,
%% there is only one such congruence (up to twist), as noted in
%% \cite{Billerey17}.  An explicit form of the Frey-Mazur conjecture (see
%% below) asserts that there should exist no congruences modulo~$p>17$
%% apart from those induced by isogenies.


\subsection{Further motivation} \label{S:motivation}
We finish this introduction with a discussion on how the methods of
this paper complement the local methods in~\cite{FKSym}.

From the discussion so far we know that triples $(E,E',p)$ as above give rise to $\Q$-points on one of the modular curves~$X_E(p)$ or $X_E^-(p)$. 

The Frey-Mazur conjecture states there is a constant $C \geq 18$ such
that, if $E/\Q$ and $E'/\Q$ satisfy $E[p] \simeq E'[p]$ as
$G_\Q$-modules for some prime $p > C$, then $E$ and $E'$ are
$\Q$-isogenous. Theorem~\ref{T:cong19} shows that for curves of
conductor at most~$\numprint{500000}$, this holds with~$C=18$. In view
of this conjecture, any~$(E,E',p)$ with $p > C$ arises from an
isogeny, hence its symplectic type is easily determined by the isogeny
criterion. Thus we are interested in primes $p \leq C$.

%% For $p=3,5$ the modular curves $X(p)$  have genus~0, equations for $X_E(p)$ and $X_E^-(p)$ are well known and we can obtain infinitely many triples $(E,E',p)$ with each symplectic type. 

As mentioned above, it follows from~\cite{FKSym} that if no local
symplectic criterion applies to~$(E,E',p)$ then the image of
$\rhobar_{E,p}$ is irreducible and contains no element of
order~multiple of~$p$. Moreover, when $\rhobar_{E,p}$ is reducible
only the local criteria at primes of multiplicative or good reduction may
succeed and often the bounds on a prime~$\ell$ for which a local
criterion at~$\ell$ applies may not be useful in practice.  From the
strong form of Serre's uniformity conjecture, these `bad' cases for
the local methods imply that either $E$ has Complex Multiplication
(CM) or one of the following holds:
\begin{itemize}
 \item[(i)] $p=3,5,7$ and $\rhobar_{E,p}$ is reducible or has image the normalizer of a Cartan subgroup;
 \item[(ii)] $p=11$ and $\rhobar_{E,p}$ has image the normalizer of non-split Cartan subgroup;
 \item[(iii)] $p=13$ and $\rhobar_{E,p}$ is reducible; 
 \item[(iv)] $p=13$ and $\rhobar_{E,p}$ has exceptional image projectively isomorphic to $S_4$;
 \item[(v)] $p=11,17$ or $37$, and $j(E)$ is listed
 in \cite[Table~2.1]{DahmenPhD}; in particular, $\rhobar_{E,p}$ is reducible.
\end{itemize}
In \cite[Corollary~1.9]{BarinderCrem} there is a list of~$3$ rational
$j$-invariants of elliptic curves over~$\Q$ satisfying~(iv); it has
recently been shown (see~\cite{BDMTV-S4}) that the associated
genus~$3$ modular curve~$X_{S_4}(13)$ found explicitly
in~\cite{BarinderCrem} has no more rational points, and hence that
this list is complete. By Proposition~\ref{P:twist}, none of these
curves is mod~$13$ congruent to a twist of another of them
(including itself); the same is true for the curves and values of~$p$
in case~(v). Thus no examples arise in cases (iv) and (v).

The case~(iii) includes the infinitely many curves with
$\rhobar_{E,13}$ reducible (recall that $X_0(13)$ has genus~0). However, 
to our knowleadge, there are no known reducible mod~$13$ congruences between rational elliptic curves, so there are no known examples in this case either. Nevertheless, in spite of the lack of helpful bounds as mentioned above, a putative congruence
between such curves will often be addressed by local methods in
practice. Indeed, the bounds are very large as they depend on
Tchebotarev density theorem to predict a prime~$\ell$ of good
reduction for~$E$ where Frobenius has order multiple of~$p$ but,
in practice, it is usually easy to find such a prime~$\ell$ after
trying a few small primes.
We refer to \cite[Example~31.2]{FKSym} for
an example with $p=7$ analogous to the discussion in this paragraph.

\nf{Changed the previous paragraph a bit.}

Our method described in Section~\ref{S:statistics} for $p=7$ could be
adapted by replacing the modular curves~$X_E(7)$ by $X_E(p)$ when
explicit equations for the latter are known, which is the case for
$p=3,5$ and~$11$. This method works independently of the image
of~$\rhobar_{E,p}$, so covers the remaining cases (i),~(ii) entirely and also case (v) with $p=11$.

\subsection{Notation} \label{S:notation}
For $p$ an odd prime, define $p^*=\pm p\equiv1\pmod4$, so that
$\Q(\sqrt{p^*})$ is the quadratic subfield of the cyclotomic
field~$\Q(\zeta_p)$.

Let $D_{n}$ denote the dihedral group with~$2n$ elements and $C_n
\subset D_{n}$ for a normal cyclic subgroup of order~$n$; note that
$C_n$ is unique unless $n=2$, in which case $D_{n} \simeq C_2 \times
C_2$ and there are three such subgroups.  We will also denote by $C
\subset \GL_2(\F_p)$ a Cartan subgroup (either split or non-split) and
by $N$ its normalizer in $\GL_2(\F_p)$.

For a number field~$K$ we denote by~$G_K$ the absolute Galois group
of~$K$.

Let $\eps_d$ be the quadratic character of $G_K$ associated to the
extension $K(\sqrt{d})/K$.

For $a, b \in K$, we write $E_{a,b}$ for the elliptic
curve defined over~$K$ by the short Weierstrass equation
$Y^2=X^3+aX+b$; every elliptic curve over~$K$ has such a model, unique
up to replacing $(a,b)$ by~$(au^4,bu^6)$ with $u\in K^*$.

We will denote by~$I$ the identity matrix in~$\GL_2(\F_p)$.

\section{Congruences between Twists}\label{S:cong-twist}

Congruences between elliptic curves which are twists of each other
arise in a number of ways in our study; these are often between quadratic twists but they also occur between higher order twists. In this section we study all types of congruences in detail.

Let $p$ be an odd prime.

Let $K$ be a number field and $E/K$ an elliptic curve. If the
representation $\rhobar_{E,p}$ has image contained in the
normaliser~$N$ of a Cartan subgroup~$C$ of~$\GL_2(\F_p)$ but not
in~$C$ itself, then the projective image $\PP \rhobar_{E,p}(G_K)$ is
isomorphic to~$D_{n}$ for some~$n \geq 2$
(see~\cite[Theorem~XI.2.3]{LangModForms}). The preimage of~$C$
in~$G_K$ then cuts out a quadratic extension~$M = K(\sqrt{d})$
satisfying $\PP \rhobar_{E,p}(G_M) \simeq C_n$.  We will see in
Proposition~\ref{P:twist} that in this setting there is a mod~$p$
congruence between~$E$ and its quadratic twist by~$d$. This
construction is the main source of congruences between twists and it
appeared already in~\cite[\S2]{Halberstadt-11nonsplit}, including a
determination of the symplectic type of the congruence; our
contribution for this type of congruences is to show that congruences
between quadratic twists only occur via this construction, when the
projective image is dihedral: see Theorem~\ref{T:quadratic}. The
second contribution of this section is to classify congruences between
higher order twists in Proposition~\ref{P:higherTwists} and describe
their symplectic type in~Theorem~\ref{T:typeHigher}.

\subsection{Twists of elliptic curves}
\label{S:twists}
Here we recall some standard facts about elliptic curves and their twists.
Let $E$ be an elliptic curve defined over any field~$K$ of
characteristic~$0$.

The twists of $E$ over $K$ are parametrized by $H^1(G_K,\Aut(E))$.  If
$E'$ is a twist of~$E$, then by definition there exists a $\Kbar$-isomorphism
$t:E\to E'$ so that, for all $P\in E(\Kbar)$, we have 
$\sigma(t(P))=\psi(\sigma)t(\sigma(P))$ 
%${}^{\sigma}t=\psi(\sigma)t$ (that is,
%$\sigma(t(P))=\psi(\sigma)t(\sigma(P))$ 
%for all $P\in E(\Kbar)$) 
where~$\psi:G_K\to\Aut(E')\cong\Aut(E)$ is a cocycle.  Here,
$\Aut(E)\cong\mu_n$ is cyclic of order~$n=2$, $4$ or $6$ according as
$j(E)\not\in\{0,1728\}$, $j(E)=1728$ and $j(E)=0$ respectively.  By
Kummer theory, $H^1(G_K,\Aut(E))\cong H^1(G_K,\mu_n)\cong
K^*/(K^*)^n$; hence each $n$-twist is determined by a parameter~$u\in
K^*$ whose image in $K^*/(K^*)^n$ determines the isomorphism class of
the twist. 

In the cases where $\Aut(E)\not=\{\pm1\}$, we make two elementary, but
important, observations. First, $G_K$ acts non-trivially on~$\Aut(E)$,
unless $-1$ or $-3$ (respectively for the cases $n=4$ and $n=6$) are
squares in~$K$, so the cocycle is usually not a homomorphism;
secondly, there are \emph{two} isomorphisms
$\calO=\Z[\zeta_n]\cong\End(E)$ (differing by complex conjugation in
$\calO$), when $n=4$ or~$6$, and hence two actions of
$\calO^*\cong\Aut(E)$ on~$E$.  We fix isomorphisms $\calO\cong\End(E)$
and $\calO\cong\End(E')$, and hence isomorphisms
$\mu_n=\calO^*\cong\Aut(E)\cong\Aut(E')$, which are normalised (in the
sense of \cite[Prop.~I.1.1]{SilvermanII}), so that $\zeta\cdot
t(P)=t(\zeta\cdot P)$ for $P\in E(\Kbar)$ and $\zeta\in\calO^*$. Then
the twist isomorphism~$t$ is an isomorphism of~$\calO$-modules, and we
may view the twisting cocycle~$\psi$ as taking values in~$\calO^*$.

Explicitly, in terms of a short Weierstrass equation~$E_{a,b}$ for~$E$, we fix
the action of~$\zeta\in\calO^*$ to be
$(x,y)\mapsto(\zeta^2x,\zeta^3y)$, and the $n$-twist by~$u\in K^*$ to be
$t:(x,y)\mapsto(v^2x,v^3y)$ where $v \in \overline{K}$ satisfies $v^n=u$. Then the associated cocycle is
$\psi(\sigma)=\sigma(v)/v$, we have
\begin{equation}\label{E:twist}
  \sigma(t(P)) = \psi(\sigma)t(\sigma(P)) = t(\psi(\sigma)\sigma(P))
   \quad \text{ for all } \sigma \in G_K,
  \; P \in E(\Kbar)
\end{equation}
and~$E$ and its $n$-twist by~$u$ become isomorphic
over~$K(\root n\of u)$, which is an extension of~$K$ of degree
dividing~$n$.
We end this subsection with a brief discussion of each kind of twists.

\emph{Quadratic twists}, $n=2$: we usually denote the twist
parameter by~$d$ instead of~$u$, and use the notation $E^d$ for the
quadratic twist of~$E$ by~$d\in K^*$.  If $E=E_{a,b}$ then
$E^d=E_{ad^2,bd^3}$.

\emph{Quartic twists}, $n=4$: only exist when $j(E)=1728$.  The short
Weierstrass model of such a curve has the form~$E_{a,0}$, and its
quartic twist by~$u$ is $E_{au,0}$.

As a special case, when $u=d^2\in(K^*)^2$, with $\pm d\notin(K^*)^2$,
the quartic twist by~$u$ is the same as the quadratic twist by~$d$.
These are just the quartic twists for which the cocycle takes values
in $\{\pm1\}$.  Note that for elliptic curves with
$j$-invariant~$1728$, the quadratic twists by~$+d$ and by~$-d$ are
exactly the same, and in particular the quadratic twist by~$-1$ is trivial.
This is simplest to see from the explicit model $E_{ad^2,0}$ for the
twisted curve.  When $-1$ is a square in~$K$ then it is obvious that
the quadratic twist by~$-1$ is trivial, but this is also true when
$K(\sqrt{-1})\not=K$.  A more intrinsic explanation of this fact is
that the inflation map $H^1(G_K,\mu_2)\to H^1(G_K,\mu_4)$ is not
injective, but has kernel of order~$2$, when $-1$ is not a square
in~$K$.  This is most easily seen using the Kummer isomorphism, under
which the inflation map becomes the squaring map $K^*/(K^*)^2 \to
K^*/(K^*)^4$, which has $-1$ in its kernel.  Thus, when $j(E)=1728$,
the quadratic twists of~$E$ are parametrized not by $K^*/(K^*)^2$ but
by $K^*/\left<-1,(K^*)^2\right>$.

\begin{remark}\label{R:2-isog}
The quartic twist by~$u=-4$ is trivial if and only if $-1$ is a square
in~$K$, since $-4=(1+\sqrt{-1})^4$.  The curves $E_{a,0}$
and~$E_{-4a,0}$ are $2$-isogenous over~$K$ (see
\cite[p.~336]{SilvermanI}); over $K(\sqrt{-1})$ this $2$-isogeny is
the endomorphism $1+\sqrt{-1}$.  Note that this twist is \emph{not} a
quadratic twist, despite the fact that the curve and its twist become
isomorphic over a quadratic extension.  Taking $v=1+\sqrt{-1}$ so that
$v^4=-4$, the cocycle~$\psi$ takes value
$\psi(\sigma)=\sigma(1+\sqrt{-1})/(1+\sqrt{-1})=-\sqrt{-1}$ when
$\sigma$ does not fix~$\sqrt{-1}$.
\end{remark}

\emph{Sextic twists}, $n=6$: only exist when $j(E)=0$.  The short Weierstrass
model of such a curve has the form~$E_{0,b}$, and its sextic twist
by~$u$ is $E_{0,bu}$.  The sextic twist of~$E$ is isomorphic to~$E$
over~$K(\root6\of u)$, which in general has degree~$6$, but special
cases arise when $u$ is either a square or a cube in~$K$.  When
$u=d^3\in(K^*)^3$, with $d\notin(K^*)^2$, we again obtain the
quadratic twist by~$d$ as a special case of a sextic twist; these are
the sextic twists for which the cocycle takes values in $\{\pm1\}$.
(Unlike the case of $j(E)=1728$ we obtain each quadratic twist exactly
once, since the inflation map $H^1(G_K,\mu_2)\to H^1(G_K,\mu_6)$ is
now injective, as is the cubing map $K^*/(K^*)^2 \to K^*/(K^*)^6$.)
When $u\in(K^*)^2$, the sextic twist by~$u$ may be called a
\emph{cubic twist}; these are sextic twists for which the cocycle
takes values in $\mu_3$, and the curve and its twist become isomorphic
over an extension of~$K$ of degree~$3$.

\begin{remark}\label{R:3-isog}
The sextic twist by~$u=-27$ is the quadratic twist by~$-3$, and is
trivial if and only if $-3$ is a square in~$K$.  The curves $E_{0,b}$
and~$E_{0,-27b}$ are $3$-isogenous over~$K$; over $K(\sqrt{-3})$ this
$3$-isogeny is the endomorphism $\sqrt{-3}$.
\end{remark}


\subsection{The mod~$p$ Galois representations of twists}\label{SS:GalRepTwist}
We now consider the effect of twisting~$E$ on the associated mod~$p$ Galois
representations~$\rhobar_{E,p}$.
This is straightforward in the case of quadratic
twists, but more involved for higher twists.


Let~$K$ be a number field. Let $E$ and~$E'$ be elliptic curves
over~$K$ having the same $j$-invariant $j = j(E) = j(E')$. Assume they
are not isomorphic over~$K$. Then $E$ and $E'$ are (non-trivial)
twists and become isomorphic over an extension $L/K$. Write $d = [L :
  K]$.

From the discussion in section~\ref{S:twists}, we have a twist map $t : E \to E'$ with
an associated cocycle~$\psi : G_K \to \mu_m \subseteq\calO^*$, where
$m\in\{2,3,4,6\}$, the \emph{order} of the twist, is the order the
subgroup of~$\calO^*$ generated by~$\psi(G_K)$.  We have the following
cases:
\begin{itemize}
 \item[(i)] for arbitrary~$j$: $m=d=2$ (quadratic twists); and
   additionally,
 \item[(ii)] for $j = 1728$ only: $m=4$ and $d \in \{2,4\}$  (quartic
   twists); and
  \item[(iii)] for $j = 0$ only: $m=d\in\{3,6\}$ (cubic or sextic twists).
\end{itemize}

When $m=4$, the case $d=2$ occurs only for the special
quartic twist by~$-4$ as in Remark~\ref{R:2-isog}.

Denote by $t_p : E[p] \to E'[p]$ the restriction of~$t$ to the
$p$-torsion. Then~\eqref{E:twist} becomes
\begin{equation}\label{E:cocycle}
  \sigma(t_p(P)) = \psi(\sigma) \cdot t_p(\sigma(P))
                 = t_p(\psi(\sigma)\cdot\sigma(P)) 
   \quad \text{ for all } \sigma \in G_K,
  \; P \in E[p].
\end{equation}
Let $P_1, P_2$ be a basis of~$E[p]$, so that $t_p(P_1), t_p(P_2)$ is a
basis of~$E'[p]$.  With respect to these bases, the map~$t_p$ is
represented by the identity matrix in~$\GL_2(\F_p)$ and~$\psi(\sigma)$
by a matrix~$\Psi(\sigma)$ (the same matrix on both $E[p]$
and~$E'[p]$).  Then~\eqref{E:cocycle} implies, for all $\sigma \in
G_K$, the matrix equation
\begin{equation} \label{E:PsiMatrix}
 \rhobar_{E',p}(\sigma) = \rhobar_{E,p}(\sigma) \cdot \Psi(\sigma). 
\end{equation}
For quadratic twists, $\Psi(\sigma)=\pm I$, but in
general~$\Psi(\sigma)$ is not scalar.  Note that $\det\Psi(\sigma)=1$
in all cases, since the determinants of~$\rhobar_{E,p}$
and~$\rhobar_{E',p}$ are both given by the cyclotomic character.

The map $\Psi:G_K\to\SL_2(\F_p)$ becomes a homomorphism over an
extension $K'/K$ given by $K'=K$ if $m=2$, $K'=K(\sqrt{-1})$ if $m=4$
and $K'=K(\sqrt{-3})$ if $m=3,6$. In the quadratic case, $\Psi$
matches the quadratic character~$\varepsilon_d$ associated to the
quadratic extension~$K(\sqrt{d})$ of~$K$ over which the curves become
isomorphic.

In general, the representation attached to the twist of~$E$ is
obtained from that of~$E$ itself twisting by the cocycle~$\Psi$, with
values in~$\GL_2(\F_p)$.  For quadratic twists this is just the tensor product
by a quadratic character.
We summarize this discussion in the following.

\begin{lemma}\label{L:twist-rep} \hfill
  \begin{enumerate}
\item Let $E'$ be the twist of~$E$ by a cocycle~$\psi$. Then there is
  an isomorphism $t :E\to E'$, defined over an extension of $K$ of
  degree at most~$6$, satisfying~\eqref{E:twist}.
  In the case of a quadratic twist with $E'=E^d$, the isomorphism $t$
  is defined over $K(\sqrt{d})$ and satisfies
\begin{equation}\label{E:iso-twist}
\sigma(t (P)) = \eps_d(\sigma)t (\sigma(P)) \qquad\text{for
  all~$\sigma\in G_K$ and $P\in E(\Kbar)$}.
\end{equation}
\item For all primes~$p$ we have in general the matrix
  equation~\eqref{E:PsiMatrix}.
In the case of quadratic twists this simplifies to
  \begin{equation} \label{E:rho-twist}
  \rhobar_{E^d,p} \cong \rhobar_{E,p}\otimes\eps_d.
\end{equation}
\end{enumerate}
\end{lemma}

Assuming that $E$ and $E'$ are $p$-congruent, there exists an
isomorphism $\phi : E[p] \to E'[p]$
of $G_K$-modules. 
Choosing
compatible bases for~$E[p]$ and~$E'[p]$ as above, let~$A \in
\GL_2(\F_p)$ be the matrix representing~$\phi$ with respect to them.
Then, using~\eqref{E:PsiMatrix}, we have
\begin{equation}\label{E:PsiM}
A \rhobar_{E,p}(\sigma) A^{-1} = \rhobar_{E',p}(\sigma) =
\rhobar_{E,p}(\sigma) \cdot \Psi(\sigma) \quad \text{ for all } \sigma
\in G_K
\end{equation}
and the 
symplectic type of~$\phi$ is determined by the square class of $\det A$; this latter conclusion follows 
from the fact that~$t_p$ preserves the Weil pairing and~\cite[Lemma~6]{FKSym}. Moreover, if there is another $A' \in \GL_2(\F_p)$  satisfying~\eqref{E:PsiM} then $\det A' = \det A \cdot \lambda^2$ by Proposition~\ref{P:conditionS} (under the natural assumption that~$E[p]$ satisfies condition~{\bf (S)}) and so symplectic type of~$\phi$ is also determined by~$\det A'$ mod squares.

\begin{comment}
\begin{proof}
Equation (\ref{E:iso-twist}) is a special case
of~\eqref{E:twist}. Relation (\ref{E:rho-twist}) follows immediately
from (\ref{E:iso-twist}) and also from the matrix
equation~\eqref{E:PsiMatrix} since
$\Psi(\sigma)=\varepsilon_d(\sigma)I$.
\end{proof}
\end{comment}

\begin{comment}
 \begin{lemma} \label{L:faithful}
  For all $p\ge3$, the action of $\Aut(E)$ on $E[p]$ is faithful.
\end{lemma}
\begin{proof}
If $\alpha\in\Aut(E)$ acts trivially on~$E[p]$, then the endomorphism
$\alpha-1$ annihilates~$E[p]$ and hence is divisible by~$p$
in~$\End(E)$.  Since $\End(E)\cong\calO=\Z[\zeta_n]$ with $n=2$, $4$
or~$6$, for all $\zeta\in \calO^*$ except $\zeta=1$, the element
$\zeta-1$ is not divisible by any rational prime~$p$ if $\zeta$
has order greater than~$2$, and is only divisible by~$2$ if
$\zeta=-1$.
\end{proof}
\end{comment}

\subsection{Projectively dihedral images}
\label{SS:dihedral}
From Proposition~\ref{P:conditionS}, \condS\ follows from
absolute irreducibility.  Conversely, the next result shows that, in
the presence of a $p$-congruence between twists, \condS\
implies that $\rhobar_{E,p}$ is absolutely irreducible.  Clearly,
elliptic curves with CM can only satisfy \condS\ when the
CM is not defined over the base field~$K$, or when~$p$ ramifies in the
CM field, as otherwise the image is abelian.

\begin{lemma} \label{L:noCyclic}
Let $E/K$ be an elliptic curve and $p$ an odd prime such that~$E[p]$
satisfies \condS.  If $E$ is $p$-congruent to a
twist~$E'$ then $\rhobar_{E,p}$ is absolutely irreducible.
\end{lemma}
\begin{proof}
For a contradiction, suppose $\rhobar_{E,p}$ is absolutely reducible. Thus
\begin{equation} \label{E:absRed}
  \rhobar_{E,p} \otimes \Fbar_p \cong 
 \begin{pmatrix}
 \chi_1 & h \\ 0 &\chi_2
 \end{pmatrix} \quad \text{ with } \; h \neq 0, 
\end{equation} 
where $h \neq 0$ follows from 
the description of the two cases
in Proposition~\ref{P:conditionS}.

Suppose that $j(E)=0$ and $p=3$.  Then $\chi_1$ and $\chi_2$ are
quadratic, their product is the cyclotomic character which is not
trivial since by \condS, $K$ does not contain the CM field
$K(\sqrt{-3})$.  But then $\chi_1\not=\chi_2$, contradicting
\condS, by Proposition~\ref{P:conditionS}.

Similarly, we cannot have $j(E) = 1728$ or $j=0$ and $p\ge5$, as then
$E$ would have CM by~$\Q(i)$ or $\Q(\sqrt{-3})$, and the hypothesis
on~$p$ would imply that the image would be in the normalizer of a
Cartan, contradicting~\eqref{E:absRed}. Therefore $E$ only admits
quadratic twists, and we have $E' = E^d$ for some non-square $d \in
K^*$.

Let $\eps_d$ be the quadratic character associated to the extension
$K(\sqrt{d})/K$. From the hypothesis $E[p] \simeq E^d[p]$, part 2) of
Lemma~\ref{L:twist-rep} and~\eqref{E:absRed} it follows that $\chi_1
=\chi_1\eps_d$ since both give the Galois action on the unique fixed
line. This contradicts ~$\eps_d \neq 1$.
\end{proof}

Under the natural \condS, the previous lemma tells us we can assume
that $\rhobar_{E,p}$ is absolutely irreducible for our study of
congruences between twists. In fact more is true: the next proposition
says that congruences between twists arise when the projective image
is dihedral of order at least~4; equivalently, when the image is
contained in the normaliser of a Cartan subgroup but not in the Cartan
itself.

%% \nf{Do we need whats in bold? The equivalence, being under (S) avoids the small images.}
%% \jc{agreed, deleted}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{comment} %% about 100 lines!
In the rest of this section we will study elliptic curves whose
mod~$p$ representations are projectively dihedral: that is, such that
$\PP \rhobar_{E,p} (G_K) \simeq D_{n}$.  This includes, but is not
restricted to, curves with CM where the extra endomorphisms are not
defined over the ground field.  In the following two subsections we
specialise to the case of curves CM by $\Z[\zeta_4]$ and $\Z[\zeta_6]$
where quartic and sextic twists are possible.  In this subsection we
restrict to quadratic twists, together with the special quartic twist
(see Remark~\ref{R:2-isog}) which becomes trivial over a quadratic
extension.

When $\PP \rhobar_{E,p} (G_K) \simeq D_{n}$, let~$K(\sqrt{d})$ be the
quadratic extension cut out by a cyclic subgroup~$C_n<D_n$ of
index~$2$.  This cyclic subgroup is unique, except when $n=2$ when
there are three possibilities for~$C_2<D_2\cong C_2\times C_2$, and
hence for $K(\sqrt{d})$. In this situation, we will see that
$E[p]\cong E^d[p]$ as $G_K$-modules, and we will determine the
symplectic type of this isomorphism.  This is in accordance with
Theorem~\ref{T:constraint}, since in passing from $K$
to~$K(\sqrt{d})$, the projective image becomes cyclic and hence
(absolutely) reducible.

First we exclude some degenerate cases, where the projective image is
very small, in which case this symplectic type is not well-defined.

\begin{lemma}\label{L:irred}
Let $E$ be an elliptic curve over the number field~$K$, let $p$ be an
odd prime, and suppose that we have a congruence $E[p]\cong E^d[p]$
for some quadratic twist~$E^d$ of~$E$.  If the projective image $\PP
\rhobar_{E,p} (G_K)$ has size at least~$3$ then $E[p]$ is absolutely
irreducible.
\end{lemma}
\textbf{I added ``absolutely'' in the statement and adjusted the proof
accordingly.  Please check whether you agree!}
\begin{proof}
Let $\eps$ be the quadratic character associated to the extension
$K(\sqrt{d})/K$.  Suppose that $V:=E[p]\otimes_{\F_p}\F_{p^2}$ is
reducible.  If $V$ has at least two fixed lines, then $\rhobar_{E,p}$
has the form \(
\begin{pmatrix}\chi_1&0\\0&\chi_2
\end{pmatrix}
\) (over~$\F_{p^2}$) for two characters~$\chi_1$, $\chi_2$, and by
hypothesis, using~(\ref{E:rho-twist}), we have
\[
\begin{pmatrix}\chi_1&0\\0&\chi_2
\end{pmatrix}
\sim
\begin{pmatrix}\chi_1\eps&0\\0&\chi_2\eps
\end{pmatrix}.
\]
The projective image is trivial if $\chi_1=\chi_2$.  Otherwise, since
$\eps$ is not trivial, this equivalence implies $\chi_1=\chi_2\eps$,
so the projective image has order~$2$.

If $V$ has exactly one fixed line then $\rhobar_{E,p}$ has the form \(
\begin{pmatrix}\chi_1&h\\0&\chi_2
\end{pmatrix}
\)
with $h\not=0$, and
\[
\begin{pmatrix}\chi_1&h\\0&\chi_2
\end{pmatrix}
\sim
\begin{pmatrix}\chi_1\eps&h\eps\\0&\chi_2\eps
\end{pmatrix}.
\]
This yields a contradiction, since $\chi_1\not=\chi_1\eps$ but both
give the Galois action on the fixed line.

Hence reducibility of~$E[p]\otimes_{\F_p}\F_{p^2}$, together with
$E[p]\cong E^d[p]$, implies that the projective image has order at
most~$2$.
\end{proof}

When the projective image is~$D_n$ with $n\ge2$, it is often the case
that the image is contained in the normaliser~$N$ of a Cartan
subgroup~$C$ of~$\GL_2(\F_p)$.  For $n=2$, the projective image
is~$D_2\cong C_2\times C_2$, and there are there are three different
choices for~$C$ for which this holds, while for $n\ge3$ the Cartan
subgroup is unique.  The image may be dihedral in other ways, for
example $\left\{\begin{pmatrix}\pm1&*\\0&1\end{pmatrix}\right\}$, but
this is reducible so by the previous lemma does not give rise to a
congruent quadratic twist.
\end{comment}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\jc{Part (2) of the following is essentially the same as Halberstadt's
  Proposition.  But part (1) -- the converse -- and the count are new.}
  
\nf{There is already a summary of H work above, but we can remind the reader of it again either here or in a remark after the proof.}  

\begin{proposition}\label{P:twist}
Let $E/K$ be an elliptic curve and $p \geq 5$ a prime. Suppose
that~$E[p]$ satisfies \condS.

1) If $E$ is $p$-congruent to a twist, 
then the image of~$\rhobar_{E,p}$ is contained in the normaliser of a
Cartan subgroup of $\GL_2(\F_p)$ but not in the Cartan itself and
$\PP \rhobar_{E,p} \simeq D_n$ for some $n \geq 2$.

2) Conversely, if the image of~$\rhobar_{E,p}$ is absolutely irreducible and contained in the
normaliser of a Cartan subgroup of $\GL_2(\F_p)$ but not in the Cartan
subgroup itself, 
then we have $E[p]\cong E'[p]$ where $E'$ is the (non-trivial) twist associated to
the quadratic extension~$K(\sqrt{d})$ cut out by the Cartan subgroup.
This is the quadratic twist~$E^d$ unless $j(E)=1728$ and $d=-1$, in
which case it is the quartic twist by~$-4$.

Moreover, there is a unique such twist~$E'$ which is $p$-congruent to~$E$, except when the
projective image has order~$4$, in which case there are three (non-trivial) such
twists.
\end{proposition}
\begin{proof} 1) Let $E'$ be a $p$-congruent twist of~$E$. If $E'$ is a quartic or sextic twist of~$E$ then $j(E)=0,1728$ and $E$ has CM (not defined over~$K$) by $\Q(\sqrt{-1})$ or
  $\Q(\sqrt{-3})$; moreover, since $p > 3$ it is not ramified in the
  CM field and hence the projective image is absolutely irreducible
  and isomorphic to $D_n$ for some $n \geq 2$.

Therefore we can assume $E' = E^d$ is the quadratic twist of~$E$ by a
non-square $d\in K^*$.  From Lemma~\ref{L:noCyclic} we know
that~$\rhobar_{E,p}$ is absolutely irreducible.

By (\ref{E:rho-twist}), for primes~$\frq$
of~$K$ where both curves have good reduction (so excluding only
finitely many primes), we have
\[
  a_\frq(E^d) = \eps_d(\frq) a_\frq(E),
\]
where $a_\frq(E)$ and $a_\frq(E^d)$ denotes the trace of Frobenius at
$\frq$ of~$E$ and~$E^d$, respectively, and we view $\eps_d$ as a
function on primes of~$K$ unramified in~$K(\sqrt{d})$ as usual via
class field theory.  Moreover, since $E^d[p]\cong E[p]$, we have
\[
  a_\frq(E^d) \equiv a_\frq(E) \pmod{p}.
\]
Hence for almost all primes~$\frq$ satisfying $\eps_d(\frq) = -1$
(i.e. inert in~$K(\sqrt{d})/K$) we have
\[
  a_\frq(E^d) \equiv a_\frq(E) \equiv0 \pmod{p}.
\]
So the image $H=\rhobar_{E,p}(G_K)$ has a
subgroup~$H^+=\rhobar_{E,p}(G_{K(\sqrt{d})})$ of index~$2$ such that
all elements of~$H\setminus H^+$ have trace~$0$; such elements have
order~$2$ in $\PGL_2(\F_p)$. From the irreducibility of~$E[p]$ and the
classification of subgroups of $\PGL_2(\F_p)$ (\cite[Theorem
  XI.2.3]{LangModForms}), it follows that $H$ is contained in the
normaliser of a Cartan subgroup~$C$ and $H^+=H\cap C$.

2) For the converse, suppose that $\rhobar_{E,p}$ is absolutely irreducible and has image contained in
the normalizer $N \subset \GL_2(\F_p)$ of a Cartan subgroup~$C$, but
is not contained in~$C$ itself. Thus $\PP \rhobar_{E,p} \simeq D_n$ for $n \geq 2$ and
$\Tr \rhobar_{E,p}(\sigma) = 0$
for all $\sigma \in G_K$ such that $\rhobar_{E,p}(\sigma) \not\in C$.

Let $K(\sqrt{d})$ be the quadratic extension cut out
by~$\rhobar_{E,p}^{-1}(C)$, with associated character $\eps_d$ as
above.  First suppose that we are not in the special case where
$j(E)=1728$ and $K(\sqrt{d})=K(\sqrt{-1})$.  Set $E'=E^d$, the
quadratic twist.  By~(\ref{E:rho-twist}), for all $\sigma \in G_K$ we
have the following equality of traces
\[\Tr \rhobar_{{E^d},p}(\sigma) = \eps_d(\sigma) \cdot \Tr \rhobar_{E,p}(\sigma).\]

Clearly, if $\eps_d(\sigma)=1$ then $\Tr \rhobar_{E,p}(\sigma) = \Tr \rhobar_{E^d,p}(\sigma)$. 
If $\eps(\sigma) = -1$ then $\rhobar_{E,p}(\sigma) \in \rhobar_{E,p} (G_K) \backslash C$ and $\Tr \rhobar_{E,p}(\sigma) = 0$, so also $\Tr \rhobar_{E^d,p}(\sigma) = 0$.
Then, $\Tr \rhobar_{E,p}(\sigma) = \Tr \rhobar_{E^d,p}(\sigma)$ 
for all $\sigma \in G_K$. 
Since $\rhobar_{E,p}$ and $\rhobar_{E^d,p}$ are absolutely irreducible
and have the same traces, they are isomorphic.

In the special case, $E'$ is the quartic twist of~$E$ by~$-4$, since
these become isomorphic over~$K(\sqrt{-1})$; now $E$ and~$E'$ are
isogenous, so are $p$-congruent for all odd~$p$.

For the last part, we note that $D_2\cong C_2\times C_2$ has three
cyclic subgroups of index~$2$, while $D_n$ for $n\ge3$ has only one
such subgroup.
\end{proof}


\subsection{The symplectic type of congruences between quadratic twists}
\label{SS:typeQuadratic}
A special case of the situation described 
in Proposition~\ref{P:twist} is the case
of elliptic curves with~CM.  Here, the quadratic twists are isogenous
to the original curve so we may already determine the symplectic nature
of the congruence.  For simplicity we state such result over~$\Q$.

\begin{corollary}\label{C:CM-twist}
  Let $E/\Q$ be an elliptic curve with CM by the imaginary quadratic
  order of (negative) discriminant~$-D$.  Set $M=\Q(\sqrt{-D})$.

  \begin{enumerate}
  \item
    For $D\not=4$: $E[p] \simeq E^{-D}[p]$ for all primes $p \geq 5$
    unramified in~$M$ and of good reduction for~$E$.  This congruence
    is symplectic if and only if $\legendre{D}{p}=+1$.  For each
    such~$p$, $E^{-D}$ is the unique quadratic twist of~$E$
    which is $p$-congruent to~$E$.

  \item
    For $D=4$: let $E'$ be the quartic twist of~$E$ by~$-4$, so that
    $E$ and $E'$ are isomorphic over~$M$ but not over~$\Q$.  Again,
    $E[p] \simeq E'[p]$ for all primes $p \geq 5$ unramified in~$M$
    and of good reduction for~$E$.  This congruence is symplectic if
    and only if $\legendre{2}{p}=+1$.  For each such~$p$, there are no
    quadratic twists of~$E$ which are $p$-congruent to~$E$.
  \end{enumerate}
\end{corollary}
\begin{proof}
Since $E$ has CM by~$M$ we know that the image of~$\rhobar_{E,p}$ is
the normalizer of a Cartan for all primes $p$ unramified in~$M$ and of
good reduction for~$E$.  Moreover, $\PP \rhobar_{E,p} \simeq D_n \neq
C_2 \times C_2$ (since $p \geq 5$) and $\PP \rhobar_{E,p}(G_M) \simeq
C_n$. Thus, for each such~$p$, in the notation of
Proposition~\ref{P:twist}, we have $K(\sqrt{d})=M$, so $E[p]\cong
E^{-D}[p]$ except for $D=4$ when $E[p]\cong E'[p]$ with~$E'$ the
quartic twist of~$E$ by~$-4$.  Since the projective image is not~$C_2\times
C_2$, in each case there are no more $p$-congruences with curves
isomorphic to~$E$ over quadratic extensions (cf.~Prop~\ref{P:twist}).

For the symplectic types, observe that $E$ and~$E'$ are isogenous via
an isogeny of degree~$2$ for $D=4$ (see Remark~\ref{R:2-isog}), while
for $D\not=4$, one may check that $E$ and~$E^{-D}$ are isogenous via
an isogeny of degree $D/4$ for $D=8,12,16$, and~$28$ and of degree $D$
otherwise.

The reason for the isogeny degrees is as follows.  We obtain an
isogeny from~$E$ to its twist by composing the twist isomorphism
$t:E\to E^{-D}$ with an endomorphism~$\alpha$ of~$E$.  For
$t\circ\alpha$ to be defined over~$\Q$ we require
$\alpha^{\sigma}=\psi(\sigma)^{-1}\alpha$, where $\sigma$ generates
$\Gal(M/\Q)$ and $\psi$ is the twisting cocycle.  The isogeny will be
cyclic provided that ~$\alpha$ is primitive (not divisible in
$\End(E)$ by any integer other than~$\pm1$).  These conditions uniquely
determine~$\alpha$ up to a unit factor (by a case-by-case computation)
and hence determine the degree $N(\alpha)$.
\begin{comment}
  Apart from the special case $D=4$, we have $\psi(\sigma)=-1$, so
$\alpha$ is pure imaginary.  This uniquely determines~$\alpha$ up to
sign, and the degree of the isogeny is the norm of~$\alpha$:

$D = 3, 7, 11, 19, 43, 67, 163$: $\End(E)\cong\Z[(1+\sqrt{-D})/2]$,
$\alpha=\pm\sqrt{-D}$, norm~$D$.

$D = 16$: $\End(E)\cong\Z[2\sqrt{-1}]$, $\alpha=\pm2\sqrt{-1}$, norm~$4$.

$D = 8$: $\End(E)\cong\Z[\sqrt{-2}]$, $\alpha=\pm\sqrt{-2}$, norm~$2$.

$D = 12$: $\End(E)\cong\Z[\sqrt{-3}]$, $\alpha=\pm\sqrt{-3}$, norm~$3$.

$D = 27$: $\End(E)\cong\Z[3\sqrt{-3}]$, $\alpha=\pm3\sqrt{-3}$, norm~$27$.

$D = 28$: $\End(E)\cong\Z[\sqrt{-7}]$, $\alpha=\pm\sqrt{-7}$, norm~$7$.

When $D=4$ we have $\psi(\sigma)=\pm i$ and $\alpha=\pm1\pm i$, with
norm~$2$.
\end{comment}
For $D\not=4$ we find that~$N(\alpha)=D$ or~$D/4$ so that
$\legendre{N(\alpha)}{p}=\legendre{D}{p}$, while for $D=4$,
$\alpha=\pm1\pm\sqrt{-1}$ of norm~$2$.
\end{proof}


\begin{remark}
In our computed data in Section~\ref{S:statistics}, we do not see
usually isomorphisms arising from CM curves as in this corollary. This
is because (apart from the CM cases where quartic or sextic twists
occur) all such mod~$p$ isomorphisms occur within an isogeny class,
and we have omitted these from consideration.
\end{remark}

Note that if $\PP\rhobar_{E,p} (G_K)$ has order~$1$ or~$2$, then the image
$\rhobar_{E,p} (G_K)$ is cyclic of order dividing~$2(p-1)$ and so not absolutely irreducible. In particular, the smallest projective images occurring in our context
are $\rhobar_{E,p} (G_K) \simeq D_2 \simeq C_2 \times C_2$. The next
result will be used below to determine the symplectic type of
congruences in the presence of this kind of image.

\begin{lemma}\label{L:C2xC2}
Let $p$ be an odd prime.  Let $N$ be a subgroup of~$\PGL_2(\F_p)$
isomorphic to $C_2\times C_2$, so that there are three subgroups~$C< N$
of index~$2$.

If $N\le\PSL_2(\F_p)$, then every such~$C$ is contained in a Cartan
subgroup and $N$ in its normalizer, and each~$C$ is split when
$p\equiv1\pmod4$ and non-split when $p\equiv3\pmod4$.

If $N\not\le\PSL_2(\F_p)$, then for $p\equiv1\pmod4$, one such
subgroup~$C$ is contained in a split Cartan subgroup while the other
two are contained in non-split Cartan subgroups; while if
$p\equiv3\pmod4$ then one~$C$ is non-split and the other two are
split.
\end{lemma}

\begin{proof}
  First note that in~$\PGL_2(\F_p)$, the condition of having zero
  trace is well-defined, and the determinant is also well-defined
  modulo squares.  Also, $\PSL_2(\F_p)$ is the subgroup of~$\PGL_2(\F_p)$ of elements with
  square determinant, which has index~$2$.  Hence either
  $N\le\PSL_2(\F_p)$, and all elements of~$N$ have square determinant,
  or $[N:N\cap\PSL_2(\F_p)]=2$, in which case exactly one of the
  elements of order~$2$ has square determinant.

  Examination of the characteristic polynomial shows that the elements
  of order~$2$ in~$\PGL_2(\F_p)$ are precisely those with trace zero,
  and these elements are split (having $2$ fixed points on
  $\PP^1(\F_p)$) if the determinant is minus a square, and non-split
  (having no fixed points) otherwise.  Hence when $p\equiv1\pmod4$,
  elements of order~$2$ are split if and only if they lie in
  $\PSL_2(\F_p)$, while for $p\equiv3\pmod4$ the reverse is the case.
  The result follows.
\end{proof}

%% Since the map~$t$ is an isomorphism over~$\Qbar$ it preserves the Weil
%% pairing, therefore
%The symplectic type of $\phi : E[p] \simeq E'[p]$ is determined by the
%square class of $\det A$, where $A$ is the matrix of~$\phi$ (see
%\cite[Lemma~6]{FKSym}).

The next theorem describes the symplectic type of congruences between general quadratic twists. 
Since the projective
image is dihedral (by Proposition~\ref{P:twist}), this
is a situation where the local methods from~\cite{FKSym} may not
apply, as is illustrated by Example~\ref{Ex:LocalFail7} below.

\jc{Part (1) is in Halberstadt again; part (2) is new.}

\nf{My previous comment applies here too. Also, maybe we can say something about case (2) is mostly a phenomenon over number fields as it only occurs over~$\Q$ for very small $p$? After giving H credit for part (1) this may help to highlight our generalization.}

\begin{theorem}\label{T:quadratic} 
Let $p > 2$ be a prime. 
Let $E/K$ be an elliptic curve 
$p$-congruent to some quadratic twist~$E^d$.
Assume $E[p]$ is an absolutely irreducible~$G_K$-module.

\begin{enumerate}
%% \item In the case of the special quadratic twist, the congruence is
%%   symplectic if and only if $(2/p)=+1$.

\item Let $C$ be the Cartan subgroup of~$\GL_2(\F_p)$
  associated to the extension $K(\sqrt{d})/K$ in
  Proposition~\ref{P:twist}.  Then the congruence is symplectic if and
  only if \emph{either} $C$ is split and $p \equiv 1 \pmod{4}$,
  \emph{or} $C$ is non-split and $p \equiv 3 \pmod{4}$.

\item When $\PP\rhobar_{E,p}\cong C_2\times C_2$, there are three
  different quadratic\footnote{when $j(E)=1728$ one of these
    is the quartic twist by~$-4$ so not in fact quadratic.}  twists
    of~$E$ which are $p$-congruent to~$E$.  If $\sqrt{p^*}\in K$ then
    all three congruences are symplectic.  Otherwise, one of the
    quadratic twists is by $K(\sqrt{p^*})$ and is symplectic while the
    other two are anti-symplectic.
\end{enumerate}
\end{theorem}
\begin{proof} 
\begin{comment}
\nf{Nuno's version:}

From the hypothesis we can 
choose a basis $P_1, P_2$ of $E[p]$ such that 
$\rhobar_{E,p}$ has image 
contained in the subgroup of $\GL_2(\F_p)$ given by 
\[
\left\{ 
\begin{pmatrix}
a & b\delta \\
b & a
\end{pmatrix}, 
\begin{pmatrix}
a & b\delta \\
-b & -a
\end{pmatrix}  \; : a, b \in \F_p, \; a^2 - \delta b^2 \neq 0 \right\},
\]
where~$C$ is given by the first type of matrices. 
Restricting~\eqref{E:PsiM} to $H$, we see that 
that~$M \in C$ because $\rhobar_{E,p}(H) \subset C$; also, $M$ 
is non-scalar since the twist is non-trivial,
thus~$b \neq 0$. 
Moreover, for $\tau \in G_K - H$ we have 
$M \rhobar_{E,p}(\tau) M^{-1} =-\rhobar_{E,p}(\tau)$ and so $M^2$ commutes with 
$\rhobar_{E,p}(\tau)$, thus it commutes with the whole (non-abelian) image 
of~$\rhobar_{E,p}$. Thus $M^2$ is scalar, hence 
$M$ has projective order~$2$ and so it has trace 0.

We conclude that $\Tr M = 2a = 0$, so $a=0$ (as $p \neq 2$) and $\det
M = -b^2\delta$. Thus $\det M$ is a square mod~$p$ if and only
if~$-\delta$ is a square. Part (1) follows by dividing this condition
into the four different cases.

\jc{John's version:}
\end{comment}

(1) We will define a matrix~$A\in\GL_2(\F_p)$ satisfying~\eqref{E:PsiM}
and $\det(A)=-\delta$,
where $\delta \in \F_p^*$ is a square if $C$ is split and a non-square
if $C$ is non-split.   
Then, the map $E[p]\to E'[p]$ corresponding to~$A$
is then a
$G_K$-equivariant isomorphism which, 
by the discussion following~\eqref{E:PsiM}, 
is symplectic if and only if
$-\delta$ is a square.  From this, 
part~(1) follows by considering the four cases:
$\delta$ square/non-square and $p\equiv\pm1\pmod4$.


Let $H=G_{K(\sqrt{d})}$ be the index~$2$ subgroup cut out by 
the homomorphism~$\varepsilon_d:G_K\to\{\pm 1 \}$.

The projective image $\PP \rhobar_{E,p}(H)$ is a subgroup of $\PP(C) \subset \PGL_2(\F_p)$ and the latter is cyclic of even order~$p\pm1$
(depending on whether~$C$ is split or non-split). Hence $\PP(C)$ contains
a unique element of order~$2$. 
Let $A \in C \subset \GL_2(\F_p)$ be any lift of this element.  Then $A$ is
not scalar, while $A^2$ is scalar, so by Cayley-Hamilton we have
$\Tr(A)=0$ and, 
%$A^2=-\det(A)\cdot I$. 
by the proof of Lemma~\ref{L:C2xC2}, we have that
$-\det(A) = \delta$ is square if and only if the Cartan~$C$ is split.

Since $A$ is central in $\rhobar_{E,p}(G_K)$ modulo scalars, for all
$g\in\rhobar_{E,p}(G_K)$ we have $AgA^{-1}=\lambda(g)g$ with a scalar
$\lambda(g)=\pm I$ (comparing determinants).  Now $\lambda(g)=I$ if and
only if $g$ commutes with~$A$ which---since $A$ is a non-scalar element
of the Cartan subgroup---is if and only if $g$ is itself in the Cartan
subgroup, that is, if and only if $g=\rhobar_{E,p}(\sigma)$ with
$\sigma\in H$, so  \eqref{E:PsiM} holds.

\begin{comment}
\jc{In your proof you start with $M$ defining a non-trivial twist,
  hence satisfying \eqref{E:PsiM}, and show that it has order 2 mod
  scalars.  In my proof I take an $M$ of order $2$ mod scalars and
  show that it satisfies \eqref{E:PsiM} and so defines a isomorphism
  between the twists.  I prefer not to have to write down explicit
  matrices in the Cartan: it seems dangerous to me as we have already
  chosen bases of $E[p]$ and $E'[p]$, but it is OK since after (4.1)
  you start with any basis of $E[p]$.}
  
  \nf{It is OK to delete my proof if your prefer to go matrix free.}
\end{comment}

(2) Since the determinant of $\rhobar_{E,p}$ is the mod~$p$ cyclotomic
character, we have $\PP\rhobar_{E,p}(G_K)\subseteq \PSL_2(\F_p)$ if
and only if $\sqrt{p^*}\in K$.  When this is the case, by
Lemma~\ref{L:C2xC2} we see that each index~$2$ subgroup of the
projective image is split when $p\equiv1\pmod4$ and each is non-split
when $p\equiv3\pmod4$.  By part (1), it follows in both cases that the
congruences between~$E$ and each of the three twists are all
symplectic.

Now suppose that $\sqrt{p^*}\notin K$.  By Lemma~\ref{L:C2xC2} again,
exactly one of the three subgroups is split when $p\equiv1\pmod4$, and
exactly one is non-split when $p\equiv3\pmod4$, so in both cases
exactly one congruence is symplectic.  Moreover, since the subgroup
$C$ inducing the symplectic congruence is the unique one contained in
$\PSL_2(\F_p)$ (see the end of the proof of Lemma~\ref{L:C2xC2}), the
associated quadratic extension is~$K(\sqrt{p^*})$.
\end{proof}

\begin{example} 
\label{Ex:LocalFail7}
Consider the elliptic curve
\[ E : y^2 + y = x^3 - x^2 - 74988699621831x +  238006866237979285299, \]
which has conductor $ N_E = 7^2 \cdot 2381 \cdot
134177^2>2\cdot10^{15}$, so is not in the LMFDB database.  This
example was found using the explicit parametrization of curves for
which the image of the mod~$7$ Galois representation is contained in
the normalizer of a non-split Cartan subgroup; we verified by explicit
computation that the mod~7 image is equal to the full normalizer and that the Cartan subgroup cuts out the field $\Q(\sqrt{d})$ where $d = -7 \cdot 134177$. 

Consider~$E^d$ the quadratic twist
of~$E$ by~$d$. 
From Proposition~\ref{P:twist} we have that $E[7] \simeq E^d[7]$ as $G_\Q$-modules and part (1) of Theorem~\ref{T:quadratic} yields that $E[7]$ and $E^d[7]$ are
symplectically isomorphic (and not anti-symplectically
isomorphic). We note that the same conclusion can be obtained via the general method from Section~\ref{S:statistics} 
and, more interestingly, none of the local criteria
in~\cite{FKSym} applies for this case.
\end{example}

\begin{example} \label{Ex:3twists}
  For an example with projective image~$C_2\times C_2$, let $E$ be the
  elliptic curve with label~\lmfdbec{6534}{a}{1}, of conductor
  $6534=2\cdot3^3\cdot11^2$.  

  The image of the mod~$3$ Galois representation is the normalizer of the split Cartan, which
  is projectively isomorphic to $D_2 = C_2\times C_2$.  The three quadratic
  subfields of the projective $3$-division field are $\Q(\sqrt{-3})$,
  $\Q(\sqrt{-11})$, and~$\Q(\sqrt{33})$; the corresponding quadratic
  twist of~$E$ are $E^{-3}=\lmfdbec{6534}{v}{1}$,
  $E^{-11}=\lmfdbec{6534}{p}{1}$, and $E^{33}=\lmfdbec{6534}{h}{1}$
  respectively.  All four curves have isomorphic mod~$3$
  representations by Proposition~\ref{P:twist}, the isomorphism being antisymplectic between~$E$
  and~$E^{-11}$ and~$E^{33}$, and symplectic between $E$ and~$E^{-3}$,
  in accordance with part (2) of
  Theorem~\ref{T:quadratic}.
\end{example}


\begin{comment}
\begin{theorem} \label{T:Cartan}
Let $p$ be an odd prime. Let $E/K$ be an elliptic curve such that
$\rhobar_{E,p}$ has projective image of order greater than~$2$, and
suppose that for some quadratic twist~$E^d$ we have a congruence
$E[p]\cong E^d[p]$.
\begin{enumerate}
%% \item In the case of the special quadratic twist, the congruence is
%%   symplectic if and only if $(2/p)=+1$.

\item Let $C$ be the Cartan subgroup of~$\GL_2(\F_p)$
  associated to the extension $K(\sqrt{d})/K$ in
  Proposition~\ref{P:twist}.  Then the congruence is symplectic if and
  only if \emph{either} $C$ is split and $p \equiv 1 \pmod{4}$,
  \emph{or} $C$ is non-split and $p \equiv 3 \pmod{4}$.

\item When $\PP\rhobar_{E,p}\cong C_2\times C_2$, there are three
  different quadratic\footnote{as above, when $j(E)=1728$ one of these
    is the quartic twist by~$-4$ so not in fact quadratic.}  twists
    of~$E$ which are $p$-congruent to~$E$.  If $\sqrt{p^*}\in K$ then
    all three congruences are symplectic.  Otherwise, one of the
    quadratic twists is by $K(\sqrt{p^*})$ and is symplectic while the
    other two are anti-symplectic.
\end{enumerate}
\end{theorem}

\begin{proof}
%% (1) In this case we know by Remark~\ref{R:2-isog} that $E^{-1}$ is
%%   $2$-isogenous to~$E$, so the result follows by the isogeny
%%   criterion.  Assume from now on that this is not the case.

(1) As usual, write $\eps_d$ for the quadratic character of~$G_K$
  fixing~$K(\sqrt{d})$.  By Lemma~\ref{L:twist-rep}, there exists an
  isomorphism~$\alpha: E \to E^d$ satisfying~(\ref{E:iso-twist}).  Let
  $t: E[p](\Qbar) \to E^d[p](\Qbar)$ denote the induced map on
  $p$-torsion points; this is an $\F_p$-linear isomorphism but is not
  Galois equivariant: in fact, (\ref{E:iso-twist}) implies that
\begin{equation} \label{E:eps}
 t(\sigma(P)) = \eps_d(\sigma)\cdot\sigma(t(P)) \quad \text{ for all } \sigma \in G_K
 \text{ and all } P \in E[p].
\end{equation}
Since $\alpha$ is an isomorphism over~$\Qbar$, $t$ preserves the Weil
pairing.

Let $\delta\in\F_p^*$ be a fixed square if the Cartan subgroup~$C$ is
split, and a fixed non-square if it is non-split.  We shall define a
map~$s:E[p]\to E[p]$ satisfying
\begin{enumerate}
  \item $s$ is an~$\F_p$-linear isomorphism;
  \item  $s(\sigma(P)) = \eps_d(\sigma)\cdot\sigma(s(P)) \quad \text{ for all } \sigma \in G_K
    \text{ and all } P \in E[p]$; 
  \item $e_p(s(P),s(Q)) = e_p(P,Q)^{-\delta}$ for all $P,Q\in E[p]$.
\end{enumerate}
Note that~(2) is identical to property~(\ref{E:eps}) satisfied
by~$t$. Thus, given such an~$s$, the composite $t\circ s:E[p]\to
E^d[p]$ is a Galois equivariant isomorphism which by~(3) is symplectic
if and only if the Legendre symbol $(-\delta/p) = 1$ and
anti-symplectic otherwise. The result now follows by simple case
checking.

\def\rd{\sqrt{\delta}} Define the $2$-dimensional
$\F_p$-algebra~$A=\F_p[X]/(X^2-\delta)$.  Then $A\cong\F_p\oplus\F_p$
or $\F_{p^2}$ (as $\F_p$-algebras) in the split and non-split cases
respectively.  We write $\sqrt{\delta}$ for the image of~$X$ in~$A$,
which is a generator of~$A$ as $A$-algebra; note that in the split
case $\rd$ does not refer to a square root of~$\delta$ in~$\F_p$.
Denote by $x\mapsto\overline{x}$ the nontrivial automorphism of~$A$,
mapping $\rd$ to $-\rd$.

The Cartan subgroup~$C$ may be identified with the group of
units~$A^{\times}$, and hence with the group of $A$-linear
automorphisms of~$A$: these are maps~$f$ of the form $x\mapsto ax$ for
some $a\in A^{\times}$.  Similarly, $N$ is identified with the group
of semi-linear automorphisms of~$A$; explicitly, elements of
$N\setminus C$ correspond to conjugate-linear maps $A\to A$,
\textit{i.e.}, maps~$f$ of the form $x\mapsto a\overline{x}$ for
some~$a\in A^{\times}$.

From the hypothesis on the image of $\rhobar_{E,p}$, we may identify
$A$ with~$E[p]$ in such a way that, for $\sigma\in G_K$, if
$\eps_d(\sigma)=+1$ so that $\rhobar_{E,p}(\sigma)\in C$, the induced
action of~$\sigma$ on~$A$ is linear, while if $\eps_d(\sigma)=-1$ so
that $\rhobar_{E,p}(\sigma)\in N\setminus C$, the induced action
of~$\sigma$ on~$A$ is conjugate linear.

Now let $s:E[p]\to E[p]$ be the map, which when considered as a map
$A\to A$ under this identification, is given by multiplication
by~$\rd$.  This is clearly $\F_p$-linear, and since linear maps
commute, we see that $s(\sigma(P))=\sigma(s(P))$
whenever~$\eps_d(\sigma)=+1$. Also, $\overline{\rd}=-\rd$ implies that
multiplication by~$\rd$ anticommutes with conjugate-linear maps, so
$s(\sigma(P))=-\sigma(s(P))$ whenever~$\eps_d(\sigma)=-1$.  Hence $s$
satisfies properties (1) and~(2).

Define $\left<\; , \right>:A\times A\to \mu_p$ to be the pairing which
under our identification $A\cong E[p]$ corresponds to the Weil
pairing.  This is $\F_p$-bilinear and alternating.  For all $x,y\in A$
and~$a\in A^{\times}$ we have $\left<ax,ay\right> =
\left<x,y\right>^{N(a)}$, where $N(a)=a\overline{a}$ is the norm map
from~$A$ to~$\F_p$.  This follows from the $\F_p$-linearity of
multiplication by~$a$, together with the facts that the pairing is
alternating and that (by definition) $N(a)$ is the determinant of
multiplication by~$a$.  Taking $a=\rd$ we have $N(\rd)=-\delta$, and we see
that $\left<\rd x,\rd y\right> = \left<x,y\right>^{-\delta}$, and
hence that $e_p(s(P),s(Q)) = e_p(P,Q)^{-\delta}$ for all $P,Q\in
E[p]$, as required.


(2) Since the determinant of $\rhobar_{E,p}$ is the mod~$p$ cyclotomic
character, we have $\PP\rhobar_{E,p}(G_K)\subseteq \PSL_2(\F_p)$ if
and only if $\sqrt{p^*}\in K$.  When this is the case, by
Lemma~\ref{L:C2xC2} we see that each index~$2$ subgroup of the
projective image is split when $p\equiv1\pmod4$ and each is non-split
when $p\equiv3\pmod4$.  By part (2), it follows in both cases that the
congruences between~$E$ and each of the three twists are all
symplectic.

Now suppose that $\sqrt{p^*}\notin K$.  By Lemma~\ref{L:C2xC2} again,
exactly one of the three subgroups is split when $p\equiv1\pmod4$, and
exactly one is non-split when $p\equiv3\pmod4$, so in both cases
exactly one congruence is symplectic.  Moreover, since the subgroup
$C$ inducing the symplectic congruence is the unique one contained in
$\PSL_2(\F_p)$, the associated quadratic extension is~$K(\sqrt{p^*})$.
\end{proof}
\end{comment}

\begin{comment}
\subsection{Restrictions on the image}
The following theorem is the main constraint on the existence of congruences between twists.

\begin{theorem} \label{T:constraint}
Let $E$ be an elliptic curve defined over a number field~$K$, and let
$E'$ be a twist of~$E$, isomorphic to $E$ over an extension $L/K$.
Suppose that for some prime $p>2$ there is a $p$-congruence
between~$E$ and~$E'$.

If $E[p]$ (and hence also $E'[p]$) 
is absolutely irreducible 
both as a
$G_K$-module and also as $G_L$-module, then the twist is trivial; that
is, $E$ and~$E'$ are isomorphic over~$K$ itself.
\end{theorem}

\begin{proof}
Let $t :E\to E'$ be an isomorphism defined over~$L$ satisfying
$t ^\sigma=\psi(\sigma)t $ as in Lemma~\ref{L:twist-rep},
where $\psi$ is a cocycle trivial on~$G_L$.  Let $t_p$ denote the
induced map $E[p]\to E'[p]$, which is $\F_p$-linear and also satisfies
the twist relation $t _p^\sigma=\psi(\sigma)t _p$, so
$t _p$ is $G_L$-equivariant.  We are also given a
$G_K$-equivariant isomorphism $\varphi:E[p]\to E'[p]$.  Since both
$t _p$ and~$\varphi$ are $G_L$-equivariant isomorphisms between
the absolutely irreducible $G_L$-modules $E[p]$ and~$E'[p]$, they
differ by a scalar, so there exists $n\in\F_p^*$ such that
$t _p=[n]\circ\varphi$.  (Here, $[n]$ denotes the multiplication
by~$n$ endomorphism of both $E[p]$ and $E'[p]$.)  But $[n]$ is
$G_K$-equivariant, hence so is $t _p$: that is, $t _p^\sigma =
t _p$ for all~$\sigma\in G_K$.

It remains to show that $t $ itself is $G_K$-equivariant;
equivalently, that $\psi$ is trivial.  For all $\sigma\in G_K$, we
have $t _p = t _p^\sigma = \psi(\sigma)t _p$, so (since $t _p$ is an
isomorphism), $\psi(\sigma)$ acts trivially on~$E'[p]$.  Hence $\psi$
is trivial, by Lemma~\ref{L:faithful}, and $E\cong E'$ over~$K$ as
required.
\end{proof}

We define the \emph{projective $p$-division field} $F$ of an elliptic
curve~$E$ defined over $K$ to be the fixed field of the kernel of the
projective representation~$\PP \rhobar_{E,p}$. 


Note that both the
irreducibility and absolute irreducibility of~$\rhobar_{E,p}$ only
depend on its projective image, since $\rhobar_{E,p}$ is irreducible if
and only if $\PP \rhobar_{E,p}$ has no fixed points in its action
through~$\PGL_2(\F_p)$ on~$\PP E[p]\cong\PP^1(\F_p)$, while
$\rhobar_{E,p}$is absolutely irreducible if and only if $\PP
\rhobar_{E,p}$ has no fixed points in its action
through~$\PGL_2(\F_p)\subset\PGL_2(\F_{p^2})$ on~$\PP
(E[p]\otimes_{\F_p}\F_{p^2})\cong\PP^1(\F_{p^2})$.

The preceding theorem shows that very few twists of~$E$, if any, can be
$p$-congruent to~$E$, since $E[p]$ must lose the property of being
absolutely irreducible after base-change to a small degree extension
$L/K$. The following two results show that the two fields $F$ and $L$ are related in the presence of a congruence between twists.

\begin{corollary}\label{C:constraint}
Suppose that $p>2$ and $E[p]$ is absolutely irreducible as
$G_K$-module.  Let $F$ be the projective $p$-division field of~$E$.
If $E$ is $p$-congruent to a proper twist $E'$ (not isomorphic to~$E$
over~$K$), and $L\supsetneq K$ is an extension of~$K$ over which $E$
and~$E'$ become isomorphic, then $E[p]$ is not absolutely irreducible
as $G_L$-module and $K\subsetneq L\cap F\subseteq F$.
\end{corollary}

\begin{proof}
Apart from the last assertion this is just a restatement of
Theorem~\ref{T:constraint}.  To prove the last assertion, we certainly
have $K\subseteq L\cap F\subseteq F$, and if $K=L\cap F$ then the
projective image of~$G_L$ would be the same as that of~$G_K$,
so~$E[p]$ would be absolutely irreducible as~$G_L$-module.
\end{proof}

\begin{lemma}\label{L:dihedral-to-reducible}
In the notation of the previous corollary, suppose that
$\Gal(F/K)\cong D_n$ for some $n\ge3$.  Let $M=L\cap F$ Then $[M:K]
\ge3$ unless $\Gal(F/M)$ is the unique cyclic subgroup of~$\Gal(F/K)$
of order~$n$, in which case $[M:K]=2$.
\end{lemma}
\begin{proof}
If $[M:K]=2$ and $F/M$ is not cyclic, then $n$ is even and
$\Gal(F/M)\cong D_{n/2}$ which is absolutely irreducible.
\end{proof}

\begin{lemma} \label{L:LinF}
Let $p > 2$ be a prime and $n \in \{2,4,6\}$.  Let $E/K$ be an
elliptic curve such that $E[p]$ is an absolutely irreducible
$G_K$-module, admitting a $p$-congruence to its non-trivial $n$-twist
by~$u \in K$. Let $L = K(\root n \of u)$ and let $F$ be the projective
$p$-division field of~$E$.

Then $L \subseteq F$, except in the following cases:
\begin{enumerate}
\item $j(E)=1728$ and $\Gal(F/K)\cong D_2$;
\item $j(E)=0$ and $\Gal(F/K)\cong D_2$ or $D_3$.
\end{enumerate}
\end{lemma}

\begin{proof} 
Let $E'$ be the twist of~$E$ by~$u$.  Since the curves $E$ and $E'$
are isomorphic over $L$, we have $K\subsetneq L\cap F\subseteq F$ by
Corollary~\ref{C:constraint}.  We divide the rest of the proof in
three cases:

(i) If $[L : K]$ is prime, that is $[L : K] \in \{2, 3\}$, then
$K\subsetneq L\cap F\subseteq L$ implies $L\cap F=L$, so $L \subseteq
F$. This covers the case $n=2$, the cases for $n=6$ where $u$ is a
square or a cube, the cases for $n=4$ with $u$ a square and also the
special case $n=4$, $u=-4$ mod $4$th powers discussed in
Remark~\ref{R:2-isog}.

(ii) Suppose $n=4$ with $[L : K]=4$. Thus $j(E) = 1728$ and $E$ has CM
by~$\Q(\sqrt{-1})$. Also, $\sqrt{-1} \not\in K$ as $E[p]$ is
absolutely irreducible.

If $u$ is minus a square we can write $u=-4v^2$ in~$K$. Let $E''$ be the
quartic twist of~$E'$ by~$-4$, which is $2$-isogenous to~$E'$ and hence $p$-congruent
to~$E$. Further, $E''$ is the quartic twist of~$E$ by~$u' =  -4u = (-4v)^2$ and thus $[K(\root 4 \of {u'}) : K] = 2$.
Applying case (i)
to the pair~$(E,E'')$ shows that $\root4\of{-4u}\in F$, which implies
that $\root4\of{u}\in F$ since $\root4\of{-4}=1+\sqrt{-1}\in F$.
Hence we may assume $u \neq -1$ mod squares, that is $K(\sqrt{u}) \not= K(\sqrt{-1})$.

The subfields of~$L$ are $K$, $M=K(\sqrt{u})$ and $L$, and so $M
\subseteq F \cap L$ because $F \cap L \neq K$.  If $M=F\cap L$ then
the projective images of~$G_M$ and~$G_L$ are the same, so the
projective image of~$G_M$ is not absolutely irreducible by
Corollary~\ref{C:constraint}.  By Lemma~\ref{L:dihedral-to-reducible}
this is only possible if $[F:K]=4$ with Galois group~$D_2$, as
otherwise $M$ would be the quadratic subfield of~$F$ cut out by the
maximal cyclic subgroup, which is~$K(\sqrt{-1})$.

(iii) Suppose $n=6$ with $[L : K]=6$. Thus $j(E) = 0$ and $E$ has CM
by $\Q(\sqrt{-3})$. Also, $\sqrt{-3} \not\in K$ as $E[p]$ is
absolutely irreducible. We have $L = K(\sqrt{u},\root 3 \of u)$, and
$u$ is neither a square nor a cube in~$K$.

If $u$ is $-3$ times a square in~$K$ we can write $u=-27v^2$. Let
$E''$ be the sextic twist of~$E'$ by~$-27$, which is $3$-isogenous
to~$E'$ and hence $p$-congruent to~$E$.  Further, $E''$ is the sextic
twist of~$E$ by~$u' = -27u = (-27v)^2$ and thus $[K(\root 6 \of {u'})
  : K] = 3$.  Applying case (i) to the pair~$(E,E'')$ shows that
$\root6\of{-27u}\in F$, which implies that also $\root6\of{u}\in F$
since $\root6\of{-27}=3/\sqrt{-3}\in F$.  Hence we may assume that $u
\neq -3$ mod squares, that is $K(\sqrt{u}) \not= K(\sqrt{-3})$.

Let $M = F \cap L$.  Since $M\not=K$ we have $M = K(\sqrt{u}), K(\root
3 \of{u})$ or~$L$.  The projective image of~$G_M$ is the same as that
of~$G_L$, hence not absolutely irreducible.  In case $M=K(\sqrt{u})$
this is (as in (ii)) only possible if $[F:K]=4$ with Galois
group~$C_2\times C_2$, and in case $M=K(\root3\of{u})$ this is only
possible $[F:K]=6$ with Galois group~$D_3$, by
Lemma~\ref{L:dihedral-to-reducible}.
\end{proof}

\jc{to be completed: so far I have not succeeded!}.

Assuming that $E$ and $E'$ are $p$-congruent, there exists an
isomorphism of $G_K$-modules $\phi : E[p] \to E'[p]$.  Choosing
compatible bases as in subsection~\ref{SS:GalRepTwist},  let~$A \in
\GL_2(\F_p)$ be the matrix representing~$\phi$ with respect to these.
Then, using~\eqref{E:PsiMatrix}, we have
\begin{equation}\label{E:PsiM}
A \rhobar_{E,p}(\sigma) A^{-1} = \rhobar_{E',p}(\sigma) =
\rhobar_{E,p}(\sigma) \cdot \Psi(\sigma) \quad \text{ for all } \sigma
\in G_K.
\end{equation}
Recall that $\Psi(\sigma)$ is the matrix of~$\psi(\sigma)\in
\Aut(E)\cong\calO^*$ acting on~$E[p]$, where $\psi$ is the cocycle
associated to the twist.

This equation implies a tight restriction on the size of the
projective image when there is a congruence with a higher twist.

\begin{lemma}\label{L:dihedral}
Let~$p$ be an odd prime. Let~$E$ and~$E'$ be quartic, cubic or sextic
twists which are $p$-congruent, with absolutely irreducible
$p$-torsion. Assume also that $E$ and~$E'$ are not isomorphic over a
quadratic extension.

Then $\PP\rhobar_{E,p}(G_K)$ is $D_4$ in the case of quartic twists,
it is~$D_3$ for cubic twists and is either $D_3$ or~$D_6$ in the case
of sextic twists.
\end{lemma}
\begin{proof} From Proposition~\ref{P:twist} we already know the
  projective image is dihedral.

Let $K'=K(\sqrt{-1})$ in the case of quartic twists and
$K'=K(\sqrt{-3})$ in the case of cubic or sextic twists. Our
hypothesis guarantees that the curves are neither quadratic twists nor
the special quartic twist by~$-4$.  Let $m\in\{4,3,6\}$ be the order
of the twist.  Then the map $\sigma \mapsto \Psi(\sigma)$
where~$\Psi(\sigma)$ is as in~\eqref{E:PsiMatrix} restricts to a homomorphism
$G_{K'}\to\SL_2(\F_p)$ of order~$m$.  Let $F'/K'$ be the fixed field
of its kernel.  Then $F'=K'(\root m\of u)$ where $E'$ is the twist
of~$E$ by~$u$, with Galois groups $\Gal(F'/K')\cong C_m$ and
$\Gal(F'/K)\cong D_m$.

Equation~\eqref{E:PsiM} holds for some matrix~$A$, which is non-scalar
since $\Psi(\sigma)$ is non-trivial, and, since
$\rhobar_{E,p}(G_{K'})$ is in a Cartan subgroup~$C$, we conclude that
$A \not\in C$. Restricting~\eqref{E:PsiM} to~$G_{F'}$ shows that $A$
commutes with $\rhobar_{E,p}(G_{F'}) \subset C$, hence
$\rhobar_{E,p}(G_{F'})$ is scalar and so projectively trivial.  Hence
$F'$ contains the projective division field~$F \supset K'$.  To complete the
proof we must determine the degree~$[F':F]$.

Let $\overline{\Psi}(\sigma)$ denote the image of~$\Psi(\sigma)$
in~$\PSL_2(\F_p)$.  The map $\sigma \mapsto \overline{\Psi}(\sigma)$ is
a homomorphism $G_{K'}\to\PSL_2(\F_p)$ of order~$2$ when $n=4$ and~$3$
when $n=3,6$, since the only scalar matrix~$\Psi(\sigma)$ is $-I$
when $n$ is even.

%% The fixed field of its kernel is $F/K'$, so $\Gal(F/K)\cong D_2$
%% or~$D_3$.

\jc{Now we need to say why $-I$ is not in the image when $n=4$, and
  may not be when $n=6$.}

This already implies the result in the cases of quartic and cubic
twists; to show the case~$D_6$ occurs we observe that the Galois
closure of the field~$L=K(\sqrt{u},\root 3 \of u)$ appearing in case
(iii) in the proof of Lemma~\ref{L:LinF} is precisely~$F$ as defined
above.
\end{proof}

\jc{Notation in the following does not match what we used above where
  I used ``$n$-twist'' to mean a twist of order~$n$.  See the start of
subsection 2.2, where this order was denoted $m$.}

\begin{corollary}
Let~$p$ be an odd prime and $n \in \{4,6 \}$. Let~$E/K$ and~$E'/K$ be $n$-twists by~$u \in K$ which are $p$-congruent. 
Assume $E$ and~$E'$
are not isomorphic over a quadratic extension of~$K$. Suppose also that $\sqrt{-1} \not\in K$ or
$\sqrt{-3} \not\in K$ if $n=4$ or $n=6$, respectively.

Let~$F$ denote the common projective $p$-division field of~$E$ and~$E'$. Then,

1) $F = K(\sqrt{-1}, \root 4 \of u)$ and $\Gal(F/K) \simeq D_4$ if~$n = 4$.

2) $F = K(\sqrt{-3}, \root 3 \of u)$
and $\Gal(F/K) \simeq D_3$ if $n=6$ and $u$ is a square.

3) $F = K(\sqrt{-3}, \root 6 \of u)$
and $\Gal(F/K) \simeq D_6$ if $n=6$ and $u$ is not a square.
\end{corollary}
\begin{proof} This follows directly from the proof of Lemma~\ref{L:LinF} and the previous lemma.
\end{proof}

\end{comment}

\subsection{Congruences between higher order twists} \label{SS:higherCong}
In this section we will study, under condition~{\bf (S)}, the congruences between an elliptic curve~$E/K$ and its quartic, cubic or sextic twists by~$u \in K$.

Note that if $u = -s^2$ then $u = -4(s/2)^2$ and the quartic twist by~$u$ is obtained by composing the quartic twist by $-4$ with a quadratic twist; similarly, if $u = -3s^2$ then $u = -27(s/3)^2$ and the sextic twist by~$u$ is obtained by composing the quadratic twist by $-27$ with a cubic twist. Since the quartic twist by~$-4$ and the quadratic twist by~$-27$ correspond to isogenies (see Remarks~\ref{R:2-isog} and~\ref{R:3-isog}) their effect on the symplectic type is known;
observe also that both these cases are covered by the theory in sections~\ref{SS:dihedral} and~\ref{SS:typeQuadratic}. 
In view of this, we fix the following natural assumptions for this and the next section. 

Let $p$ be an odd prime. 
Let $E/K$ be an elliptic curve 
with $j(E) = 0, 1728$ and let~$u \in K$.
\begin{itemize}
 \item If $j(E) = 1728$, assume also $K'=K(\sqrt{-1}) \neq K$, 
 $u \neq -4$ modulo~$4$-th powers and $u \neq -1$ modulo squares;
 \item If $j(E) = 0$, assume also $K'=K(\sqrt{-3}) \neq K$, 
 $u \neq -3$ modulo squares and
$p\not=3$. 
\end{itemize}

\begin{lemma} \label{L:diagonalC}
Let~$E/K$ be as above. 
\begin{enumerate}
  \item
The projective image $\PP\rhobar_{E,p}(G_K)$ is dihedral $D_n$ for
some $n\ge2$, and the projective image of $G_{K'}$ is $C_n$.
\item
After extending scalars from~$\F_p$ to~$\F_{p^2}$ if necessary, there
is a basis for~$E[p]$ with respect to which for $\sigma\in G_{K'}$ we
have
\begin{equation}
 \label{E:diagonalC}
\rhobar_{E,p}(\sigma) = c(\sigma)\cdot\diag(1,\eps(\sigma))
\end{equation}
with $c(\sigma)\in\overline{\F}_p^*$ and
$\eps:G_{K'}\to\overline{\F}_p^*$ a character of exact order~$n$.
\end{enumerate}
\end{lemma}
\begin{proof}
Part (1) follows from standard facts on~CM curves plus our running assumptions and~(2) follows by diagonalising the Cartan over $\F_p$ in
  the split case and over~$\F_{p^2}$ in the non-split case.
\end{proof}
%% \nf{Isn't $c_\sigma$ a character? Wouldn't be better a notation
%%   looking more like a character? $c(\sigma)$?}  \jc{You are right and
%%   I changed it.  I was using notation usual for cocycles, but that is
%%   not necessary since $c()$ is only defined on $G_{K'}$}.
\begin{lemma}\label{L:DiagonalPsi}
Let~$E/K$ and~$u\in K^*$ be as above.  For $m\in\{3,4,6\}$, let $\psi$
be the order~$m$ cocycle associated to~$u$, with values
in~$\Aut(E)\cong\calO^*$ where $\calO\cong\Z[\zeta_m]$.

After extending scalars to~$\Fbar_p^*$ and changing basis so that
\eqref{E:diagonalC} holds, the matrices $\Psi(\sigma)$
in~\eqref{E:PsiMatrix} become diagonal.  More precisely,
\[
\Psi(\sigma) = \diag(\eta(\sigma),\eta(\sigma)^{-1})
\]
where $\eta:G_K\to \overline{\F}_p^*$ is a map whose restriction to
$G_{K'}$ is a homomorphism of order exactly~$m$.
\end{lemma}
\begin{proof}
Recall that we have fixed an isomorphism 
$\End(E)\cong\calO$ and
that $\rhobar_{E,p}(G_{K'}) \subset C$ for some Cartan subgroup~$C \in \GL_2(\F_p)$.
Hence $\calO$ acts on $E[p]$ 
via matrices which are in~$C$ since the endomorphisms
are all defined over~$K'$ and so their action commutes with that
of~$G_{K'}$, which is not scalar. Note that the basis giving~\eqref{E:diagonalC} diagonalizes the whole of~$C$, therefore~$\Psi(\sigma)$ is diagonal. Finally,  
an endomorphism~$\alpha$ acts via a matrix of determinant~$\deg(\alpha)$ so $\calO^*$ acts via diagonal matrices of determinant~$1$ as stated.

The map~$\eta$ is obtained as follows.  In the split case
$p\calO=\frp\overline{\frp}$ and $\eta(\sigma)$ is the image of
$\psi(\sigma)$ under the isomorphism
$\End(E)\cong\calO$ followed by the reduction
$\calO\to\calO/\frp\cong\F_p$ which induces a reduction homomorphism
$\eta:\calO^*\to\F_p^*$.  Interchanging~$\frp$ and~$\overline{\frp}$
has the effect of replacing~$\eta$ by its inverse; we make an
arbitrary but fixed choice.

In the non-split case, $p\calO=\frp$ and 
$\eta(\sigma)$ is the image
of $\psi(\sigma)$ under the isomorphism followed by the reduction
$\calO\to\calO/\frp\cong\F_{p^2}$. 
This induces a 
homomorphism $\eta: \calO^*\to\F_{p^2}^*$ for which there are two
choices since we may compose with the nontrivial
automorphism of~$\F_{p^2}$.

By definition, the map~$\eta$ becomes a homomorphism of order~$m$ when restricted to~$G_{K'}$ because this is the case for~$\psi$ by cases (ii) and (iii) 
of section~\ref{SS:GalRepTwist}, given that we have excluded the special quartic twist by~$u=-4$.
\end{proof}

\begin{lemma}\label{L:EpsEta}
  Keeping the notation of Lemmas~\ref{L:diagonalC}
  and~\ref{L:DiagonalPsi}, let $E'$ be the order~$m$ twist of~$E$
  by~$u$ with~$m \in \{3,4,6\}$, and suppose also that $E$ and $E'$
  are $p$-congruent.  Then $\eps(\sigma)=\eta(\sigma)$ for all
  $\sigma\in G_{K'}$, and $\PP \rhobar_{E,p}(G_K) \simeq D_n$ where
  $n=m$.
\end{lemma}
\begin{proof}
  Let $A\in\GL_2(\F_p)$ be the matrix of an isomorphism~$E[p]\to
  E'[p]$.  For $\sigma\in G_{K'}$ we have, from \eqref{E:PsiM} and
  after cancelling the scalar factor~$c(\sigma)$ from each side,
\[
A\ \diag(1,\eps(\sigma))\ A^{-1} = \diag(1,\eps(\sigma))\; \diag(\eta(\sigma),\eta(\sigma)^{-1}).
\]
Now since $A$ conjugates a non-scalar diagonal matrix into another
diagonal matrix, it is either itself diagonal or is anti-diagonal.
But $A$ cannot be diagonal since that would imply $\eta(\sigma)=1$ for
all $\sigma\in G_{K'}$ (which is not the case because we have excluded the special quartic twist), so $A$ is anti-diagonal.  Therefore, conjugating any
diagonal matrix by~$A$ just interchanges the two diagonal entries, so
the previous equation becomes
\[
\diag(\eps(\sigma),1) = \diag(1,\eps(\sigma))\; \diag(\eta(\sigma),\eta(\sigma)^{-1}).
\]
Hence $\eps(\sigma)=\eta(\sigma)$ for all $\sigma\in G_{K'}$, thus $n=m$ and the
statement of the lemma follows.
\end{proof}

The preceding lemma shows that, for $n\in\{4,3,6\}$, a necessary
condition for the existence of a $p$-congruence between~$E$ with a twist~$E'$ of order~$n$ 
is that the projective mod~$p$ image is isomorphic to $D_n$.  We next show
that this condition is also sufficient.

\begin{proposition} \label{P:higherTwists}
Let $E/K$ and $p$ be as above. Suppose that $\PP \rhobar_{E,p}(G_K) \simeq D_n$ where $n=4$ if
$j(E)=1728$ and $n\in\{3,6\}$ if $j(E)=0$.
Then $E$ is $p$-congruent to an $n$-twist.  

Moreover, for $n=3$ there is a
unique such twist, while for $n=4$ there are two which are
$2$-isogenous to each other and for $n=6$ there are two which are
$3$-isogenous to each other.
\end{proposition}

\begin{proof} 
The projective $p$-division field of~$E$ 
is the Galois extension~$F/K$ fixed by
$\PP \rhobar_{E,p}$ and satisfies 
$\Gal(F/K) \simeq D_n$. Thus we can write it as $F=K'(\root n\of u)$ for
some $u\in K^*$. 

\nf{Does the fact that $u$ is in~$K$ follows only from the group structure of the Galois group?}

\jc{Here's a partial proof.}

[\def\rnu{\root n\of u} \def\rnub{\root n\of {\overline{u}}} Write
  $\Gal(F/K)=\left<\sigma,\tau\mid\sigma^n=\tau^2=1,
  \tau\sigma\tau=\sigma^{-1}\right>$.  The fixed field of $\sigma$
  is~$K'$ and since $K'$ contains the $n$th roots of unity, by Kummer
  Theory, $F=K'(\rnu)$ for some $u\in K'$.  Now
  $\sigma(\rnu)=\zeta\rnu$ with $\zeta$ a primitive $n$th root of
  unity, and either $\tau(u)=u$ or $\tau(u)=\overline{u}$ (the
  $K'/K$-conjugate of~$u$).  In the first case, $u\in K$.

  In the second case, I can prove that $\rnu/\rnub$ is fixed by $G$,
  hence $\overline{u}/u=v^n$ with $v\in K$ such that $v^{2n}=1$.  For
  $n=4$ this forces $v^n=1$ so $\overline{u}=u$ s $u\in K$.  For $n=3$
  we might have $\overline{u}=-u$, then replace $u$ by
  $u'=u\sqrt{-3}^3\in K$.  When $n=6$ it's OK unless $\sqrt{-1}\in K$
  when I am stuck.  ]

\nf{I have not thought about this. Maybe looking first into the database~$D_n$  extensions of $\Q(i)$ may save us some time in case there is an example..in any case, if we decide to leave this it should appear as an auxiliary proposition first.}
  
  
By Kummer theory the extension $F/K'$ is determined by a specific
cyclic subgroup of order~$n$ in~$K'^*/(K'^*)^n$ hence, noting that
$\Aut(C_n)\cong\{\pm1\}$ for $n\in\{4,3,6\}$, we conclude that~$u \in
K^*$ is unique up to replacing $u$ by~$u^{-1}$ and multiplication by
an element of~$K^*\cap(K'^*)^n$.

Keeping the notations from the previous  lemmas, to prove the first part of the theorem we will construct a
matrix~$A\in\GL_2(\F_p)$ giving
the $G_K$-isomorphism $E[p]\to E'[p]$.

Indeed, the character $\eps:G_{K'} \to
\overline{\F}_p^*$ has exact order~$n$ and cuts out the extension
$F/K'$.
Now let~$\psi:G_K\to \mu_n\subseteq\calO^*$ be the cocycle associated
to~$u$, namely
\[
\sigma\mapsto \psi(\sigma) = \sigma(\root n\of u)/\root n\of u.
\]
The restriction of~$\psi$ to~$G_{K'}$ is a character of order~$n$
which cuts out the same extension $F/K'$, so it is either~$\eps$ or~$\eps^{-1}$.  Replacing $u$ by $u^{-1}$ if necessary, we may assume that
$\left.\psi\right|_{G_{K'}} = \eps$.

Now let $E'$ be the order~$n$ twist of~$E$ by~$u$.  As before, we have
$\Psi(\sigma)=\diag(\eta(\sigma),\eta^{-1}(\sigma))$ where
$\left.\eta\right|_{G_{K'}} = \left.\psi\right|_{G_{K'}} = \eps$ by Lemma~\ref{L:EpsEta}.
Thus, for $\sigma\in G_{K'}$, we have
\[
\Psi(\sigma) = \diag(\eps(\sigma),\eps(\sigma)^{-1}),
\]
and so, the same computation as in the proof of Lemma~\ref{L:EpsEta} 
gives that, for any anti-diagonal matrix~$A$
and all $\sigma\in G_{K'}$, we have
\[
A\ \diag(1,\eps(\sigma))\ A^{-1} = \diag(\eps(\sigma),1) =
\diag(1,\eps(\sigma)) \Psi(\sigma),
\]
that is~\eqref{E:PsiM} holds for $\sigma\in G_{K'}$.
To show that~\eqref{E:PsiM} holds for all $\sigma\in G_{K}$, it
suffices, since both sides of~\eqref{E:PsiM} are homomorphisms $G_K\to \GL_2(\F_p)$, to
do so for a single $\sigma \in G_K\setminus G_{K'}$.

Note that $K' \cap K(\root n\of u) = K$; this follows from coprimality of the degrees for $n=3$ and by our running assumption on~$u$ for $n \in \{4,6\}$.
We can thus choose $\tau\in G_K$ such that it fixes~$\root n\of u$ and is non-trivial when restricted to~$K'$. 
Let $A=\rhobar_{E,p}(\tau)$. 
Since $\tau\notin G_{K'}$ 
the matrix~$A \not\in C$ is anti-diagonal 
because we have diagonalized the 
Cartan~$C$ and $\rhobar_{E,p}(\tau)$ is in its normalizer. Moreover, we have 
$\psi(\tau)=1$ so $\Psi(\tau)=I$ 
and~\eqref{E:PsiM} 
with $\sigma = \tau$ is trivially satisfied.

In the case of the split Cartan we are done, as the diagonalization of~$C$ occurs in~$\GL_2(\F_p)$ and so~\eqref{E:PsiM} holds with 
$A \in \GL_2(\F_{p})$; in the non-split case we have proved that it holds for an $A \in \GL_2(\F_{p^2})$. However, since $A$ is in the normalizer of~$C$, by undoing the initial change of coordinates
we obtain that \eqref{E:PsiM} holds in~$\GL_2(\F_p)$.

\nf{Does this last paragraph make sense? Is it even necessary?}

\jc{It does make sense.  We are not precise about whether (e.g.)
  $\rhobar(\sigma)$ means the matrix of the operator itself, which is
  a bit confusing since we have changed basis to diagonalise.  But I
  wrote our an explicit calculation and it is fine since all the
  conjugations cancel out.  I did not need to use that $A$ normalises
  $C$.  I'll write it out here if you like...}

\nf{OK, you can write it down. If it looks trivial then we can simply summarize in one sentence.}  
  
We will now prove the second statement. First, recall from the first paragraph that $u \in K$ is unique up to inverse and
multiplication by an element
in~$K^*\cap(K'^*)^n$. Therefore, up to $n$th powers in~$K^*$,  
we have either four or two
possible choices for~$u$, namely
\begin{itemize}
  \item $\{u, u^{-1}, -4u, -4u^{-1}\}$ if $n=4$;
  \item $\{u, u^{-1}, -27u, -27u^{-1}\}$ if $n=6$;
  \item $\{u, u^{-1}\}$ if $n=3$.
\end{itemize}

This follows from the elementary observation that the natural map
$K^*/(K^*)^n \to (K'^*)/(K'^*)^n$ is injective when $n=3$ and has
kernel $\{1,-4\}$ for $n=4$ and $\{1,-27\}$ for $n=6$.

Secondly, observe that the construction in the first part of the proof 
only works for
exactly one out of each inverse pair~$u,u^{-1}$ mod $n$th powers, so we have two
quartic or sextic twists when $n=4$ or $n=6$ respectively, and just
one cubic twist when $n=3$.  The two quartic twists differ by the
quartic twist by~$-4$, so by a $2$-isogeny, while the two sextic
twists differ by the sextic twist by~$-27$, so by a $3$-isogeny (see Remarks~\ref{R:2-isog}~and~\ref{R:3-isog}).
\end{proof}

See Examples~\ref{Ex:j1728p3} and~\ref{Ex:j0p5} in section~\ref{SS:typeHigher} for an illustration of this theorem, where we also determine the symplectic type of the congruences using Theorem~\ref{T:typeHigher} below.


\subsection{The symplectic type of congruences between higher order twists}
\label{SS:typeHigher}
We have classified above, under condition~{\bf (S)}, exactly when congruences between twists occur. To complete this part of our study we are left to describe the symplectic type of congruences between higher order twists. 
This is given by the following result. 

%We recall our runnig assumptions. 
%Let $E$ be an elliptic curve defined over the number field~$K$ with $j(E) = 0, 1728$. Let $K'=K(\sqrt{-3})$ or $K(\sqrt{-1})$
%respectively, and assume that $K'\not=K$.
%If $j(E)=1728$ and~$E'$ is the quartic twist of~$E$ by~$u$ assume also $u \neq -4$; finally, $p$ is an odd prime and in case $j(E)=0$ suppose also $p\not=3$. 

\nf{I wonder if we should repeat all the hypothesis in this theorem to make it self contained and easier to use, since this is the main objective of this section.}

\jc{Yes, definitely.  (Not done yet)}

\begin{theorem}\label{T:typeHigher}
 Keep all the running assumptions and notations from section~\ref{SS:higherCong}. 
 Let $E'/K$ be the order~$n \in \{3,4,6\}$ twist of~$E/K$ by~$u \in K^*$. 
 Suppose that $E$ and~$E'$ are $p$-congruent.
\begin{enumerate}
\item If $\sqrt{p^*}\in K$ then $E[p]$ and~$E'[p]$ are symplectically isomorphic
and $p\equiv\pm1\pmod{2n}$.
\item Assume $\sqrt{p^*}\notin K$. Then:
\begin{enumerate}
\item if $n=3$ then $E[p]$ and~$E'[p]$ are anti-symplectically isomorphic;
\item if $n=4$ then $E[p]$ and~$E'[p]$ are symplectically isomorphic if and only if $\sqrt{up^*}\in K$, and the congruence with the quartic twist by~$-4u$ has the opposite symplectic type; 
moreover, $p\equiv\pm3\pmod8$;
\item if $n=6$ then $E[p]$ and~$E'[p]$ are symplectically isomorphic if and only if
  $\sqrt{up^*}\in K$, and then the sextic twist by~$-27u$ is
  antisymplectic; moreover, $p\equiv\pm5\pmod{12}$.
\end{enumerate}
\end{enumerate}
\end{theorem}

\begin{proof}
This proof builds on the proof of Proposition~\ref{P:higherTwists}.
Indeed, we have chosen $\tau\in G_K$ to be such that it fixes~$\root n\of u$ and 
is non-trivial when restricted to~$K'$ and 
we let $A = \rhobar_{E,p}(\tau)$. We have shown that~$A$ satisfies~\eqref{E:PsiM} and so, by the discussion following~\eqref{E:PsiM}, 
the symplectic type of the congruence is given by the square class of~$\det A$. 

We also know that the projective $p$-division field is $F = K'(\root n \of u)$
and $\Gal(F/K) \simeq D_n$.

We have $\det(A)=\det\rhobar_{E,p}(\tau)=\chi_p(\tau)$ where $\chi_p$ denotes the mod~$p$ cyclotomic character.  Since 
the $p$-division field of~$E$ contains the $p$-th roots of unity, and
the projective $p$-division field contains~$\sqrt{p^*}$, the
congruence is symplectic 
if and only if $\tau$ fixes~$\sqrt{p^*}$.
Clearly, when $\sqrt{p^*}\in K$ the congruence is symplectic, proving (1) except for the congruence condition.

Suppose now that $\sqrt{p^*}\notin K$.
We divide into cases:

(a) Suppose $n=3$. 
We have $\Gal(F/K) \simeq D_3$ and so $K'$ is the unique quadratic subfield of~$F$, therefore $\sqrt{p^*} \in K'$. Since~$\tau$ acts non-trivially on~$K'$ the congruence is anti-symplectic.

(b) Suppose $n=4$. We have $\Gal(F/K) \simeq D_4$ and there are exactly three quadratic sub-extensions of~$F/K$.
Furthermore, the fields 
$K'=K(\sqrt{-1})$, $K(\sqrt{p^*})$, $K(\sqrt{u})$ 
are quadratic extensions of~$K$ satisfying
$K' \neq K(\sqrt{p^*})$, $K(\sqrt{u})$. 

(b1) Suppose $K(\sqrt{p^*})=K(\sqrt{u})$.
By definition $\tau$ fixes~$\sqrt{u}$ thus  it fixes~$\sqrt{p^*}$ and the congruence is symplectic; note that in this case~$\sqrt{up^*} \in K$. 
 
(b2) Suppose $K(\sqrt{p^*}) \neq K(\sqrt{u})$. Then 
$K(\sqrt{p^*})=K(\sqrt{-4u})$ and 
since $\tau(\sqrt{-4u}) = - \sqrt{-4u}$
%and $K(\sqrt{p^*})=K(\sqrt{-27u})$ when $n=6$. 
the congruence is anti-symplectic;
note that in this case~$\sqrt{up^*} \not\in K$. 

Recall from Proposition~\ref{P:higherTwists} there is also a $p$-congruence between~$E$ and its quartic twist by~$-4u$. Applying the previous argument to this congruence  gives that it is symplectic if and only 
if $\sqrt{-4up^*} \in K$. Thus the two congruences are of the same type if and only if~$\sqrt{-1} \in K$ which is not the case by assumption.

(c) Suppose $n=6$. We have $\Gal(F/K) \simeq D_6$ and again there are exactly three quadratic sub-extensions of~$F/K$.
Furthermore, the fields 
$K'=K(\sqrt{-3})$, $K(\sqrt{p^*})$, $K(\sqrt{u})$ 
are quadratic extensions of~$K$ satisfying
$K' \neq K(\sqrt{p^*})$, $K(\sqrt{u})$. 
The rest of the argument follows similarly to~(b).

\nf{The following is more clear now, but it still needs work. Note the congruence conditions in the statement are only for the symplectic case but now we also have anti-symplectic mentioned in the statement. Maybe we should write a Corollary with the congruence conditions instead?}

For the congruence conditions on~$p$, which are only non-trivial when
$n=4$ or~$6$ (since $p>3$ implies $p\equiv\pm1\pmod6$) 

\nf{Isn't the previous observation only valid for part (1), at least from the way the congruences are stated?}

recall that
when $n=4$ or~$6$ the two quartic (respectively, sextic) twists are
$2$-isogenous (respectively $3$-isogenous) to each other.  When
$\sqrt{p^*}\in K$ these isogenies induce symplectic congruences, since
both the twists of~$E$ are symplectically congruent.  By the isogeny
criterion, this implies that $2$ (respectively~$3$) is a quadratic
residue, so $p\equiv\pm1\pmod{8}$ (respectively, mod~$12$).  When
$\sqrt{p^*}\notin K$ these isogenies induce anti-symplectic
congruences, so $p\not\equiv\pm1\pmod{8}$ (respectively, mod~$12$).
\end{proof}

We end this section with four families of examples, giving all
possibilities for quartic and sextic twist congruences over~$\Q$ with
$p=3$ or~$5$ in the quartic case and $p=5$ or~$7$ in the sextic case.

\begin{example}\label{Ex:j1728p3}
Let $K=\Q$, $p=3$, $j=1728$ and 
write $E_a := E_{a,0}:\ Y^2=X^3+aX$, 
$a \in \Q$. Assume $p \nmid a$ so that~$E_a$ has good reduction at~$3$ and
the mod~$3$ projective image is the normaliser of a non-split Cartan, isomorphic to~$D_4$.  

\nf{Before there was no assumption $3 \nmid a$. Was the claim about the group structure still true and verified by explicit calculation?}

\jc{I don't remember adding this condition myself.  Perhaps I did.
  But looking at the LMFDB for curves with j=1728, they are all
  maximal at 3, so I think the condition is unnecessary for the
  projective image to be D4.}
  
\nf{I added the condition $3 \nmid a$ to have a proof of the claim about $D_4$. I remember we did that check at the LMFDB together but this is not a proof for arbitrary~$a$. I think we should prove as much as possible for general $a$. If we don't know how to prove it without $3 \nmid a$ then we can add a remark after the example about the observation in the LMFDB?}  

Following the proof of Proposition~\ref{P:higherTwists}, one checks that up to $4$th powers, the subgroup of $\Q^*/(\Q^*)^4$ which become $4$th
  powers in the projective $3$-division field of~$E_a$ is generated
  by~$-3/a^2$ and~$-4$.  
  
  \nf{How was this checked for arbitrary~$a$?}

  \jc{I think I did a generic computation to show that the 4th root of
    $-3a^2$ is in there, but I cannot remember.  I think the wording
    ``one checks that'' was supposed to tell the reader that they can
    check for themselves if they do not believe us.  If some referee
    complains then I'll go through it again (and for the following
    examples, whichever we keep.)}
 
 \nf{OK. Then just add that we use the 3-division polynomial depending on~$a$ for the checking.}
 
Hence, from Proposition~\ref{P:higherTwists} we expect a $3$-congruence between $E_a$
  and either $E_{-3/a}$ (twisting by~$u=-3/a^2$) or $E_{-a^3/3}$
  (twisting by~$u=-a^2/3$).  Only the first holds.  
  
 \nf{How was this checked for arbitrary~$a$? Do we need to check for 
 a single~$a$ and apply the proposition for simultaneous twisting? I've removed it from this version to keep the paper under 30 pages, but maybe this is enough reason to keep it?}   

 \jc{One motivation for me to have the simultaneous twisting result
   was to make statements like this only requiring to be checked for
   one value of $a$, such as $a=1$.  Even then, to be honest we never
   (I think) prove that these quartic and sextic twists are
   anti-linear, though that surely follows from the fact that the
   isomorphism matrix $A$ is in the normaliser but not the Cartan.}
   
 \nf{If there is no other way of proving these kind of claims then let's add the proposition. Maybe rephrasing it giving less importance to the linear and anti-linear part of it?}  
 
Finally, we have $p^* = -3$ and $u=-3/a^2$, hence $\sqrt{p^*u} = 1/a \in \Q$
and the congruence is symplectic by Theorem~\ref{T:typeHigher}.
Moreover, there is a congruence with the quartic twist by $-4u=12/a^2$ which is antisymplectic.
\end{example}

\nf{The following example is analogous to the previous one. We should keep only one. I think it is better to keep the one for $p=3$ as this requires $j=1728$. In any case, my comments as in the previous example also apply.}

\jc{You are right.  The reason for having all four examples is that
  this gives a complete list of what can happen over~$\Q$, which I
  thought was worth recording.  Can we keep them in unless asked to
  cut hem out?}

\nf{I was trying to keep the page under 30 pages, but this will not be possible particularly if we add the twisting proposition. So we can keep all the examples, but we need to justify that there are no more cases over~$\Q$ (why is this true?) and have proofs (even if not written) for all the claims on them.}  
  
\begin{example}\label{Ex:j1728p5}
$K=\Q$, $p=5$, $j=1728$.  The projective image is the normaliser of a
  split Cartan, isomorphic to~$D_4$.  One can check that up to $4$th
  powers, the subgroup of $\Q^*/(\Q^*)^4$ which become $4$th powers in
  the projective $5$-division field of~$E_a$ is generated by~$5/a^2$
  and~$-4$.  Hence we expect $5$-congruences between $E_a$ and either
  $E_{5/a}$ (twisting by~$u=5/a^2$) or $E_{a^3/5}$ (twisting
  by~$u=a^2/5$).  Only the first holds.  Since
  $u=5/a^2$ is $+5$ times a square the congruence is symplectic.
  There is also a congruence with the quartic twist by $-4u=-20/a^2$,
  which is antisymplectic.
  %% We may also check that $E_a$
  %% and~$E_{5/a}$ are $5$-congruent via a congruence which is
  %% $\Z[\zeta_4]$-anti-linear.
\end{example}

\begin{example}\label{Ex:j0p5}
$K=\Q$, $p=5$, $j=0$.  Denote the curve $E_{0,b}:\ Y^2=X^3+b$
  simply by~$E_b$. The projective image is the normaliser of a
  non-split Cartan, isomorphic to~$D_6$.  We expect a
  $5$-congruence between $E_b$ and $E_{bu}$ where $u\equiv5$ (modulo
  squares) and $u\equiv b/10$ or~$10/b$ (modulo cubes), since one may
  check that $b/10$ is a cube in $\Q(E_b[5])$.  Hence, modulo $6$th
  powers, we have either $u\equiv 4/5b^2$ or $u\equiv 5b^2/4$.
  Testing with $b=1$, we find that $E_1$ and $E_{4/5}$ are indeed
  $5$-congruent, hence $E_b$ and $E_{4/(5b)}$ are also.  This
  congruence is symplectic; composing with the $3$-isogeny we also
  have an anti-symplectic congruence between $E_b$ and
  $E_{-108/(5b)}$.
\end{example}

\begin{example}\label{Ex:j0p7}
$K=\Q$, $p=7$, $j=0$.  The projective image is the normaliser of a
  split Cartan, isomorphic to~$D_6$.  We expect a $7$-congruence
  between $E_b$ and $E_{bu}$ where $u\equiv-7$ (modulo squares) and
  $u\equiv 7b/2$ or~$2/(7b)$ (modulo cubes), since one may check that
  $7b/2$ is a cube in $\Q(E_b[7])$.  Hence, modulo $6$th powers, we
  have either $u\equiv -28/b^2$ or $u\equiv -b^2/28$.  Testing with
  $b=1$, we find that $E_1$ and $E_{-28}$ are indeed $7$-congruent,
  hence $E_b$ and $E_{-28/b}$ are also.  This congruence is
  symplectic; composing with the $3$-isogeny we also have an
  anti-symplectic congruence between $E_b$ and $E_{756/b}$.
\end{example}

\begin{comment}
 
\nf{I am not so sure the following examples still make sense. We start with two congruent curves (one of them with $j=1728$) and twist them, but the twists are different: one is the quartic twist by $-4$ and the other is the quadratic twist by $-1$. The reason why the twisted curves are still congruent is different from the case of taking simultaneous quadratic twists and seems like an accident. Indeed, it is
is because the tensoring by $\chi_{-1}$ does not affect the mod~$p$ representations of the $j=1728$ curve and its $-4$ quartic twist is an isogenous curve..in general, if we take a simultaneous non-quadratic twist, we do not have a congruence on the twisted curves -- we need to twist one of them by the inverse to keep the congruence. (These made sense when we had the previous definition of quadratic twists.)}

\jc{I agree!  Cut them both out.}

\begin{example}
Let $E_1=\lmfdbec{288}{a}{1}$ and $E_2=\lmfdbec{32544}{b}{1}$, of
which only the first has $j=1728$.  We have $E_1[7]\cong E_2[7]$, with
a symplectic isomorphism.  Twisting both curves as in the previous
paragraph gives the pair $E_1'=\lmfdbec{288}{a}{2}$ and
$E_2^{-1}=\lmfdbec{32544}{c}{1}$, which again have symplectically
isomorphic mod~$7$ representations as expected since
$\legendre{2}{7}=+1$.
\end{example}

\begin{example}
  $E_1=\lmfdbec{32}{a}{1}$ has $j$-invariant $1728$, its $2$-isogenous
  twist is $E_1'=\lmfdbec{32}{a}{2}$, and these are antisymplectically
  congruent mod~$5$ since $\legendre{2}{5}=-1$.  They are also
  congruent mod~$5$ to $E_2=\lmfdbec{608}{b}{1}$ and its $-1$-twist
  $E_2^{-1}=\lmfdbec{608}{e}{1}$, which are symplectically
  $5$-congruent to each other in accordance with
  Theorem~??.  The mod~$5$ congruence between
  $\lmfdbec{32}{a}{1}$ and $\lmfdbec{608}{b}{1}$ is symplectic while
  that between $\lmfdbec{32}{a}{2}$ and $\lmfdbec{608}{e}{1}$ is
  antisymplectic, so in this case applying the twists reverses the
  symplectic type, as expected since $\legendre{2}{5}=-1$.
\end{example}
\end{comment}

\begin{comment}
 \section{Congruences between quartic and sextic twists}\label{S:cong-twist-46}

Quadratic twists act on congruent pairs of curves, preserving the
symplectic type.  In the case of quartic and sextic twists the
situation is more complicated.  Note that any $p$-congruence
$\varphi:E_1[p]\to E_2[p]$ is linear and hence satisfies
$\varphi(-P)=-\varphi(P)$ for all~$P\in E_1[p]$.  However, when
$\Aut(E_1)=\Aut(E_2)=\calO^*$ has order~$4$ or~$6$, the Galois
isomorphism~$\varphi$ may either be $\calO$-linear or
$\calO$-anti-linear.  Explicitly, we either have
\begin{equation}\label{E:forward-congruence}
\varphi(\zeta\cdot P) = \zeta\cdot\varphi(P)
\qquad\text{for all~$P\in  E_1[p]$ and~$\zeta\in\calO^*$;}
\end{equation}
or
\begin{equation}\label{E:backward-congruence}
\varphi(\zeta\cdot P) = \zeta^{-1}\cdot\varphi(P) = \overline\zeta\cdot\varphi(P)
\qquad\text{ for all~$P\in E_1[p]$ and~$\zeta\in\calO^*$.}
\end{equation}
We call these \emph{$\calO$-linear} and \emph{$\calO$-anti-linear}
congruences respectively.  With anti-linear congruences, in order to
obtain a new congruence we must apply \emph{opposite} twists to the
two curves.

\begin{proposition}\label{P:twist-cong}
Let~$p$ be an odd prime.  Let $E_1$ and~$E_2$ be elliptic curves
defined over a number field~$K$ such that there exists a
$p$-congruence $\varphi:E_1[p]\to E_2[p]$.
\begin{enumerate}
\item
  Let $d\in K^*$; then we also have a $p$-congruence $E_1^d[p]\cong
  E_2^d[p]$ between the quadratic twists by~$d$.
\item
  Suppose that $j(E_1)=j(E_2)=1728$, with $E_1=E_{a_1,0}$ and
  $E_2=E_{a_2,0}$.  If $\varphi$ is an $\calO$-linear congruence, then
  for all $u\in K^*$ we also have a $p$-congruence $E_{au_1,0}\cong
  E_{au_2,0}$, while if $\varphi$ is $\calO$-anti-linear, then for all
  $u\in K^*$ we also have a $p$-congruence $E_{u^{-1}a_1,0}\cong
  E_{au_2,0}$.
\item
  Suppose that $j(E_1)=j(E_2)=0$, with $E_1=E_{0,b_1}$ and
  $E_2=E_{0,b_2}$.  If $\varphi$ is an $\calO$-linear, then for all
  $u\in K^*$ we also have a $p$-congruence $E_{0,ub_1}\cong
  E_{0,ub_2}$, while if $\varphi$ is $\calO$-anti-linear, then for all
  $u\in K^*$ we also have a $p$-congruence $E_{0,u^{-1}b_1}\cong
  E_{0,ub_2}$.
\end{enumerate}
In all cases, the symplectic type of the congruence is preserved.
\end{proposition}
\begin{proof}
For quadratic twists this is \cite[Lemma~11]{FKSym}, but there the
cases of quartic and sextic twists were not included, so we give a
complete proof here.

(1) Let $\sigma$ be the nontrivial automorphism of $K(\sqrt{d})/K$ and
denote by $[-1]$ the negation automorphism on each elliptic curve.
Since $\eps_d(\sigma)=-1$, by Lemma~\ref{L:twist-rep} we have for
$k=1,2$ isomorphisms $\alpha_k:E_k\to E_k^d$, defined
over~$K(\sqrt{d})$, and satisfying
\[
\alpha_k^{\sigma} = [-1]\circ\alpha_k = \alpha_k\circ[-1].
\]
Given the $G_K$-equivariant isomorphism $\varphi:E_1[p]\to E_2[p]$,
define $\varphi_d:E_1^d[p]\to E_2^d[p]$ by
$\varphi_d=\alpha_2\circ\varphi\circ\alpha_1^{-1}$.  Then $\varphi_d$
is a $G_{K(\sqrt{d})}$-equivariant linear isomorphism, also satisfying
\[
\varphi_d^{\sigma} =
\alpha_2^{\sigma}\circ\varphi^{\sigma}\circ(\alpha_1^{-1})^{\sigma} =
\alpha_2\circ[-1]\circ\varphi\circ[-1]\circ\alpha_1^{-1} = \varphi_d,
\]
since $[-1]\circ\varphi=\varphi\circ[-1]$.  Hence $\varphi_d$ is
in fact $G_K$-equivariant.

(2), (3) When $\varphi$ is $\calO$-linear, satisfying
(\ref{E:forward-congruence}), the argument is very similar.  Define
$\alpha_k:E_{a_k,0}\to E_{ua_k,0}$ for $k=1,2$ to be a quartic or
sextic twist by~$u$, satisfying
\[
\alpha_k^{\sigma} = \psi(\sigma)\circ\alpha_k = \alpha_k\circ\psi(\sigma),
\]
where $\psi$ is the twisting cocycle with values in~$\calO^*$, and we
choose normalised isomorphisms $\calO\cong\End(E_k)$ so that each
$\alpha_k$ is $\calO$-linear.  Now define
$\varphi_u=\alpha_2\circ\varphi\circ\alpha_1^{-1}$ and check as before
that $\varphi_u$ is $G_K$-equivariant, now using
(\ref{E:forward-congruence}).

When $\varphi$ instead satisfies (\ref{E:backward-congruence}), define
$\alpha_2:E_{a_2,0}\to E_{ua_2,0}$ to be the twist by~$u$ as before,
so that again
\[
\alpha_2^{\sigma} = \alpha_2\circ\psi(\sigma),
\]
but now define~$\alpha_1:E_{a_1,0}\to E_{u^{-1}a_1,0}$ to be the twist
by~$u^{-1}$, so that
\[ \alpha_1^{\sigma} = \alpha_1\circ\psi(\sigma)^{-1}.
\]
Setting $\varphi_u=\alpha_2\circ\varphi\circ\alpha_1^{-1}$, we may
again check that $\varphi_u$ is $G_K$-equivariant, using
(\ref{E:backward-congruence}).

Finally, in all cases, since the isomorphisms $\alpha_k$ all preserve
the Weil pairing, the symplectic types of $\varphi$
and~$\alpha_2\circ\varphi\circ\alpha_1^{-1}$ are the same.
\end{proof}

%% Now suppose that $d=-1\notin(K^*)^2$, and that one of the curves,
%% say~$E_1$, has $j$-invariant~$1728$; so at least one of the quadratic
%% twists is special.  Now $\rhobar_{E_1,p}$ has image contained in the
%% normaliser of a Cartan subgroup but not in the Cartan itself; by
%% Proposition~\ref{P:twist} we have $E_1[p]\cong E_1^{-1}[p]$.  Since $E_1[p]\cong E_2[p]$, 
%% we also have $E_2[p]\cong E_2^{-1}[p]$ for the same reason, and hence $E_1^{-1}[p]\cong E_2^{-1}[p]$.

%% As for the symplectic type, if also $j(E_2)=1728$ so that both twists
%% are special, then both isomorphisms $E_k[p]\cong E_k^{-1}[p]$ have the
%% same type, each being symplectic if and only if $(2/p)=1$ by Theorem~\ref{T:Cartan}~(1).  Hence the composite
%% $E_1^{-1}[p]\cong E_1[p]\cong E_2[p]\cong E_2^{-1}[p]$ has the same
%% type as $E_1[p]\cong E_2[p]$.  But if $j(E_2)\not=1728$ then
%% Theorem~\ref{T:Cartan} implies that $E_2[p]\cong E_2^{-1}[p]$ is
%% always symplectic, for the image is split if and only
%% if~$p\equiv1\pmod4$.

One can construct more complicated situations.  Suppose that
$E_1[p]\cong E_2[p]$ where $j(E_1)=1728$ but $j(E_2)\not=1728$.  Now
it is possible to apply the quartic twist by~$-4$ to $E_1$, obtaining
$E_1'$ (say), and also apply the $-1$-quadratic twist to~$E_2$.  Then
we also have a $p$-congruence between the twists $E_1'$ and
$E_2^{-1}$, since $E_1$ and $E_1'$ are congruent, being $2$-isogenous,
while $E_2$ and $E_2^{-1}$ are also congruent, by
Theorem~\ref{T:Cartan}.  The latter congruence is symplectic while the
former has symplectic type depending on $\legendre{2}{p}$.  Hence the
new $p$-congruence between the twists $E_1'$ and $E_2^{-1}$ has the
same symplectic type as the original if and only if
$p\equiv\pm1\pmod8$.


\begin{example}
Let $E_1=\lmfdbec{288}{a}{1}$ and $E_2=\lmfdbec{32544}{b}{1}$, of
which only the first has $j=1728$.  We have $E_1[7]\cong E_2[7]$, with
a symplectic isomorphism.  Twisting both curves as in the previous
paragraph gives the pair $E_1'=\lmfdbec{288}{a}{2}$ and
$E_2^{-1}=\lmfdbec{32544}{c}{1}$, which again have symplectically
isomorphic mod~$7$ representations as expected since
$\legendre{2}{7}=+1$.
\end{example}

\begin{example}
  $E_1=\lmfdbec{32}{a}{1}$ has $j$-invariant $1728$, its $2$-isogenous
  twist is $E_1'=\lmfdbec{32}{a}{2}$, and these are antisymplectically
  congruent mod~$5$ since $\legendre{2}{5}=-1$.  They are also
  congruent mod~$5$ to $E_2=\lmfdbec{608}{b}{1}$ and its $-1$-twist
  $E_2^{-1}=\lmfdbec{608}{e}{1}$, which are symplectically
  $5$-congruent to each other in accordance with
  Theorem~\ref{T:Cartan}.  The mod~$5$ congruence between
  $\lmfdbec{32}{a}{1}$ and $\lmfdbec{608}{b}{1}$ is symplectic while
  that between $\lmfdbec{32}{a}{2}$ and $\lmfdbec{608}{e}{1}$ is
  antisymplectic, so in this case applying the twists reverses the
  symplectic type, as expected since $\legendre{2}{5}=-1$.
\end{example}

\begin{example} \label{Ex:3twists}
  For an example with projective image~$C_2\times C_2$, let $E$ be the
  elliptic curve with label~\lmfdbec{6534}{a}{1}, of conductor
  $6534=2\cdot3^3\cdot11^2$.  The image of the projective mod~$3$
  Galois representation is the normalizer of the split Cartan, which
  is isomorphic to $D_4 = C_2\times C_2$.  The three quadratic
  subfields of the projective $3$-division field are $\Q(\sqrt{-3})$,
  $\Q(\sqrt{-11})$, and~$\Q(\sqrt{33})$; the corresponding quadratic
  twist of~$E$ are $E^{-3}=\lmfdbec{6534}{v}{1}$,
  $E^{-11}=\lmfdbec{6534}{p}{1}$, and $E^{33}=\lmfdbec{6534}{h}{1}$
  respectively.  All four curves have isomorphic mod~$3$
  representations, the isomorphism being antisymplectic between~$E$
  and~$E^{-11}$ and~$E^{33}$, and symplectic between $E$ and~$E^{-3}$,
  in accordance with Theorem~\ref{T:Cartan}.


  \textbf{We no longer need the following, since the new version of
    Theorem~\ref{T:Cartan} says that the symplectic twist is the one
    by $3^*=-3$!}
  
  The conclusion on the symplectic types follows from part 2) of Theorem~\ref{T:Cartan} once we show
  that $E[3]$ and $E^{-3}[3]$ are symplectically isomorphic. We will show this by applying \cite[Theorem~5]{FKSym} with $\ell = 11$. We use the notation of {\it loc. cit.}. Write $E' = E^{-3}$. The curves $E/\Q_{11}$ and $E'/\Q_{11}$ have minimal models satisfying
  \[
  \vv_{11}(\Delta_m) = \vv_{11}(\Delta_m') = 3 \quad \text{ and } \quad \tilde{\Delta} = -1259712, \quad \tilde{\Delta}' = -1728.
  \]
 Thus $e = e' = 4$ by \cite[Proposition~1]{Kraus1990}. 
Moreover, we have $\vv_{11}(\Delta_m) \equiv \vv_{11}(\Delta_m')
\pmod{4}$ and none of $\tilde{\Delta}$, $\tilde{\Delta}'$ is a square mod~$11$. Thus, $r=t=0$ and $E[3]$ and $E'[3]$ are symplectically isomorphic $G_{\Q_{11}}$-modules, hence $E[3]$ and $E'[3]$ are also symplectically isomorphic $G_\Q$-modules.
\end{example}

\begin{example} \label{Ex:LocalFail7}
Consider the elliptic curve
\[ E : y^2 + y = x^3 - x^2 - 74988699621831x +  238006866237979285299, \]
which has conductor $ N_E = 7^2 \cdot 2381 \cdot
134177^2>2\cdot10^{15}$, so is not in the LMFDB database.  This
example was found using the explicit parametrization of curves for
which the image of the mod~$7$ Galois representation is contained in
the normalizer of a non-split Cartan subgroup; we verified by explicit
computation that the image is equal to the full normalizer.

Let $d = -7 \cdot 134177$ and consider~$E^d$ the quadratic twist
of~$E$ by~$d$. Applying Theorem~\ref{T:j=1728} (or the general method
from Section~\ref{S:statistics}) yields that $E[7] \simeq E^d[7]$ are
symplectically isomorphic~$G_\Q$-modules and not anti-symplectically
isomorphic. Moreover, one can verify that none of the local criteria
in~\cite{FKSym} applies for this case.
\end{example}

\jc{The rest of Section 3 can go, but the examples in both 3.1 and 3.2
  should be kept.}
\subsection{Congruences between elliptic curves with
  $j$-invariant~$1728$}

We now consider whether $p$-congruences can hold between two curves
which are quartic twists, both having $j$-invariant~$1728$.  In this
subsection we denote the curve $E_{a,0}:\ Y^2=X^3+aX$ simply by~$E_a$.

We know that $E_a[p]\cong E_{-4a}[p]$ for all~$p>2$, since $E_a$ and
$E_{-4a}$ are $2$-isogenous (see Remark~\ref{R:2-isog}).  Since we are
only interested in the situation where $E[p]$ is absolutely
irreducible, the projective image $\PP\rhobar_{E,p}(G_K)$ is the
dihedral group $D_n$ with $n\ge2$.  Our result for these curves is
that there are no further congruences between them for any~$p>2$,
unless $n=2$ or $4$.

\begin{theorem}\label{T:j=1728}
Let $K$ be a number field.  For all $a \in K^*$ and all primes~$p>2$,
the elliptic curves $E_a$ and $E_{-4a}$ have isomorphic mod-$p$ Galois
representations, the isomorphism being symplectic if and only if $2$
is a quadratic residue modulo~$p$, \textit{i.e.}, if and only if
$p\equiv\pm1\pmod8$.

Let $E$ be an elliptic curve with $j(E)=1728$ and let $p$ be an odd
prime such that $E[p]$ is absolutely irreducible, so that the
projective image $\PP\rhobar_{E,p}(G_K)$ is~$D_n$ for some $n\ge2$ and
$\sqrt{-1}\not\in K$.  Suppose that $E$ is $p$-congruent to its
quartic twist by $u$, for some $u\in K^*$ not a $4$th power.  Let
$L=K(\root4\of{u})$ and let $F$ be the projective $p$-division field
of~$E$ (of degree~$2n$).

Then, as well as the congruence induced by the $2$-isogeny (with
$u=-4$) we have the following cases.
\begin{enumerate}
  \item If $n=2$ then $F=K(\sqrt{-1},\sqrt{d})$ for some $d\in K^*$
    such that $\pm d\not\in(K^*)^2$.  Then $u\in\{-4,d^2,-4d^2\}$
    (modulo $4$th powers), and we have in addition congruences with
    the quadratic twist by~$d^2$, and with the curve $2$-isogenous to
    it.
  \item If $n=4$ then there are \textbf{[possibly]} two additional
    quartic congruences with curves $2$-isogenous to each other.
  \item If $n=3$ or $n>4$ then there are no further congruences.
\end{enumerate}
In case (1), if $\sqrt{p^*}\not\in K$, then we may take $d=p^*$, the
quadratic twist by~$p^*$ is symplectic and the $2$-isogeny is
anti-symplectic; this case can only occur when $p\equiv\pm3\pmod8$;
while if $\sqrt{p^*}\in K$, then all the twists are symplectic; so this
case can only occur when $p\equiv\pm1\pmod8$.

In case (2), the additional quartic twists have opposite symplectic
type when $p\equiv\pm3\pmod8$, and the same type when
$p\equiv\pm1\pmod8$ \textbf{[but I don't know which!]}.
\end{theorem}

\begin{proof}
The first part follows from the isogeny criterion since $E_a$
and~$E_{-4a}$ are $2$-isogenous.

Suppose that $E$ is $p$-congruent to $E'$, its quartic twist by~$u$,
where $u$ is not a $4$th power.

For the second part, we first consider quadratic congruences with
$u=v^2$ and $\pm v$ not squares in~$K$.  Then $L=K(\sqrt{v})$ is a
quadratic extension, not equal to $K(\sqrt{-1})$, contained in~$F$,
and by Theorem~\ref{T:constraint}, the projective image of $G_L$ is
not absolutely irreducible, hence has order~$2$.  Hence $n=4$, and
$F=K(\sqrt{-1}, \sqrt{v})$.  The situation is as in
Theorem~\ref{T:Cartan}~(2).

When $n=2$ there are no more congruent twists other than the ones
described in the previous paragraph.  Any such twist would be by $u$
such that $\pm u$ are not squares.  Then $[L:K]=4$, since $K\subsetneq
K(\sqrt{u})\subsetneq L=K(\root4\of{u})$.  Writing
$F=K(\sqrt{-1},\sqrt{d})$, applying Theorem~\ref{T:constraint} which
says that $F\cap L$ is a nontrivial extension of~$K$, we have
$K(\sqrt{\pm d}) = F\cap L= K(\sqrt{u})$, and hence $u$ is $\pm d$
times a square in~$K$.  [?] Applying a quadratic twist and/or the
$2$-isogeny reduces to the case where $u=d$. \textbf{Now what?!}

Now suppose that $n>2$.  Apart from the $2$-isogeny, any other
congruent twist must have $\pm u$ non-square, so $[L:K]=4$.  By
Theorem~\ref{T:constraint}, $F\supset K(\sqrt{u})\not=K(\sqrt{-1})$,
so in fact $F$ contains the biquadratic
extension~$K(\sqrt{-1},\sqrt{u})$.  By Theorem~\ref{T:constraint}
again, the projective image of $G_{K(\sqrt{u})}$ must be (absolutely)
reducible, hence of order at most~$2$.  This is only possible if
$F\supset L$ and $n=4$.  This gives two possible values of~$u$ (modulo
$4$th powers and inverses), differing by a factor of~$-4$.  Note that
we cannot have congruences with both the quartic twists by $u$ and
by~$u^{-1}$, since then the two twists would be quadratic twists of
each other, and we have seen that this is impossible except when
$n=2$.
\end{proof}


%% Suppose that $E_{a_1}[p]\cong E_{a_2}[p]$ and the image condition
%% holds.  Since $\PP \rhobar_{E_{a_1},p}(G_K)$ has order greater than~$8$,
%% we have that $\PP \rhobar_{E_{a_1},p}(G_L)\not\cong C_2\times C_2$, for any extension $L/K$ at most quadratic.

%% We first claim that if $E_{a_1}$ and~$E_{a_2}$ are not isomorphic
%% over~$K$ but are quadratic twists, then they are special quadratic
%% twists.
%% Applying Proposition~\ref{P:twist}, the image of $\rhobar_{E,p}$ is
%% contained in the normaliser~$N$ of a Cartan subgroup~$C$, but not
%% contained in the Cartan itself, where $C$ cuts out the quadratic
%% extension $K(\sqrt{d})/K$.  By hypothesis the projective image is
%% not~$C_2\times C_2$, so this is true for a unique pair $(N,C)$.  Hence
%% the non-trivial quadratic extension cut out by $C$ must be the CM
%% extension $K(\sqrt{-1})$; in particular, $\sqrt{-1} \not\in K$.  Hence
%% $K(\sqrt{d})=K(\sqrt{-1})$, proving the claim.

%% We now consider two cases:

%% (i) Assume $a_1/a_2 = d^2$ with $d\in K^*$. If $d$ is a square in~$K$
%% then the curves are isomorphic.  Otherwise, by the claim, they are
%% quadratic twists by~$K(\sqrt{d})=K(\sqrt{-1})$.  But then
%% $-d\in(K^*)^2$, so $a_1/a_2=(-d)^2\in(K^*)^4$, and again the curves
%% are isomorphic over~$K$.  So if $a_1/a_2$ is a square in~$K$, then it must in
%% fact be a $4$th power.

%% (ii) Assume $a_1/a_2$ is not a square in~$K$.  Let $m=\sqrt{a_1/a_2}$
%% and set $L=K(m)$. Thus $a_1/a_2 = m^2$ with $m \in L$ and $E_{a_1}$ is
%% isomorphic to~$E_{a_2}$ over~$L(\sqrt{m})$.  Since $E_{a_1}[p]\cong
%% E_{a_2}[p]$ as $G_L$-modules, and the projective image $\rhobar_{E_{a_1},p}(G_L)$
%% has order greater than~$4$, by case (i) over~$L$ we conclude that the
%% curves are in fact isomorphic over~$L$.  Since $L$ is a quadratic
%% extension of~$K$, the claim gives $L=K(\sqrt{-1})$.  From the discussion preceding the theorem, we have
%% $E_{a_2}\cong E_{a_1}^{-1} \cong E_{-4a_1}$, so $a_1/a_2 = -4$ (modulo
%% 4th powers).

\subsection{Congruences between elliptic curves with
  $j$-invariant~$0$}

We now consider whether $p$-congruences can hold between two curves
which are sextic twists, both having $j$-invariant~$0$.  In this
subsection we denote the curve $E_{0,b}:\ Y^2=X^3+b$ simply by~$E_b$.

We know that $E_b[p]\cong E_{-27b}[p]$ for all~$p>3$, since $E_b$ and
$E_{-27b}$ are $3$-isogenous (see Remark~\ref{R:3-isog}).  Since we
are only interested in the situation where $E[p]$ is absolutely
irreducible, the projective image $\PP\rhobar_{E,p}(G_K)$ is the
dihedral group $D_n$ with $n\ge2$.  Our result for these curves is
that there are no further congruences between them for any~$p>2$,
unless $n=2$, $3$ or~$6$. \textbf{Check this statement after proving
  the theorem!}

\begin{theorem}\label{T:j=0}
Let $K$ be a number field.  For all $b \in K^*$ and all primes~$p>2$,
the elliptic curves $E_b$ and $E_{-27b}$ have isomorphic mod-$p$
Galois representations, the isomorphism being symplectic if and only
if $3$ is a quadratic residue modulo~$p$, \textit{i.e.}, if and only
if $p\equiv\pm1\pmod{12}$.

Let $E$ be an elliptic curve with $j(E)=0$ and let $p\ge5$ be a prime
such that $E[p]$ is absolutely irreducible, so that the projective
image $\PP\rhobar_{E,p}(G_K)$ is~$D_n$ for some $n\ge2$ and
$\sqrt{-3}\not\in K$.  Suppose that $E$ is $p$-congruent to its sextic
twist by $u$, for some $u\in K^*$ not a $6$th power.  Let
$L=K(\root6\of{u})$ and let $F$ be the projective $p$-division field
of~$E$ (of degree~$2n$).

Then, as well as the congruence induced by the $3$-isogeny (with
$u=-27$) we have the following cases.
\begin{enumerate}
  \item If $n=2$ then $F=K(\sqrt{-3},\sqrt{d})$ for some $d\in K^*$
    such that $d,-3d\not\in(K^*)^2$.  Then $u\in\{-27,d^3,-27d^3\}$
    (modulo $6$th powers), and we have in addition congruences with
    the quadratic twist by~$d^3$, and with the curve $3$-isogenous to
    it.
  \item If $n=3$ then there are \textbf{[possibly]} two additional
    sextic congruences with curves $3$-isogenous to each other.
  \item If $n=6$ then there are \textbf{[possibly]} two additional
    sextic congruences with curves $3$-isogenous to each other.
  \item If $n\not=2,3,6$ then there are no further congruences.
\end{enumerate}
In case (1), if $\sqrt{p^*}\not\in K$, then we may take $d=p^*$, the
quadratic twist by~$p^*$ is symplectic and the $3$-isogeny is
anti-symplectic; this case can only occur when $p\equiv\pm5\pmod{12}$;
while if $\sqrt{p^*}\in K$, then all the twists are symplectic; so
this case can only occur when $p\equiv\pm1\pmod{12}$.

In cases (2) and~(3), the additional sextic twists have opposite
symplectic type when $p\equiv\pm5\pmod{12}$, and the same type when
$p\equiv\pm1\pmod{12}$ \textbf{[but I don't know which!]}.
\end{theorem}

\begin{proof}
The first part follows from the isogeny criterion since $E_b$
and~$E_{-27b}$ are $3$-isogenous.

For the second part, suppose that $E=E_b$ is $p$-congruent to its
sextic twist $E'=E_{bu}$, where $u$ is not a $6$th power.  We divide
into cases: (i) $u=v^3$ and $v$ not a square in~$K$ (so the twist is a
quadratic twist); (ii) $u=v^2$ with $v$ not a cube; (iii) $u=-3v^2$
with $v$ not a cube; (iv) $u$ not a cube and $u\not\equiv1,-3$ (modulo
squares).

Case~(i) (quadratic twists): Suppose that $u=v^3$ and $v$ not a square
in~$K$.  Now $L=K(\sqrt{v})$ is a quadratic extension, contained
in~$F$, and by Theorem~\ref{T:constraint}, the projective image of
$G_L$ is not absolutely irreducible.  Either $L=\Q(\sqrt{-3})$, or the
image of~$G_L$ has order~$2$ and hence $n=2$, and $F=K(\sqrt{-3},
\sqrt{v})$.  In the first case $u\equiv-27$ (modulo $6$ powers) and
the congruence is with the $3$-isogenous curve $E_{-27b}$.  Otherwise,
the situation is as in Theorem~\ref{T:Cartan}~(2) with projective
image~$C_2\times C_2$.  If $p^*$ is not a square in~$K$ then we have
$v=p^*$ (replacing $v$ by $-3v$ if necessary), the quadratic twist
by~$p^*$ is symplectic while those by $-3$ and $-3p^*$ are
antisymplectic.  This implies that $\legendre{3}{p}=-1$, so can only
happen when $p\equiv\pm5\pmod{12}$.  Otherwise, if $p^*$ is a square
in~$K$, then all three quadratic twists are symplectic, so this can
only happen when $p\equiv\pm1\pmod{12}$.

To complete part (1) of the statement of the theorem, we need to show
that when $n=2$ there are no more congruent twists other than the
three quadratic twists.  This requires an application of Case~(ii).
Any such twist would be by $u$ such that $u$ is not a cube in~$K$.
Since $[F:K]=4$, $K(\root3\of{u})\not\subseteq F$, which implies by
Theorem~\ref{T:constraint} that $E_b$ is not $p$-congruent
to~$E_{bu^3}$, hence $u$ is not a square.  Now
$L=K(\root6\of{u})=K(\sqrt{u},\root3\of{u})$, so by
Theorem~\ref{T:constraint} again, we have $F\cap L = K(\sqrt{u})$.
But then $E_b$ would be congruent to the quadratic twist~$E_{bu^3}$,
contradiction. \textbf{I'm sure this last part can be simplified!}

Case~(ii).  Suppose that $u\in(K^*)^2$ but $u\not\in(K^*)^3$.  We show
that this is impossible unless $n=3$.  Let
$L=K(\root6\of{u})=K(\root3\of{u})$.  By Theorem~\ref{T:constraint} we
have $L\subseteq F$, and in fact $F=L(\sqrt{-3})$ and $n=3$, as
otherwise $E[p]$ would remain absolutely irreducible as $G_L$-module.
\textbf{I cannot exclude this case, and I think it is what happens
  over $\Q(\sqrt{-7})$ when $p=7$.  For we know that $E_1$ and
  $E_{-28}$ are $7$-congruent over~$\Q$, where $n=6$; base-changing to
  $K=\Q(\sqrt{-7})$ reduces $n$ to $3$ and makes $u=-28$ a square but
  not a cube.}

Case~(iii): Suppose that $u\not\in(K^*)^3$ and $u\equiv-3$ (modulo
squares).  Now $E_b$ is $p$-congruent to both $E_{bu}$ and $E_{-27b}$,
so the latter are $p$-congruent to each other and twists by~$-27/u$
which is not a cube.  This contradicts Case~(ii), unless $n=6$.
\textbf{This is the $n$ for $E_{bu}$ not $E_b$ though \dots}

Case~(iv).  Suppose that $u\not\in(K^*)^3$ and $u\not\equiv1,-3$
(modulo squares).  Let $L_1=K(\root3\of{u})$.  Over~$L_1$, the
isomorphism $E_b\to E_{bu}$ becomes a quadratic twist, so we apply
Case~(i).  Since $u\not\equiv-3$ (modulo squares) in $L_1$, the
projective image of $G_{L_1}$ must be $C_2\times C_2$ since over~$L_1$
we have more than one quadratic twist (by~$u$ and by~$-3$) which is
$p$-congruent to~$E_b$.  Hence $n=6$.  If $p^*$ is not a square in
$K$, it is also not a square in $L$, so $u\equiv p^*$
or~$u\equiv-3p^*$ modulo~$(L_1^*)^2$, and also modulo~$(K^*)^2$.
%% [Replacing $u$ by $-27u$ if necessary we may assume that $u\equiv p^*$
%% modulo squares, in $L$ and hence also in $K$.]

So the projective image of $G_K$ has order~$12$, isomorphic to the
dihedral group~$D_6$, and $K(\root3\of{u})$ is the unique (up to
conjugacy) degree~$3$ subfield of~$F$.  This uniquely determines
$u^{\pm1}$ (modulo cubes).  Since $u$ is uniquely determined modulo
squares (up to multiplication by~$-3$) and cubes (up to replacing $u$
by $u^{-1}$, this almost uniquely identifies the sextic twist
$E_{bu}$.  Note that there cannot exist sextic twists by both $u$ and
$u^{-1}$ by Case~(ii), unless $u$ is a cube so that these are the same
twists.

The symplectic type of these extra congruences can be determined by
base-changing to~$L_1$ where they become quadratic twists.  In case
$p^*$ is not a square in~$K$, the sextic twist by $u\equiv p^*$
(modulo squares) is also symplectic, while the sextic twist by
$u\equiv -3p^*$ (modulo squares) is anti-symplectic; also, the
quadratic twist by~$-3$ is anti-symplectic, so this can only occur
when $p\equiv\pm5\pmod{12}$.  If $p^*$ is \ square in~$K$ then the
extra sextic twists are both symplectic, as is the $3$-isogeny, so
$p\equiv\pm1\pmod{12}$.
\end{proof}

\end{comment}


%%%%%%%%%%%%%%%%%%%%%%

\begin{comment}
 
 \section{The symplectic type of congruences between twists} \label{S:type}
%% Since the map~$t$ is an isomorphism over~$\Qbar$ it preserves the Weil
%% pairing, therefore
The symplectic type of $\phi : E[p] \simeq E'[p]$ is determined by the
square class of $\det A$, where $A$ is the matrix of~$\phi$ (see
\cite[Lemma~6]{FKSym}).

We start by determining the symplectic type of congruences between quadratic twists.
Since the projective
image is dihedral (by Proposition~\ref{P:twist}), this
is a situation where the local methods from~\cite{FKSym} may not
apply, as is illustrated by Example~\ref{Ex:LocalFail7} below.

\begin{theorem}\label{T:quadratic} 
Let $p > 2$ be a prime. 
Let $E/K$ be an elliptic curve 
$p$-congruent to some quadratic twist~$E^d$.
Assume $E[p]$ is an absolutely irreducible~$G_K$-module.

\begin{enumerate}
%% \item In the case of the special quadratic twist, the congruence is
%%   symplectic if and only if $(2/p)=+1$.

\item Let $C$ be the Cartan subgroup of~$\GL_2(\F_p)$
  associated to the extension $K(\sqrt{d})/K$ in
  Proposition~\ref{P:twist}.  Then the congruence is symplectic if and
  only if \emph{either} $C$ is split and $p \equiv 1 \pmod{4}$,
  \emph{or} $C$ is non-split and $p \equiv 3 \pmod{4}$.

\item When $\PP\rhobar_{E,p}\cong C_2\times C_2$, there are three
  different quadratic\footnote{when $j(E)=1728$ one of these
    is the quartic twist by~$-4$ so not in fact quadratic.}  twists
    of~$E$ which are $p$-congruent to~$E$.  If $\sqrt{p^*}\in K$ then
    all three congruences are symplectic.  Otherwise, one of the
    quadratic twists is by $K(\sqrt{p^*})$ and is symplectic while the
    other two are anti-symplectic.
\end{enumerate}
\end{theorem}
\begin{proof} (1)
Let~$\delta \in \F_p^*$ be a square if $C$ is split and a non-square
if $C$ is non-split.  Let $H=G_{K(\sqrt{d})}$ be the index~$2$
subgroup cut out by the surjective
homomorphism~$\varepsilon_d:G_K\to\{\pm 1 \}$.

We will define a matrix~$M\in\GL_2(\F_p)$ satisfying~\eqref{E:PsiM}
and $\det(M)=-\delta$; the induced map $E[p]\to E'[p]$ is then a
$G_K$-equivariant isomorphism which is symplectic if and only if
$-\delta$ is a square.  Now (1) follows by considering the four cases,
$\delta$ square/non-square and $p\equiv\pm1\pmod4$.

The projective image of~$H$ is a subgroup of a Cartan
subgroup~$C\subset\PGL_2(\F_p)$, which is cyclic of even order~$p\pm1$
(depending on whether~$C$ is split or non-split).  Hence $C$ contains
a unique element of order~$2$, which is central in the normalizer~$N$
of~$C$.  Let $M$ be any lift of this to~$\GL_2(\F_p)$.  Then $M$ is
not scalar, while $M^2$ is scalar, so by Cayley-Hamilton we have
$\Tr(M)=0$ and $M^2=-\det(M)$.  By Lemma~\ref{L:C2xC2} and its proof,
$-\det(M)$ is square if and only if the Cartan is split, so (without
loss of generality) we may take $\delta=-\det(M)$.

Since $M$ is central in $\rhobar_{E,p}(G_K)$ modulo scalars, for all
$g\in\rhobar_{E,p}(G_K)$ we have $GM^{-1}=\lambda(g)g$ with a scalar
$\lambda(g)=\pm1$ (comparing determinants).  Now $\lambda(g)=1$ if and
only if $g$ commutes with~$M$ which---since $M$ is a non-scalar element
of the Cartan subgroup---is if and only if $g$ is itself in the Cartan
subgroup, that is, if and only if $g=\rhobar_{E,p}(\sigma)$ with
$\sigma\in H$.  \eqref{E:PsiM} follows.

(2) Since the determinant of $\rhobar_{E,p}$ is the mod~$p$ cyclotomic
character, we have $\PP\rhobar_{E,p}(G_K)\subseteq \PSL_2(\F_p)$ if
and only if $\sqrt{p^*}\in K$.  When this is the case, by
Lemma~\ref{L:C2xC2} we see that each index~$2$ subgroup of the
projective image is split when $p\equiv1\pmod4$ and each is non-split
when $p\equiv3\pmod4$.  By part (1), it follows in both cases that the
congruences between~$E$ and each of the three twists are all
symplectic.

Now suppose that $\sqrt{p^*}\notin K$.  By Lemma~\ref{L:C2xC2} again,
exactly one of the three subgroups is split when $p\equiv1\pmod4$, and
exactly one is non-split when $p\equiv3\pmod4$, so in both cases
exactly one congruence is symplectic.  Moreover, since the subgroup
$C$ inducing the symplectic congruence is the unique one contained in
$\PSL_2(\F_p)$ (see the end of the proof of Lemma~\ref{L:C2xC2}), the
associated quadratic extension is~$K(\sqrt{p^*})$.
\end{proof}

See Example~\ref{Ex:3twists} for an illustration of part (2) of
the previous theorem.


We will next use the previous theorem to describe the symplectic type
of congruences between quartic twists via a base change
argument. First recall that the quartic twist by~$u = s^2$ is the
quadratic twist by~$s$; if $u = -s^2$ then $u = -4s_0^2$ and by first
applying the 2-isogeny from Remark~\ref{R:2-isog} we reduce to the
case of~$u$ being a square. Applying the isogeny changes the
symplectic type if and only if $(2/p) = -1$, therefore by keeping
track of this, we can assume that $u \neq \pm 1$ mod squares.


We now determine the symplectic nature of congruences between quartic
twists.

\begin{theorem}\label{T:quarticM} 
Let $p > 2$ be a prime. Let $K$ a number field with $\sqrt{-1} \not\in K$ and let also $u \in K$ satisfy $u \neq \pm 1$ mod squares. 
Let $E/K$ be an elliptic curve and $E'/K$
its quartic twist by~$u$.
Assume that $E$ and~$E'$ are $p$-congruent.
Then $E[p]$ and~$E'[p]$ are symplectically isomorphic if and only if
$\sqrt{p^*} \in K$ or $u = p^*$ mod squares.
\end{theorem}

\begin{proof} 
We have $j(E)=j(E')=1728$, and both curves have~CM by
$\Q(\sqrt{-1})$. We have $\PP \rhobar_{E,p} \simeq D_4$ by
Lemma~\ref{L:dihedral} and, since $u \neq -4$ mod 4th powers, by
Lemma~\ref{L:LinF} the projective $p$-division field is $F =
K(\sqrt{-1},\root 4 \of u)$.

\nf{Actually in an email I think I suggested already that the
  following lemma [Now Lemma 4.2] and corollary [4.3] may be included
  after Lemma 2.14. Note this lemma does prove that the image has
  order 8.}
  
The group~$D_4$ has three normal subgroups of order~$4$: one cyclic corresponding to the projective image of $G_{K(\sqrt{-1})}$ and two isomorphic to~$C_2 \times C_2$ corresponding to the projective images of
$G_{K(\sqrt{u})}$ and $G_{K(\sqrt{-u})}$.

Let $M = K(\sqrt{u})$. 
The base change of~$E$ and~$E'$  
to~$M$ are quadratic twists by~$\sqrt{u}$ from the discussion preceding the theorem. They are also $p$-congruent and,  since the 
symplectic type is preserved by this base change, we can apply Theorem~\ref{T:quadratic} over~$M$.  
Indeed, from its part~(2) we know that
$E[p]$ and~$E'[p]$ are symplectically isomorphic if and only if $\sqrt{p^*} \in M$ 
or $E/M$ and $E'/M$ are quadratic twists by~$\sqrt{p^*}$. 
This latter condition means $u = p^*$ mod squares and since $M = K(\sqrt{u})$ the result follows.
\end{proof}


\begin{proposition} \label{P:PsiInImage}
Let~$E$ and~$E'$ be non-trivial cubic twists over~$K$, i.e. sextic twists by a square~$u \in K$. Assume $\sqrt{-3} \not\in K$ and that $E$ and $E'$ are $p$-congruent.

Fix bases for $E[p]$ and~$E'[p]$ as above so that the matrix equality \eqref{E:PsiMatrix} holds. Then 
$\rhobar_{E,p}(G_K) = \rhobar_{E',p}(G_K)$ 
as subgroups of~$\GL_2(\F_p)$. In particular, the common image contains $\{ \Psi(\sigma) \}_{\sigma \in G_K}$.
\end{proposition}
\jc{I hope you have some notes for this!  I cannot remember the argument.}

\begin{theorem}\label{T:cubicM} 
Let $K$ be a number field with $\sqrt{-3} \not\in K$. 
Let $E'/K$ be a cubic or sextic twist of~$E/K$ by~$u \in K$ with $u \neq -3$ mod squares. Assume $E[p] \cong E'[p]$
and $\PP \rhobar_{E,p} \simeq D_3$.
Then $E[p]$ and~$E'[p]$ are symplectically isomorphic if and only if
$\sqrt{p^*} \in K$.
\end{theorem}
\begin{proof} We have $j(E)=j(E')=0$ and the curves have~CM by $\Q(\sqrt{-3})$.

By hypothesis $\psi(\sigma) \neq 1$ for some~$\sigma \in G_K$ therefore, 
considering~\eqref{E:PsiM} projectively, we see that~$M$ acts as a non-trivial automorphism of~$D_3$ by Proposition~\ref{P:PsiInImage}.
Since all automorphisms of~$D_3$ are inner, 
there is $\tau \in G_K$ such that 
$M = \rhobar_{E,p}(\tau) \neq \Id$ in~$\PGL_2(\F_p)$.

If $\Psi(\tau) \neq \Id$, then   
taking~$\sigma = \tau$ in~\eqref{E:PsiM} 
gives
$\rhobar_{E,p}(\tau) = \rhobar_{E,p}(\tau) \cdot \Psi(\tau)$, a contradiction. We conclude that
$\tau \in G_{K(\root3\of{u})}$. 
Moreover, by hypothesis
$F = K(\sqrt{-3},\root3\of{u})$ is
the field cut out by $\PP \rhobar_{E,p}$. 
Thus $\tau(\sqrt{-3}) = - \sqrt{-3}$.

Recall that $\sqrt{p^*} \in F$.
Thus $\sqrt{p^*} \in K(\sqrt{-3})$, so either $\sqrt{p^*} \in K$ or $\sqrt{-3p^*} \in K$. In the first case, clearly $\tau(\sqrt{p^*}) = \sqrt{p^*}$; in the second, we have 
\[
 \tau(\sqrt{p^*}) = \tau(\sqrt{-3}\cdot\sqrt{-3p^*}) = \tau(\sqrt{-3}) \cdot \tau(\sqrt{-3p^*})= - \sqrt{-3} \cdot \sqrt{-3p^*} = - \sqrt{p^*}
\]
and we conclude that $\det \rhobar_{E,p}(\tau)$ is a square if and only if~$\sqrt{p^*} \in K$. Clearly the same holds for~$M$ and the result follows.
\end{proof}

\begin{theorem}\label{T:sexticM} 
Let $K$ be a number field with $\sqrt{-3} \not\in K$. 
Let $E'/K$ be the sextic twist of~$E/K$ by~$u \in K$ with $u \neq -3$ mod squares. 
Assume $E[p] \simeq E'[p]$
and $\PP \rhobar_{E,p} \simeq D_6$.
Then $E[p]$ and~$E'[p]$ are symplectically isomorphic if and only if
$\sqrt{p^*} \in K$ or $u = p^*$ mod squares.
\end{theorem}
\begin{proof}   
We have $j(E)=j(E')=0$ so that the curves have~CM by $\Q(\sqrt{-3})$. 

Recall the field $F$ cut out by $\PP \rhobar_{E,p}$ 
contains $K(\sqrt{-3})$ 
and $K(\sqrt{u})$ by Lemma~\ref{L:LinF}; 
hence it also contains $K(\sqrt{-3u})$ and these three extensions are different.


The group~$D_6$ has three normal subgroups of order~$6$: one cyclic corresponding to the projective image of $G_{K(\sqrt{-3})}$ and two isomorphic to~$D_3$ corresponding to the projective images of
$G_{K(\sqrt{u})}$ and $G_{K(\sqrt{-3u})}$.
Moreover, the base change of~$E$ and~$E'$ 
to~$K(\sqrt{u})$ are cubic twists. Since the 
symplectic type is preserved by base change 
to~$K(\sqrt{u})$, we can apply Proposition~\ref{T:cubicM} over this field.
Indeed, over~$K(\sqrt{u})$ we have that $E[p]$ and~$E'[p]$ are symplectically isomorphic if and only if
$\sqrt{p^*} \in K(\sqrt{u})$, that is when
$\sqrt{p^*} \in K$ or $K(\sqrt{u}) = K(\sqrt{p^*})$, as desired.
\end{proof}
\end{comment}

\section{Finding congruences and determining their symplectic type}\label{S:statistics}

In this section we discuss our systematic study of mod~$p$ congruences
between elliptic curves in the LMFDB database.  As of September 2019, this
database contains all elliptic curves defined over~$\Q$ of
conductor~$N\le\numprint{500000}$, as computed by the first author
using the methods of~\cite{AMEC}; there are $\numprint{3064704}$
curves, in $\numprint{2164259}$ isogeny classes.


Recall first that isogenous curves have mod~$p$ representations which
are isomorphic up to semisimplification, and actually isomorphic if
the degree of the isogeny is not divisible by~$p$.  Secondly, two
representations have isomorphic semisimplification if and only if they
have the same traces, so that we can test this condition by testing
whether
\[ a_{\ell}(E)\equiv a_{\ell}(E')\pmod{p}
\quad \text{for all primes } \ell \nmid pNN',
\] 
where $N$ and $N'$ are the conductors of $E$
and~$E'$ respectively.  This test can very quickly establish rigorously
that two curves do \emph{not} have isomorphic $p$-torsion up to
semisimplification, by finding  a single
prime~$\ell$ such that $a_{\ell}(E)\not\equiv a_{\ell}(E')\pmod{p}$.
Moreover, it is possible to prove that two curves have isomorphic $p$-torsion up to
semisimplification using this test for a finite number of
primes~$\ell$, as we explain in Step 2 below.

We divide our procedure to determine all mod~$p$ congruences between
non-isogenous curves, and their symplectic type, for a fixed
prime~$p$, into five steps.  We first outline the steps, and then
consider each in detail in the following subsections.
\begin{enumerate}[1.]
\item Partition the set of isogeny classes of elliptic curves in LMFDB
  into subsets~$S$, such that whenever two curves have mod~$p$
  representations with isomorphic semisimplifications, their isogeny
  classes belong to the same subset~$S$, but not necessarily
  conversely.
\item For each subset~$S$ prove that the curves in each isogeny class in~$S$ really
  do have isomorphic mod~$p$ representations up to
  semisimplification, if necessary further partitioning the subsets.
  Discard all ``trivial'' subsets of size~$1$.
\item Separate the remaining subsets resulting from the previous
  step into those which have irreducible mod~$p$ representations and
  the reducible ones.
\item For each irreducible subset~$S$, and each pair of isogeny
  classes in~$S$, pick curves $E$ and~$E'$, one from each class in the
  pair; determine the symplectic type of the triple~$(E,E',p)$; then
  use the isogeny criterion to partition the set of all the curves in
  all the isogeny classes in~$S$ into one or two parts such that curves
  in the same part are symplectically isomorphic while those in
  different parts are antisymplectically isomorphic.
\item For each reducible subset~$S$, determine whether, for each pair
  $E$, $E'$ chosen as in Step 4, there is an isomorphism between
  $E[p]$ and $E'[p]$ and not just between their semisimplifications,
  if necessary replacing $E'$ with the curve $p$-isogenous to it.  If
  not, this means that $E[p]$ and $E'[p]$ are not in fact isomorphic.
  Thus we further partition each reducible set $S$ into subsets of
  isogeny classes of curves whose mod~$p$ representations are actually
  isomorphic, not just up to semisimplification.  For each of these
  new subsets, if nontrivial, proceed as in Step~4.

\end{enumerate}
Next we will explain each step in further detail.  For the first three
steps, $p$ is arbitrary, and we have carried these steps out for $7\le
p\le97$.  According to Theorem~\ref{T:cong19} below, no congruences
(other than those induced by isogenies) exist for larger~$p$.  For the
last two steps, we restrict to $p=7$ which is the most interesting
case, as remarked in the Introduction.


\subsection{Sieving}
In order that $E[p]\cong E'[p]$ up to semisimplification, it is
necessary and sufficient that for all primes~$\ell$ not dividing
$pNN'$ we have $a_{\ell}(E)\equiv a_{\ell}(E')\pmod{p}$.  In this step
we may take one curve from each isogeny class, since isogenous curves
have the same traces~$a_\ell$, and have mod~$p$ representations with
isomorphic semisimplifications.

Fix an integer~$B\ge1$.  Let $\calL_B$ be the set of the $B$ smallest
primes greater than $\numprint{500000}$. All curves in the database
have good reduction at each prime in~$\calL_B$.  Assume also $B$ is
large enough that $p\notin\calL_B$.  Hence a necessary condition for
two curves $E$ and $E'$ in the database to be congruent mod~$p$ is
that $a_{\ell}(E)\equiv a_{\ell}(E')\pmod{p}$ for all~$\ell\in\calL_B$.

To each curve $E$ in the database we assign a ``hash value'' which is
a simple function of the set $\{a_{\ell}(E)\pmod{p}\mid
\ell\in\calL_B\}$.  For example we may enumerate
$\calL_B=\{\ell_0,\ell_1,\dots,\ell_{B-1}\}$ and use the integer value
$\sum_{i=0}^{B-1}\overline{a}_{\ell_i}(E)p^i$, where for $a\in\Z$,
$\overline{a}$ denotes the reduction of $a$ mod~$p$ which lies in
$\{0,1,\dots,p-1\}$.  Curves whose mod~$p$ representations are
isomorphic up to semisimplification will have the same hash, and we
may hope that clashes will be rare if $B$ is not too small.

We proceed to compute this hash value for one curve in each isogeny
class in the database, recording the curve's label in a list indexed
by the different hash values encountered.  At the end of this step we
can easily form a partition of the set of isogeny classes by taking
these lists for each hash value.  We then discard any such lists which
are singletons.  Using $B=40$, this process takes approximately 40
minutes for a single prime~$p$.  Note, however, that as most of the
computation time taken is in computing $a_{\ell}(E)$ for all
curves~$E$ (up to isogeny), it is more efficient to compute the hash
values for several primes in parallel.

{\bf Example.} After carrying out this step for $7\le p\le17$, using
$B=50$, we find: $\numprint{23735}$ nontrivial subsets for $p=7$;
$731$ for $p=11$; $177$ for $p=13$; and~$8$ for $p=17$.  There are no
nontrivial subsets for any primes~$p$ with $19\le p\le97$, so we can
immediately conclude that there are no congruences in the database
between non-isogenous curves modulo any prime in this range.  See also
Theorem~\ref{T:cong19} below.

\subsection{Proving isomorphism up to semisimplification}

For each pair of isogeny classes within one subset obtained in the
previous step, we use a criterion of Kraus--Oesterl\'e (see
\cite[Proposition~4]{KO}), based on the Sturm bound and hence on the
modularity of elliptic curves over~$\Q$, to either prove isomorphism
up to semisimplification, or reveal a ``false positive''.  The latter
would happen if two curves which are not congruent mod~$p$ have traces
of Frobenius~$a_{\ell}$ which are congruent modulo~$p$ for
all~$\ell\in\calL_B$.

{\bf Example (continued).}  For $7\le p\le17$ we find no such false
positives, so the curves within each subset do have mod~$p$
representations which are genuinely isomorphic up to
semisimplification.

\begin{remark}
  To avoid false positives, it is necessary to use a value of $B$
  which is large enough.  In our initial computations with conductor
  bound~$\numprint{400000}$ we initially used 30 primes
  above~$\numprint{400000}$. But the curves with labels
  \lmfdbec{25921}{a}{1} and \lmfdbec{78400}{gw}{1} have traces
  $a_{\ell}$ which are \emph{equal for all~$\ell\in\calL_{35}$}, that
  is, for all~$\ell$ with $400000\le \ell<400457$ (though not for
  $\ell=400457$).  These curves have CM by the order of
  discriminant~$-7$, and are quadratic twists by~$230$; both have
  $a_\ell=0$ for all $\ell\equiv3,5,6\pmod{7}$, and $230$ is a
  quadratic residue modulo all other primes in~$\calL_{35}$. In our
  first computational runs (with $N\le\numprint{400000}$), we used
  $B=30$ and discovered this pair of curves giving rise to a false
  positive for every~$p$.
\end{remark}

The sizes of the subsets of isogeny classes we find after the first
two steps are as follows: for $p=7$ the~$\numprint{23735}$ subsets
have sizes between~$2$ and~$76$; for $p=11$, $p=13$ and $p=17$ they
all have size~$2$.

\subsection{Testing reducibility}
For each set of isogeny classes of curves obtained in the previous
step, we next determine whether the curves in the set have irreducible
or reducible mod~$p$ representations.  To do this we apply a standard
test of whether an elliptic curve admits a rational $p$-isogeny.  For
the curves in the database this information is already known.

{\bf Example (continued).} For $p=7$, of the $\numprint{23735}$
nontrivial sets from Step~2, we find that $\numprint{23448}$ are
irreducible, {\it i.e.}\@ consist of curves whose mod~$7$
representations are irreducible, while $287$ are reducible.

The irreducible sets have size at most~$5$.  In detail, there are
$\numprint{21653}$ sets of size~2; $\numprint{1502}$ sets of size~3;
283 sets of size~4; and 10 sets of size~5.

The reducible sets have size up to~$80$.  In Step~5 below we will further
partition these sets after testing whether the curves are actually congruent
mod~7 (not just up to semisimplification), after which the largest subset has
only~$4$ isogeny classes.

%% Reducible {2: 96, 3: 79, 4: 32, 5: 24, 7: 12, 10: 7, 6: 6, 11: 6,
%% 8: 4, 9: 4, 19: 4, 12: 2, 15: 2, 21: 2, 33: 1, 80: 1, 17: 1, 50: 1, 22: 1, 36: 1, 38: 1}

For $p=11, 13$, and~$17$, all the nontrivial subsets are of size~$2$,
and all are irreducible.


\subsection{Distinguishing symplectic from antisymplectic: irreducible case}
After the previous step we have a collection of sets of isogeny
classes, such that for each pair of curves $E$, $E'$ taken from
isogeny classes in each set, the $G_{\Q}$-modules $E[p]$ and $E'[p]$
are isomorphic and irreducible. Moreover, from
Proposition~\ref{P:conditionS} we know that all isomorphisms $\phi : E[p]
\simeq E'[p]$ have the same symplectic type. We wish to determine
whether this type is symplectic or anti-symplectic.  We may assume
that $E$ and~$E'$ are not isogenous, as otherwise we may simply apply
the isogeny criterion.

The local criteria of \cite{FKSym} suffice to determine the symplectic
type for all the mod~$p$ congruences found in the database for $p=7$
and $p=11$ (and also for $p=13, 17$), but this does not have to be
the case as discussed in Section~\ref{S:motivation} (see
\cite[Proposition~16]{FKSym} for an example with $p=3$ where the local
methods fail).  Therefore, we will now describe a procedure, using the
modular curves~$X_E(7)$, to obtain a method that works in all cases.
We will use the modular parametrizations and explicit formulae of
Kraus--Halberstadt~\cite{Halberstadt-Kraus-XE7},
Poonen--Schaefer--Stoll~\cite{PSS}, and as extended and completed by
Fisher~\cite{Fisher}.

In~\cite{Halberstadt-Kraus-XE7}, Halberstadt and Kraus give an
explicit model for the modular curve $X_E(7)$, for any elliptic curve
$E$ defined over a field~$K$ of characteristic not equal to $2$, $3$
or~$7$. Recall that the $K$-rational points on $X_E(7)$ parametrize
pairs $(E',\phi)$ where $E'$ is an elliptic curve defined over~$K$ and
$\phi:E[7]\to E'[7]$ is a symplectic isomorphism of $G_K$-modules; we
identify two such isomorphisms~$\phi$ when one is a scalar multiple of
the other.

The model for $X_E(7)$ given in \cite{Halberstadt-Kraus-XE7} is a
plane quartic curve, a twist of the classical Klein quartic~$X(7)$,
given by an explicit ternary quartic form~$F_{a,b}(X,Y,Z)$ in
$\Z[a,b][X,Y,Z]$ where $E$ has equation $Y^2=X^3+aX+b$.  The $24$
flexes on $X_E(7)$ are the cusps, that is, they are the poles of the
rational function of degree~$168$ giving the map $j:X_E(7)\to
X(1)$.
%% The $28$ bitangents intersect $X_E(7)$ at the 56
%% points above $j=0$: these are the intersection points of $X_E(7)$ and
%% the curve of degree~$14$ defined by a covariant of~$F_{a,b}$.

The base point $P_E=[0:1:0]\in X_E(7)(K)$ corresponds to the pair
$(E,\id)$.  In \cite{Halberstadt-Kraus-XE7} one can also find explicit formulas
for the rational function $j:X_E(7)\to X(1)$ and for the elliptic curve~$E'$
associated with all 
but finitely many points $P=(x:y:z)\in
X_E(7)$. More precisely, 
explicit polynomials $c_4, c_6 \in \Z[a,b][X,Y,Z]$
of degree~$20$ and~$30$, respectively, are given and the curve $E'$ associated with (all but finitely many)~$P$ has model
\[Y^2=X^3-27c_4(P)X-54c_6(P).\]

The finitely many common zeros of $c_4$
and $c_6$ are the exceptions, which Kraus and Halberstadt treat only
incompletely.  However, in \cite{Fisher} one may find formulas for
four such pairs of polynomials~$(c_4,c_6)$, of which the first is the pair in
\cite{Halberstadt-Kraus-XE7}, and such that at each point $P\in
X_E(7)$ at least one pair $(c_4(P),c_6(P))\not=(0,0)$, thus supplying
us with a model for the associated elliptic 
curve~$E'$ at each point~$P$.

We make use of this model and formulas as follows, given curves $E$,
$E'$ with $E[7]\cong E'[7]$.  Using one curve~$E$ we write down the
model for $X_E(7)$.  Then we find all preimages (if any) of $j'=j(E')$
under the map $X_E(7)\to X(1)$.  
While over an algebraically closed
field there are $168$ distinct preimages of each $j'$, except that the
ramification points $j=0$ and $j=1728$ have $56$ and $84$ preimages,
over $\Q$, there are at most two 
by Proposition~\ref{P:twist}, except
for $j'=0$ when there may be four by Proposition~\ref{P:higherTwists}.

\nf{I am not sure the counting of the pre-images over~$\Q$ is correct or at least needs further details. Can't we have mod~$7$ projective image $C_2 \times C_2$ for curves over~$\Q$ with bad reduction at~7? Still, in that case, not all the congruences would be symplectic and so the amount of pre-images seems to still be at most 2 by part (2) of Theorem~\ref{T:quadratic}. For the case $j'=0,1728$ by Proposition 2.15 one gets 3 pre-images and for $j'=0$ we also have the quadratic twist by $-3$ and for $j'=1728$ the quartic twist by $-4$; however, not all symplectic.}

\jc{You are probably right.  I am not sure that it is worth the
  trouble to get the exact count.  It is surely the same question as
  ``Given $E/\Q$, how many twists of $E$ can be symplectically
  $7$-congruent to $E$?''.  However your sketch seems almost complete
  (taking into account that we only want symplectic congruences).
  Note also that the answer to the same question for antisymplectic
  congruences (the number of pre-images of $j'$ in $X_E^-(7)$) must be
  the same, since any two are symplectically congruent to each other.
  To make this correct we would also have make sure about all the
  reducible cases.  Perhaps not worth it.}

  \nf{I agree it is not worth it. The most we coud do is just to say there are only a few over~$\Q$ and as footnote give the counting in the irredicible case -- it is certainly not worth it entering in the reducible setting -- otherwise you can remove any attempt to give an upper bound even over~$\Qbar$ if you want} 
  
If there are no preimages of~$j'$, we conclude that the isomorphism
$E[7]\cong E'[7]$ is not symplectic.  Otherwise, for each preimage
$P\in X_E(7)(\Q)$ we compute the curve associated to~$P$, which may be
a twist of~$E'$, and test whether it is actually isomorphic to $E'$.
If this holds for one such point~$P$ in the preimage of $j(E')$, then
the isomorphism between $E[7]$ and $E'[7]$ is symplectic.

A similar method may be applied to test for antisymplectic
isomorphisms, using another twist of $X(7)$ denoted $X_E^-(7)$, first
written down explicitly in \cite{PSS}, for which Fisher provides
explicit formulae for the $j$-map and $c_4,c_6$ as above
in~\cite{Fisher}.

We note that it is not necessary to apply both the symplectic and
antisymplectic tests to a triple $(E,E',7)$ if we know already that
$E[7]\cong E'[7]$ as $G_\Q$-modules, since one will succeed if and only if the other
fails (by Proposition~\ref{P:conditionS}).  However we did apply both
tests in our computations with the curves in the database as a test of
our implementation, verifying that precisely one test passes for each
pair.  We also checked that the results obtained for each pair using
the local criteria are the same, so that we can be confident in the
correctness of the results.

These tests have only been carried out using a single curve in each
isogeny class, since we know how to distinguish symplectic from
antisymplectic isogenies.  As a last step, we consider the full isogeny classes
to obtain, for each elliptic curve~$E$ in the database, the complete sets of all curves~$E'$ (non-isogenous to~$E$) which have
symplectically and anti-symplectically isomorphic $7$-torsion modules to~$E$.

The output of this step consists of, for each of the subsets resulting
from Steps~1--3, one or two sets of curves whose union is the set of
all curves in the isogeny classes in the subset.  All curves in the
same set have symplectically isomorphic 7-torsion modules; when there
are two sets, curves in different sets have antisymplectically
isomorphic 7-torsion.




{\bf Example (continued).}  Of the $\numprint{23448}$ non-trivial sets
of isogeny classes with mutually isomorphic irreducible mod~$7$
representations, we find that in $\numprint{16285}$ cases all the
isomorphisms are symplectic, while in the remaining $\numprint{7163}$
cases antisymplectic isomorphisms occur.

Using the local criteria of \cite{FKSym} for $p=11, 13, 17$ we find:
for $p=11$, of the $731$ congruent pairs of isogeny classes, $519$ are
symplectic and $212$ are antisymplectic; for $p=13$, of the $177$
congruent pairs of isogeny classes, $105$ are symplectic and $72$ are
antisymplectic; for $p=17$, all of the $8$ congruent pairs of isogeny
classes are antisymplectic.

\begin{example}
Let $p=7$.  One of the subsets resulting from Steps 1--3 consists of
the pair of isogeny classes $\{\lmfdbec{344025}{bc}{1},
\lmfdbec{344025}{bd}{1}\}$.  Our test shows that
$\lmfdbec{344025}{bc}{1}$ and $\lmfdbec{344025}{bd}{1}$ are
symplectically isomorphic.  The isogeny class
$\lmfdbeciso{344025}{bc}$ contains two $2$-isogenous curves, while
class $\lmfdbeciso{344025}{bd}$ contains only one curve.  Since $2$ is
a quadratic residue mod~7, all three curves have symplectically
isomorphic 7-torsion, and hence Step~4 returns a single set
\[\{\lmfdbec{344025}{bc}{1}, \lmfdbec{344025}{bc}{2}, \lmfdbec{344025}{bd}{1}\}.\]
Another subset resulting from Steps 1--3 is
$\{\lmfdbec{100800}{gw}{1}, \lmfdbec{100800}{hc}{1}\}$.  The same
procedure results in the output of two sets of curves
\[
\{\lmfdbec{100800}{gw}{1}\}, \qquad \{\lmfdbec{100800}{hc}{1},
\lmfdbec{100800}{hc}{2}\},
\]
since our tests show that $\lmfdbec{100800}{gw}{1}$ and
$\lmfdbec{100800}{hc}{1}$ are antisymplectically isomorphic, and the
last two curves are $2$-isogenous.
\end{example}

\begin{example}
Consider the set of six elliptic curves
\[\{\lmfdbec{9225}{a}{1}, \lmfdbec{9225}{e}{1}, \lmfdbec{225}{a}{1},
\lmfdbec{225}{a}{2}, \lmfdbec{11025}{c}{1}, \lmfdbec{11025}{c}{2}\}\]
which form four
complete isogeny classes.  All have isomorphic mod~7 representations
with image the normaliser of a split Cartan subgroup.  The last four
curves all have $j$-invariant~$0$ and CM by $-3$.  The first two are 
$-3$ quadratic twists of each other.

The general methods of Step~4 of this section split this set into two
subsets:
\[
  \{\lmfdbec{9225}{a}{1}, \lmfdbec{225}{a}{1},
  \lmfdbec{11025}{c}{1}\},\qquad \{\lmfdbec{9225}{e}{1},
  \lmfdbec{225}{a}{2}, \lmfdbec{11025}{c}{2}\}
\]
Curves $\lmfdbec{9225}{a}{1}$ and $\lmfdbec{9225}{e}{1}$ give a non-CM
example of Proposition~\ref{P:twist}.  Curves  $\lmfdbec{225}{a}{1}$ and
$\lmfdbec{11025}{c}{1}$ are sextic (but  not quadratic or cubic) twists
and illustrate Proposition~\ref{P:higherTwists}.
\end{example}

\subsection{Auxiliary results for the reducible case}
Compared to the irreducible case, establishing reducible congruences
requires extra work because when working with the semisimplifications
$E[7]^{ss}$ and $E'[7]^{ss}$ important information is lost.  The
objective of this section is to establish Theorem~\ref{T:reducible}
which will allow us to rigorously prove congruences in the reducible
case.


Let $B \subset \GL_2(\F_p)$ be the standard Borel subgroup, i.e. the
upper triangular matrices. Let $H \subset B$ be a subgroup of order
divisible by~$p$.  We can write~$H = D\cdot U$ where $D \subset B$ is
a subgroup of diagonal matrices and $U$ is cyclic generated by
$\left(\begin{smallmatrix} 1 & 1 \\ 0 & 1
                            \end{smallmatrix} \right)$.   
Moreover, $U$ is a normal subgroup of~$H$ 
and we write $\pi : H \to H/U \simeq D$ for the quotient map.

\begin{proposition} \label{P:inner}
Let $H = D \cdot U \subset B$ and $\pi$ be as above. 
Let $\phi$ be an automorphism of~$H$. Assume that  
$\pi(x) = \pi(\phi(x))$ for all $x \in H$. 

Then $\phi$ is given by conjugation in $B$, i.e. there is $A \in B$ such that $\phi(x) = AxA^{-1}$. 
\end{proposition}
\begin{proof}
Let $x \in H$ and write it as $x = du$ with $d \in D, u \in U$.
Note that $U$ is the unique normal subgroup with order~$p$, so 
$\phi(U) = U$ and $\phi(D)=D$ for all $\phi \in \Aut H$.
By hypothesis, we have 
\[
 \pi(x) = \pi(\phi(x)) = \pi(\phi(d))\pi(\phi(u)) \iff dU = \phi(d)U
 \iff d\phi(d)^{-1} \in U.
\]
Since $d, \phi(d) \in D$ we have $d\phi(d)^{-1} \in D \cap U = \{ I_2\}$ therefore $d\phi(d)^{-1} = I_2$, where $I_2$ is the identity in $\GL_2(\F_p)$.
Thus $d = \phi(d)$ and we conclude that any $\phi$ 
as in the statement is the same as an automorphism of~$U$ (extended to~$H$ by $\phi(d)=d$ for all $d\in D$). 

Write $N_B(U)$  for the normaliser of $U$ in $B$ and $C_B(U)$ for its centralizer. 
We have $N_B(U) = B$ 
and $C_B(U)$ are the matrices of the form $\left(\begin{smallmatrix}
                            \lambda & b \\
                            0 & \lambda
                            \end{smallmatrix} \right)$
with $\lambda \neq 0$. Thus $\# N_B(U)/C_B(U) = p-1$. 
Since  we also have 
\[
 N_B(U)/C_B(U) \hookrightarrow \Aut U \simeq \F_p^*
\]
it follows that $\Aut U \simeq N_B(U)/C_B(U)$, as desired.
\end{proof}

\begin{proposition} \label{P:fieldF}
Let $p > 2$ be a prime. Let $E/K$ be an elliptic curve such that 
$\rhobar_{E,p}$ is reducible. Assume there is an element of order~$p$ 
in the image of~$\rhobar_{E,p}$. 

Then, there is a field $F \supset K$ such that $[F : K] = p$ and $E$ acquires a 
second isogeny over~$F$.
\end{proposition}
\begin{proof} We can choose a basis of $E[p]$ where
\[
\rhobar_{E,p} =  \begin{pmatrix}
                            \chi& h \\
                            0 & \chi'
                            \end{pmatrix}.
\]

Let $H$ be the set of elements $\sigma \in  G_K$ such 
that $h(\sigma) = 0$. Since $\rhobar_{E,p}$ is a homomorphism it follows 
that $H$ is a subgroup of $G_K$. 
We let $F \subset K(E[p])$ to be the field fixed by $H$.
Since there is an element of order~$p$ in the image of~$\rhobar_{E,p}$ and 
$\left(\begin{smallmatrix}
                            \chi & 0 \\
                            0 & \chi'
                            \end{smallmatrix} \right)$
has order coprime to~$p$, 
it follows that $[F : K] =p$.
\end{proof}


\begin{theorem} \label{T:reducible}
Let $p > 2$ be a prime. Let $E_1, E_2$ be elliptic curves 
over~$K$ such that 
\begin{itemize}
 \item[(i)] $\rhobar_{E_1,p}^{ss} \simeq \rhobar_{E_2,p}^{ss} \simeq \chi \oplus \chi'$,  where $\chi, \chi' : G_K \to \F_p^*$ are characters;
 \item[(ii)] both $\rhobar_{E_1,p}$ and $\rhobar_{E_2,p}$ have an element of
 order~$p$ in their image.
\end{itemize}
For $i=1,2$, let $F_i/K$ be a degree~$p$ extension where $E_i$
acquires a second isogeny, as given by Proposition~\ref{P:fieldF}.

After replacing $E_2$ by a $p$-isogenous curve if necessary, we have
$\rhobar_{E_1,p} \simeq \rhobar_{E_2,p}$ if and only if $F_1 \simeq
F_2$.
\end{theorem}
\begin{proof} Clearly, 
if $\rhobar_{E_1,p} \simeq \rhobar_{E_2,p}$ 
then $F_1 \simeq F_2$. We now prove the opposite direction.

From (i) it follows that $\rhobar_{E_i,p}$ is reducible and that, after replacing $E_2$ by a $p$-isogenous curve if necessary (to swap 
$\chi$ with $\chi'$), 
we have 
\[
\rhobar_{E_i,p} =  \begin{pmatrix}
                            \chi & h_i \\
                            0 & \chi'
                            \end{pmatrix} \quad \text{ with } \quad  h_i : G_K \to \F_p.  
\]
Let $L$ be the field cut out 
by $\chi \oplus \chi'$. 
It follows from (ii) that $h_i|_{G_L} \neq 0$, and
hence the matrix $\left(\begin{smallmatrix}
                            1 & 1 \\
                            0 & 1
                            \end{smallmatrix} \right)$  
is in the image of $\rhobar_{E_i,p}$ for $i=1,2$.
                            
Write $K_i = K(E_i[p])$. 
We have $[K_i : K] = [K_i : L][L : K] = p [L : K]$. 
Since the degree $[L : K]$ divides $(p-1)^2$ it is coprime 
to $p = [F_i : K]$ therefore we have $K_i = L F_i$.

Suppose $F_1 \simeq F_2$. Since $K_1$ is Galois, we have $F_2 \subset K_1$ and therefore $K_p := K_1 = K_2$ is the field cut out by both
$\rhobar_{E_1,p}$ and $\rhobar_{E_2,p}$, i.e. these representations have the same kernel.

Write $G = \Gal(K_p / K)$. From now on we think of $\rhobar_{E_i,p}$ as an injective representation of~$G$. Note that the images of $\rhobar_{E_1,p}$ and $\rhobar_{E_2,p}$
is the same subgroup~$H$ of the Borel.

All the elements in $H$ are of the form $\rhobar_{E_2,p}(\sigma)$ for $\sigma \in G$, so we can consider the map $\phi = \rhobar_{E_1,p} \circ \rhobar_{E_2,p}^{-1} : H \to H$. It is an automorphism of~$H = D\cdot U$ satisfying the hypothesis of Proposition~\ref{P:inner}, where $D$ are 
the matrices $\left(\begin{smallmatrix}
                            \chi & 0 \\
                            0 & \chi'
                            \end{smallmatrix} \right)$.  
Then, $\phi$ is given by conjugation, that is
\[
 \phi(\rhobar_{E_2,p}(\sigma)) = A \rhobar_{E_2,p}(\sigma) A^{-1}.
\]
Since we also have
\[ 
\phi(\rhobar_{E_2,p}(\sigma)) 
=  \rhobar_{E_1,p} \circ \rhobar_{E_2,p}^{-1}(\rhobar_{E_2,p}(\sigma)) = \rhobar_{E_1,p}(\sigma)
\]
we conclude that $\rhobar_{E_1,p}(\sigma) = A \rhobar_{E_2,p}(\sigma) A^{-1}$, as desired.
\end{proof}



\subsection{Distinguishing symplectic from antisymplectic: reducible
  case}

From Steps 1--3 we have (for certain pairs~$(E,E')$ established that
$E[7]^{\sss} \simeq E'[7]^{\sss}$ but this is insufficient to conclude
$E[7] \simeq E'[7]$ when these are reducible $G_\Q$-modules.  To
achieve this we will apply Theorem~\ref{T:reducible} and its proof.

Recall that $E[7]$ is reducible if and only if $E$ admits a rational
$7$-isogeny.  Over $\Q$ there is only ever at most one $7$-isogeny,
since otherwise the image of the mod~$7$
representation~$\rhobar_{E,7}$ attached to~$E$ is contained in a split
Cartan subgroup of $\GL(2,\F_7)$, and this cannot occur over~$\Q$
(see~\cite[Theorem~1.1]{GL}).  Furthermore, it is well known that the
size of the $\Q$-isogeny class of~$E$ is either $2$, consisting of two
$7$-isogenous curves, or $4$, consisting of two pairs of $7$-isogenous
curves linked by $2$-{} or $3$-isogenies (but not both). Examples of
these are furnished by the isogeny classes \lmfdbeciso{26}{b},
\lmfdbeciso{49}{a}, and \lmfdbeciso{162}{b} respectively.

Fix an elliptic curve $E$ with $E[7]$ reducible. 
The image
of~$\rhobar_{E,7}$ has the form
\[
  \begin{pmatrix}\chi_1&*\\0&\chi_2  \end{pmatrix},
\]
where~$\chi_1, \; \chi_2 : G_{\Q}\to\F_7^*$ are characters and $*$
(the upper right entry) is non-zero by the previous
discussion. Moreover, the product $\chi_1\chi_2$ is the cyclotomic
character, so in particular $\chi_1\not=\chi_2$. This last observation
is valid over any field not containing $\sqrt{-7}$, so that the
determinant is not always a square.

Now let $E'$ be a second curve such that $E[7]^{\sss}\cong
E'[7]^{\sss}$. 
The image of $\rhobar_{E',7}$ has the form
\[
  \begin{pmatrix}\chi_1'&*'\\0&\chi_2'  \end{pmatrix},
  \]
where $\{\chi_1,\chi_2\}=\{\chi_1',\chi_2'\}$ and $*' \neq 0$ for the
same reason as before.  In particular, there is an element of
order~$7$ in the images of both $\rhobar_{E,7}$ and $\rhobar_{E',7}$.
The next step in applying Theorem~\ref{T:reducible} is to decide if we
need to replace $E'$ with its $7$-isogenous curve to obtain
$\chi_1=\chi_1'$ and $\chi_2=\chi_2'$. For this we determine the
``isogeny characters'' characters $\chi_1$ and $\chi_1'$: the kernel
of $\chi_1$ (respectively $\chi_1'$) cuts out the cyclic extension
of~$\Q$ of degree dividing~$6$ generated by the coordinates of a point
in the kernel of the unique $7$-isogeny from~$E$ (respectively~$E'$).
In this way we can determine whether $\chi_1=\chi_1'$ and
$\chi_2=\chi_2'$ or $\chi_1=\chi_2'$ and $\chi_2=\chi_1'$.  In the
second case, we replace $E'$ with its $7$-isogenous curve, which has
the effect of interchanging $\chi_1'$ and~$\chi_2'$ (as well as
changing $*'$).  Now the image of $\rhobar_{E',7}$ has the form
\[
\begin{pmatrix}\chi_1&*'\\0&\chi_2  \end{pmatrix},
\]
with the same characters, in the same order, as for
$\rhobar_{E,7}$. From Theorem~\ref{T:reducible} we have that
$E[7]\cong E'[7]$ if and only if $F_1 \simeq F_2$, where $F_i$ are the
fields in the statement of Theorem~\ref{T:reducible}.

%{\bf Although the maps $*,*':G_{\Q}\to\F_7$ are not homomorphisms, it is
%easy to check that they are both surjective and that the subsets of
%$G_{\Q}$ which map to~$0$ under each (which by abuse of language we
%will call the \emph{kernels} of~$*$ and~$*'$) are subgroups, of
%index~$7$ and cutting out cyclic extensions} of~$\Q$ of degree~$7$.

The field $F_1$ is the common field of definition of all of the other
seven $7$-isogenies from~$E$ (see also Proposition~\ref{P:fieldF}).
The map from $X_0(7)$ to the $j$-line is given by the classical
rational function (see Fricke)
\[
   j = \frac{(t^{2} + 13t + 49) \cdot (t^{2} + 5t + 1)^{3}}{t},
\]
where $t$ is a choice of Hauptmodul for the genus~$0$ curve
$X_0(7)$. Hence the roots of the degree~$8$ polynomial~$(t^{2} + 13t +
49) \cdot (t^{2} + 5t + 1)^{3} -t\cdot j(E)$ determine the fields of
definition of the eight $7$-isogenies from~$E$. In our setting, it has
a single rational root (giving the unique $7$-isogeny from~$E$ defined
over~$\Q$) and an irreducible factor of degree~$7$, which
defines~$F_1$ as an extension of~$\Q$. Similarly, starting from $E'$
we determine $F_2$; finally, we check whether $F_1$ and $F_2$ are
isomorphic.

%the desired extension of the base
%field~$\Q$, which in turn  uniquely identifies the $*$ component of the
%representation, by Theorem~\ref{T:reducible}.

In this way, for each pair $(E,E')$ whose 
mod~$7$ representations
are reducible with isomorphic semisimplifications, we may determine
whether or not we do in fact have an isomorphism $E[7]\cong E'[7]$,
possibly after replacing $E'$ by its unique $7$-isogenous curve.

In most of the reducible cases encountered in the database, we found
that there was no isomorphism between the $7$-torsion modules
themselves.  In those cases where there is such an isomorphism, we can
determine whether or not it is symplectic using the same methods as in
the irreducible case, noting that the test using the parametrizing
curves $X_E(7)$ and $X_E^-(7)$ do not at any point rely on the
irreducibility or otherwise of the representations.  Finally, if there
are also $2$-{} or $3$-isogenies present we can include these
appropriately, since the former induce symplectic and the latter
antisymplectic congruences.

{\bf Example (continued).} For $p=7$, after Steps 1--3, there
are~$287$ reducible sets of isogeny classes with isomorphic
semisimplification, of size up to~$80$.  Step~5 refines these into
smaller subsets which have actually isomorphic $7$-torsion modules, of
which $384$ are nontrivial.  Among these there are $38$ classes also
admitting a $2$-isogeny and $22$ classes admitting a $3$-isogeny,
making a total of $849$ curves, partitioned into mutually
$7$-congruent subsets of size $2$, $3$ or~$4$: there are $263$ sets of
size~$2$, of which the congruence is symplectic in $142$ cases and
anti-symplectic in $121$ cases; $101$ of size~$3$, of which all the
congruences are symplectic in $56$ cases, and in the remaining $45$
cases, only one congruence is symplectic; and~$20$ of size~$4$, in
which all congruences are symplectic in $8$ cases, there are two pairs
of symplectically congruent curves (with congruences between curves in
different pairs being anti-symplectic) in $2$ cases, and in $10$ cases
there are $3$ curves mutually symplectically congruent and
anti-symplectically congruent to the fourth curve.

For $p\ge11$ there are no reducible cases to consider.

\subsection{Twists}
If there is a mod~$p$ congruence between two elliptic curves~$E_1$
and~$E_2$, then for any $d\in\Q^*$ there will also be a congruence
(with the same symplectic type) between their quadratic twists
$E_1^d$ and~$E_2^d$ (see \cite[Lemma~11]{FKSym}).
Nevertheless, it is hard to say precisely how many congruences there
in the database ``up to twist'', since twisting changes conductor (in
general), so we may have a set of mutually $7$-congruent elliptic
curves in the database, but with one or more of their twists not in
the database, so the twisted set in our data will be smaller.

Instead, to have a measure of how many congruences we have found up to
twist, we simply report on how many distinct $j$-invariants we found,
excluding as before curves which are only congruent to isogenous
curves.  For $p=7$ there are $\numprint{11761}$ distinct
$j$-invariants of curves with irreducible mod~$7$ representations
which are congruent to at least one non-isogenous curve, and $154$
distinct $j$-invariants in the reducible case.
% 154 becomes 382 if we include congruences up to semisimplification
% only.

For $p=11$ there are $212$ distinct $j$-invariants and for $p=13$
there are $39$.  For $p=17$, all $17$-congruent isogeny classes
consist of single curves, the eight pairs are quadratic twists, and
the $j$-invariants of the curves in each pair are
$48412981936758748562855/77853743274432041397$ and $-46585/243$.  One
such pair of $17$-congruent curves consists of $\lmfdbec{47775}{b}{1}$
and~$\lmfdbec{3675}{b}{1}$.

\section{Evidence for the Frey-Mazur conjecture in the database}
\label{S:Frey-Mazur}

\begin{theorem}
 \label{T:cong19}
 Let $p \geq 19$ be a prime. Let $E/\Q$ and~$E'/\Q$ be elliptic curves
 with conductors at most~$\numprint{500000}$.  Suppose that $E[p]
 \simeq E'[p]$ as $G_\Q$-modules. Then $E$ and $E'$ are
 $\Q$-isogenous.
 \end{theorem}
\begin{proof} Let~$p \geq 5$ be a prime. Let $N_E$ and $\Delta_E$ 
denote the conductor and the minimal discriminant of $E$, respectively. Write also $\tilde{N}_E$ to denote~$N_E$ away from~$p$ and let $N_p$ be the Serre level (i.e. the Artin conductor away from~$p$) of~$\rhobar_{E,p}$. 
We have $N_p \mid \tilde{N}_E$.

Recall that the conductor of an elliptic curve at primes~$p \geq 5$ divides~$p^2$. Moreover, from Kraus~\cite[p. 30]{KrausThesis}
it follows that, for each $\ell \neq p$, if 
$\vv_{\ell}(N_p) \neq \vv_{\ell}(N_E) = \vv_{\ell}(\tilde{N}_E)$ then
$\vv_{\ell}(N_E) = 1$ and $p \mid \vv_{\ell}(\Delta_E)$.
Therefore, we can find primes $q_i \nmid pN_p$ such that 
\begin{equation}\label{E:condE}
  N_E = p^s \cdot N_p \cdot q_0 \cdot \ldots \cdot q_n, 
 \qquad p \mid \vv_{q_i}(\Delta_E), \qquad 0 \leq s \leq 2
\end{equation}
where the number of~$q_i$ occurring is $\geq 1$ if and only if 
$\tilde{N}_E \neq N_p$. 

Now let $E'/\Q$ be another elliptic curve satisfying $E[p] \simeq E'[p]$ as $G_\Q$-modules. Write $N_{E'}$, $\tilde{N}_{E'}$, $\Delta_{E'}$, $N'_p$ and $\rhobar_{E',p}$ to denote analogous quantities attached to~$E'$. We have $N'_p \mid \tilde{N}_{E'}$.

By assumption, we have $\rhobar_{E',p} \simeq \rhobar_{E,p}$ so these representations have the same Serre level, i.e. $N_p = N_p'$ and (similarly as for~$E$) we can find primes~$q_i' \nmid pN'_p$ such that~$N_{E'}$ factors as
\begin{equation}\label{E:condE'}
 N_{E'} = p^{s'} \cdot N_p \cdot q'_0 \cdot \ldots \cdot q'_m, 
 \qquad p \mid \vv_{q'_i}(\Delta_E'),
 \qquad 0 \leq s' \leq 2.
\end{equation}
The representations $\rhobar_{E,p}$ and $\rhobar_{E',p}$ also have the same Serre weights $k$ and $k'$, respectively. Note that for $s=0$ ($E$ has good reduction at~$p$) we have $k=2$ and for $s=1$ ($E$ has multiplicative reduction at~$p$) we have $k=2$ if $p \mid \vv_p(\Delta_E)$ or $k=p+1$ otherwise (see for example \cite[p. 3]{KrausThesis}); moreover, for $s=2$ it follows from \cite[Th\'eor\`eme 1]{KrausThesis} that $k \not\in \{2, p+1\}$ 
for $p \geq 19$. Similar conclusions apply to $E'$, $s'$ and $k'$. 
Therefore, we have 2 cases: (i) if $s = 2$ or $s=1$ and $p \nmid \vv_{p}(\Delta_E)$ then $s'=s$; (ii) if $s=0$ or $s=1$ and $p \mid \vv_{p}(\Delta_E)$ then $s' \in \{0,1 \}$.

Suppose $E'$ is a non-isogenous curve with the same conductor. Taking differences of traces of Frobenius at different primes shows that 
there are no congruence between any two of them for $p \geq 19$, otherwise $p$ needs to divide the differences (see (1) below). 
Thus $N_E \neq N_{E'}$.

Suppose $\tilde{N}_E = \tilde{N}_{E'}$, so that the only difference in the conductors is at~$p$. From the possibilities above for the Serre weights, after interchanging $E$ and $E'$ if needed, 
we can assume $s=1$ and $s'=0$ and we also know that $p \mid \vv_p(\Delta_E)$. On the other hand, if $\tilde{N}_E \neq \tilde{N}_{E'}$ then, after interchanging $E$ and $E'$ if needed, we have $N_p \neq \tilde{N}_E$ and so there is at least one prime~$q_i \neq p$ appearing in the factorization~\eqref{E:condE}, which in particular satisfies $p \mid \vv_{q_i}(\Delta_E)$.

Let $\calM_E$ be the set of pairs $(q,p)$ where $q$ is a multiplicative prime of~$E$ and
$p \geq 19$ is a prime satisfying $p \mid \vv_{q}(\Delta_E)$.
Note that we can have $q=p$. Let $\calM_{E'}$ be the analogous set for~$E'$. From the previous paragraph we conclude that 
$p$ has to occurs in the second entry of one of the pairs~$(q,p)$ in~$\calM_E$ or $\calM_{E'}$.

To complete the proof, we carried out the following computations on
the LMFDB database of all elliptic curves defined over~$\Q$ and
conductor at most~$\numprint{500000}$:
\begin{enumerate}
\item For each $N\le \numprint{500000}$ and each pair of non-isogenous
  curves~$E_1,E_2$ of conductor~$N$ (if there are at least two such
  isogeny classes), we computed $\gcd_{\ell\le B,
    \ell\nmid N}(a_{\ell}(E_1)-a_{\ell}(E_2))$ for increasing~$B$
  until the value of the $\gcd$ was~${}\le17$.  The success of this
  computation shows that there are no congruences mod~$p$ between
  non-isogenous curves of the same conductor for $p\ge19$.
\item For one curve~$E$ in each isogeny class we computed the set
  $\calM_E$ from the conductor and minimal discriminant.  We found that
  the largest prime~$p$ occurring in any~$\calM_E$ was~$97$: in fact,
  all~$p$ with $19\le p\le97$ occur except for~$p=89$.  Hence any
  mod~$p$ congruence between non-isogenous curves in the database must
  have~$p\le97$.  In view of the computations of
  Section~\ref{S:statistics}, there are no such congruences for $19\le
  p\le97$.

  Note that the set~$\calM_E$ is unchanged if we replace $E$ by a curve
  isogenous to it, provided that the isogeny has degree divisible only
  by primes less than~$19$.  But the only curves defined over~$\Q$ with
  isogenies of prime degree~$p\ge19$ are the CM curves for
  $p=19,43,67,163$, which have no multiplicative primes, and the pairs
  of $37$-isogenous curves, which have the same property (the smallest
  conductor being $1225=5^2\cdot7^2$).  Hence in this step it suffices
  to consider just one curve in each isogeny class.
\end{enumerate}
\end{proof}

%% Finally, given~$E$ in the database, we compute $\calM_E$ (which is
%% a finite set) and for each~$p$ occuring in a pair of $\calM_E$ we
%% compute the set of conductors~$\calL_{E,p}$ satisfying the
%% factorisation~\eqref{E:condE'} and still in the database (i.e. up
%% to 500000). For each conductor $N_{E'} \in \calL_{E,p}$ we verify
%% there is no elliptic curve~$E'$ of conductor $N_{E'}$ congruent
%% to~$E$ mod~$p$.

%% We end by remarking that a congruence between $E$ and $E'$ can
%% exist modulo a prime~$p$ not occuring in $\calM_E$, but the
%% arguments above show that in such case $p$ occurs in $\calM_{E'}$,
%% therefore we will detect this congruence at a laters stage as we
%% run over all the curves in the database.


 
\begin{thebibliography}{999}

%% \bibitem{BDMTV}
%% Jennifer~S. Balakrishnan, Netan Dogra, J.~Steffen M\"uller, Jan Tuitman, and
%%   Jan Vonk.
%% \newblock Explicit {C}habauty-{K}im for the split Cartan modular curve of level 13, Annals of Math. (to appear).

\bibitem{BDMTV-S4}
Jennifer~S. Balakrishnan, Netan Dogra, J.~Steffen M\"uller, Jan Tuitman, and
  Jan Vonk.
\newblock Personal communication.

\bibitem{BarinderCrem} B.\ Banwait and J.\ Cremona, 
{\em Tetrahedral Elliptic Curves and the local-to-global principle for Isogenies}
Algebra \& Number Theory {\bf 8} (2014), no. 5, 1201--1229.

\bibitem{Billerey17} N.~Billerey,
  {\em On some remarkable congruences between two elliptic curves},
  \url{https://arxiv.org/abs/1605.09205}.

%% \bibitem{BPR2013}
%% Yuri Bilu, Pierre Parent, and Marusia Rebolledo.
%% \newblock Rational points on {$X^+_0(p^r)$}.
%% \newblock {\em Ann. Inst. Fourier (Grenoble)}, 63(3):957--984, 2013.

\bibitem{AMEC}
J.~E.~Cremona.
\newblock {\em Algorithms for modular elliptic curves}.
\newblock Cambridge University Press, Cambridge, second edition, 1997.

\bibitem{DahmenPhD} S.\ Dahmen,
 {\em Classical and modular methods applied to Diophantine equations}, 
 PhD thesis, Utrecht University, 2008. Available at \\
 \url{https://dspace.library.uu.nl/handle/1874/29640}

\bibitem{Fisher} T.\ Fisher,
{\em On families of $7$ and $11$-congruent elliptic curves}, 
LMS J.\ Comput.\ Math.\ {\bf 17} (2014), no. 1, 536--564.

\bibitem{FisherList} T.\ Fisher,
{\em A table of $11$-congruent elliptic curves over the rationals}, \\
\url{https://www.dpmms.cam.ac.uk/~taf1000/papers/congr-11}

\bibitem{FKSym} N.\ Freitas and A.\ Kraus,
{\em On the symplectic type of isomorphisms of the $p$-torsion of elliptic curves}, Preprint

\bibitem{GL}
Enrique Gonz\'{a}lez-Jim\'{e}nez and \'{A}lvaro Lozano-Robledo,
\newblock Elliptic curves with abelian division fields.
\newblock {\em Math. Z.}, 283(3-4):835--859, 2016.

\bibitem{Halberstadt-11nonsplit}
Emmanuel Halberstadt, \emph{Sur la courbe modulaire {$X_{\text{nd\'ep}}(11)$}}, Experimental Math.\ \textbf{7} (1998), no. 2, 163--174.

\bibitem{Halberstadt-Kraus-YE7}
Emmanuel Halberstadt and Alain Kraus, \emph{On the modular curves {$Y_E(7)$}},
  Math. Comp. \textbf{69} (2000), no.~231, 1193--1206. \MR{1651758}

\bibitem{Halberstadt-Kraus-XE7}
\bysame, \emph{Sur la courbe modulaire {$X_E(7)$}}, Experiment. Math.
  {\bf 12} (2003), no.~1, 27--40. \MR{2002672}
  
\bibitem{Kraus1990} A.\ Kraus,
{\em Sur le d\'efaut de semi-stabilit\'e des courbes elliptiques \`a r\'eduction additive},
Manuscripta Math.\ {\bf 69} (1990), no. 4, 353--385.
  
\bibitem{KrausThesis}
Alain Kraus,
\newblock D{\'e}termination du poids et du conducteur associ{\'e}s aux repr{\'e}sentations des points de p-torsion d'une courbe elliptique,
\newblock Dissertationes Math. (Rozprawy Mat.) {\bf 364}, 1997.

\bibitem{KO}
A.~Kraus and J.~Oesterl\'{e}.
\newblock Sur une question de {B}. {M}azur.
\newblock {\em Math. Ann.}, 293(2):259--275, 1992.

\bibitem{LangModForms}
Serge Lang.
\newblock {\em Introduction to Modular Forms}.
\newblock Springer-Verlag, 1976.

\bibitem{lmfdb} The {LMFDB Collaboration},
{\em The L-functions and Modular Forms Database}, \\
\url{http://www.lmfdb.org}, 2013.

\bibitem{magma}
Wieb Bosma, John Cannon, and Catherine Playoust.
\newblock The {M}agma algebra system. {I}. {T}he user language.
\newblock {\em J. Symbolic Comput.}, 24(3-4):235--265, 1997.
\newblock Computational algebra and number theory (London, 1993).

\bibitem{PSS}
Bjorn Poonen, Edward~F. Schaefer, and Michael Stoll.
\newblock Twists of {$X(7)$} and primitive solutions to {$x^2+y^3=z^7$}.
\newblock {\em Duke Math. J.}, 137(1):103--158, 2007.


\bibitem{Rubin-Silverberg}
K.~Rubin and A.~Silverberg.
\newblock Families of elliptic curves with constant mod {$p$} representations.
\newblock In {\em Elliptic curves, modular forms, \& {F}ermat's last theorem
  ({H}ong {K}ong, 1993)}, Ser. Number Theory, I, pages 148--161. Int. Press,
  Cambridge, MA, 1995.

\bibitem{sage}
W.\thinspace{}A. Stein et~al.
\newblock {\em {S}age {M}athematics {S}oftware ({V}ersion 8.7)}.
\newblock The Sage Development Team, 2019.
\newblock {\tt http://www.sagemath.org}.

\bibitem{SilvermanI} J.\ H. Silverman,
{\em The arithmetic of elliptic curves},
Second Edition, Graduate Texts in Mathematics {\bf 106}, Springer-Verlag, Dordrecht, 2009.

\bibitem{SilvermanII} J.\ H. Silverman,
{\em Advanced topics in the arithmetic of elliptic curves},
Graduate Texts in Mathematics {\bf 151}, Springer-Verlag, New York, 1994.

%% \bibitem{Sutherland}
%% Andrew V. Sutherland.
%% \newblock Computing images of Galois representations attached to elliptic curves.
%% \newblock {\em Forum of Mathematics}, Sigma {\bf 4} (2016), e4, 79 pp.


\end{thebibliography}



\end{document}
